import{_getProvider,getApp,_removeServiceInstance,SDK_VERSION,_registerComponent,registerVersion}from"./firebase-app.js";var extendStatics$1=function(t,e){return(extendStatics$1=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&(t[n]=e[n])})(t,e)};function __extends$1(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Class extends value "+String(e)+" is not a constructor or null");function n(){this.constructor=t}extendStatics$1(t,e),t.prototype=null===e?Object.create(e):(n.prototype=e.prototype,new n)}var __assign=function(){return(__assign=Object.assign||function(t){for(var e,n=1,r=arguments.length;n<r;n++)for(var s in e=arguments[n])Object.prototype.hasOwnProperty.call(e,s)&&(t[s]=e[s]);return t}).apply(this,arguments)};function __spreadArray(t,e){for(var n=0,r=e.length,s=t.length;n<r;n++,s++)t[s]=e[n];return t}var stringToByteArray$1=function(t){for(var e=[],n=0,r=0;r<t.length;r++){var s=t.charCodeAt(r);s<128?e[n++]=s:s<2048?(e[n++]=s>>6|192,e[n++]=63&s|128):55296==(64512&s)&&r+1<t.length&&56320==(64512&t.charCodeAt(r+1))?(s=65536+((1023&s)<<10)+(1023&t.charCodeAt(++r)),e[n++]=s>>18|240,e[n++]=s>>12&63|128,e[n++]=s>>6&63|128,e[n++]=63&s|128):(e[n++]=s>>12|224,e[n++]=s>>6&63|128,e[n++]=63&s|128)}return e},byteArrayToString=function(t){for(var e=[],n=0,r=0;n<t.length;){var s=t[n++];if(s<128)e[r++]=String.fromCharCode(s);else if(s>191&&s<224){var i=t[n++];e[r++]=String.fromCharCode((31&s)<<6|63&i)}else if(s>239&&s<365){var o=((7&s)<<18|(63&(i=t[n++]))<<12|(63&(a=t[n++]))<<6|63&t[n++])-65536;e[r++]=String.fromCharCode(55296+(o>>10)),e[r++]=String.fromCharCode(56320+(1023&o))}else{i=t[n++];var a=t[n++];e[r++]=String.fromCharCode((15&s)<<12|(63&i)<<6|63&a)}}return e.join("")},base64={byteToCharMap_:null,charToByteMap_:null,byteToCharMapWebSafe_:null,charToByteMapWebSafe_:null,ENCODED_VALS_BASE:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789",get ENCODED_VALS(){return this.ENCODED_VALS_BASE+"+/="},get ENCODED_VALS_WEBSAFE(){return this.ENCODED_VALS_BASE+"-_."},HAS_NATIVE_SUPPORT:"function"==typeof atob,encodeByteArray:function(t,e){if(!Array.isArray(t))throw Error("encodeByteArray takes an array as a parameter");this.init_();for(var n=e?this.byteToCharMapWebSafe_:this.byteToCharMap_,r=[],s=0;s<t.length;s+=3){var i=t[s],o=s+1<t.length,a=o?t[s+1]:0,c=s+2<t.length,u=c?t[s+2]:0,h=i>>2,l=(3&i)<<4|a>>4,d=(15&a)<<2|u>>6,f=63&u;c||(f=64,o||(d=64)),r.push(n[h],n[l],n[d],n[f])}return r.join("")},encodeString:function(t,e){return this.HAS_NATIVE_SUPPORT&&!e?btoa(t):this.encodeByteArray(stringToByteArray$1(t),e)},decodeString:function(t,e){return this.HAS_NATIVE_SUPPORT&&!e?atob(t):byteArrayToString(this.decodeStringToByteArray(t,e))},decodeStringToByteArray:function(t,e){this.init_();for(var n=e?this.charToByteMapWebSafe_:this.charToByteMap_,r=[],s=0;s<t.length;){var i=n[t.charAt(s++)],o=s<t.length?n[t.charAt(s)]:0,a=++s<t.length?n[t.charAt(s)]:64,c=++s<t.length?n[t.charAt(s)]:64;if(++s,null==i||null==o||null==a||null==c)throw Error();var u=i<<2|o>>4;if(r.push(u),64!==a){var h=o<<4&240|a>>2;if(r.push(h),64!==c){var l=a<<6&192|c;r.push(l)}}}return r},init_:function(){if(!this.byteToCharMap_){this.byteToCharMap_={},this.charToByteMap_={},this.byteToCharMapWebSafe_={},this.charToByteMapWebSafe_={};for(var t=0;t<this.ENCODED_VALS.length;t++)this.byteToCharMap_[t]=this.ENCODED_VALS.charAt(t),this.charToByteMap_[this.byteToCharMap_[t]]=t,this.byteToCharMapWebSafe_[t]=this.ENCODED_VALS_WEBSAFE.charAt(t),this.charToByteMapWebSafe_[this.byteToCharMapWebSafe_[t]]=t,t>=this.ENCODED_VALS_BASE.length&&(this.charToByteMap_[this.ENCODED_VALS_WEBSAFE.charAt(t)]=t,this.charToByteMapWebSafe_[this.ENCODED_VALS.charAt(t)]=t)}}},base64Encode=function(t){var e=stringToByteArray$1(t);return base64.encodeByteArray(e,!0)},base64urlEncodeWithoutPadding=function(t){return base64Encode(t).replace(/\./g,"")};function createMockUserToken(t,e){if(t.uid)throw new Error('The "uid" field is no longer supported by mockUserToken. Please use "sub" instead for Firebase Auth User ID.');var n=e||"demo-project",r=t.iat||0,s=t.sub||t.user_id;if(!s)throw new Error("mockUserToken must contain 'sub' or 'user_id' field!");var i=__assign({iss:"https://securetoken.google.com/"+n,aud:n,iat:r,exp:r+3600,auth_time:r,sub:s,user_id:s,firebase:{sign_in_provider:"custom",identities:{}}},t);return[base64urlEncodeWithoutPadding(JSON.stringify({alg:"none",type:"JWT"})),base64urlEncodeWithoutPadding(JSON.stringify(i)),""].join(".")}function getUA(){return"undefined"!=typeof navigator&&"string"==typeof navigator.userAgent?navigator.userAgent:""}function isMobileCordova(){return"undefined"!=typeof window&&!!(window.cordova||window.phonegap||window.PhoneGap)&&/ios|iphone|ipod|ipad|android|blackberry|iemobile/i.test(getUA())}function isNode(){try{return"[object process]"===Object.prototype.toString.call(global.process)}catch(t){return!1}}function isBrowserExtension(){var t="object"==typeof chrome?chrome.runtime:"object"==typeof browser?browser.runtime:void 0;return"object"==typeof t&&void 0!==t.id}function isReactNative(){return"object"==typeof navigator&&"ReactNative"===navigator.product}function isElectron(){return getUA().indexOf("Electron/")>=0}function isIE(){var t=getUA();return t.indexOf("MSIE ")>=0||t.indexOf("Trident/")>=0}function isUWP(){return getUA().indexOf("MSAppHost/")>=0}function isSafari(){return!isNode()&&navigator.userAgent.includes("Safari")&&!navigator.userAgent.includes("Chrome")}var ERROR_NAME="FirebaseError",FirebaseError=function(t){function e(n,r,s){var i=t.call(this,r)||this;return i.code=n,i.customData=s,i.name=ERROR_NAME,Object.setPrototypeOf(i,e.prototype),Error.captureStackTrace&&Error.captureStackTrace(i,ErrorFactory.prototype.create),i}return __extends$1(e,t),e}(Error),ErrorFactory=function(){function t(t,e,n){this.service=t,this.serviceName=e,this.errors=n}return t.prototype.create=function(t){for(var e=[],n=1;n<arguments.length;n++)e[n-1]=arguments[n];var r=e[0]||{},s=this.service+"/"+t,i=this.errors[t],o=i?replaceTemplate(i,r):"Error",a=this.serviceName+": "+o+" ("+s+").";return new FirebaseError(s,a,r)},t}();function replaceTemplate(t,e){return t.replace(PATTERN,function(t,n){var r=e[n];return null!=r?String(r):"<"+n+"?>"})}var PATTERN=/\{\$([^}]+)}/g;function deepEqual(t,e){if(t===e)return!0;for(var n=Object.keys(t),r=Object.keys(e),s=0,i=n;s<i.length;s++){var o=i[s];if(!r.includes(o))return!1;var a=t[o],c=e[o];if(isObject(a)&&isObject(c)){if(!deepEqual(a,c))return!1}else if(a!==c)return!1}for(var u=0,h=r;u<h.length;u++){o=h[u];if(!n.includes(o))return!1}return!0}function isObject(t){return null!==t&&"object"==typeof t}function getModularInstance(t){return t&&t._delegate?t._delegate:t}var _a$1,LogLevel,Component=function(){function t(t,e,n){this.name=t,this.instanceFactory=e,this.type=n,this.multipleInstances=!1,this.serviceProps={},this.instantiationMode="LAZY",this.onInstanceCreated=null}return t.prototype.setInstantiationMode=function(t){return this.instantiationMode=t,this},t.prototype.setMultipleInstances=function(t){return this.multipleInstances=t,this},t.prototype.setServiceProps=function(t){return this.serviceProps=t,this},t.prototype.setInstanceCreatedCallback=function(t){return this.onInstanceCreated=t,this},t}();!function(t){t[t.DEBUG=0]="DEBUG",t[t.VERBOSE=1]="VERBOSE",t[t.INFO=2]="INFO",t[t.WARN=3]="WARN",t[t.ERROR=4]="ERROR",t[t.SILENT=5]="SILENT"}(LogLevel||(LogLevel={}));var levelStringToEnum={debug:LogLevel.DEBUG,verbose:LogLevel.VERBOSE,info:LogLevel.INFO,warn:LogLevel.WARN,error:LogLevel.ERROR,silent:LogLevel.SILENT},defaultLogLevel=LogLevel.INFO,ConsoleMethod=((_a$1={})[LogLevel.DEBUG]="log",_a$1[LogLevel.VERBOSE]="log",_a$1[LogLevel.INFO]="info",_a$1[LogLevel.WARN]="warn",_a$1[LogLevel.ERROR]="error",_a$1),defaultLogHandler=function(t,e){for(var n=[],r=2;r<arguments.length;r++)n[r-2]=arguments[r];if(!(e<t.logLevel)){var s=(new Date).toISOString(),i=ConsoleMethod[e];if(!i)throw new Error("Attempted to log a message with an invalid logType (value: "+e+")");console[i].apply(console,__spreadArray(["["+s+"]  "+t.name+":"],n))}},Logger=function(){function t(t){this.name=t,this._logLevel=defaultLogLevel,this._logHandler=defaultLogHandler,this._userLogHandler=null}return Object.defineProperty(t.prototype,"logLevel",{get:function(){return this._logLevel},set:function(t){if(!(t in LogLevel))throw new TypeError('Invalid value "'+t+'" assigned to `logLevel`');this._logLevel=t},enumerable:!1,configurable:!0}),t.prototype.setLogLevel=function(t){this._logLevel="string"==typeof t?levelStringToEnum[t]:t},Object.defineProperty(t.prototype,"logHandler",{get:function(){return this._logHandler},set:function(t){if("function"!=typeof t)throw new TypeError("Value assigned to `logHandler` must be a function");this._logHandler=t},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"userLogHandler",{get:function(){return this._userLogHandler},set:function(t){this._userLogHandler=t},enumerable:!1,configurable:!0}),t.prototype.debug=function(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];this._userLogHandler&&this._userLogHandler.apply(this,__spreadArray([this,LogLevel.DEBUG],t)),this._logHandler.apply(this,__spreadArray([this,LogLevel.DEBUG],t))},t.prototype.log=function(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];this._userLogHandler&&this._userLogHandler.apply(this,__spreadArray([this,LogLevel.VERBOSE],t)),this._logHandler.apply(this,__spreadArray([this,LogLevel.VERBOSE],t))},t.prototype.info=function(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];this._userLogHandler&&this._userLogHandler.apply(this,__spreadArray([this,LogLevel.INFO],t)),this._logHandler.apply(this,__spreadArray([this,LogLevel.INFO],t))},t.prototype.warn=function(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];this._userLogHandler&&this._userLogHandler.apply(this,__spreadArray([this,LogLevel.WARN],t)),this._logHandler.apply(this,__spreadArray([this,LogLevel.WARN],t))},t.prototype.error=function(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];this._userLogHandler&&this._userLogHandler.apply(this,__spreadArray([this,LogLevel.ERROR],t)),this._logHandler.apply(this,__spreadArray([this,LogLevel.ERROR],t))},t}(),extendStatics=function(t,e){return(extendStatics=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&(t[n]=e[n])})(t,e)};function __extends(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Class extends value "+String(e)+" is not a constructor or null");function n(){this.constructor=t}extendStatics(t,e),t.prototype=null===e?Object.create(e):(n.prototype=e.prototype,new n)}function __values(t){var e="function"==typeof Symbol&&Symbol.iterator,n=e&&t[e],r=0;if(n)return n.call(t);if(t&&"number"==typeof t.length)return{next:function(){return t&&r>=t.length&&(t=void 0),{value:t&&t[r++],done:!t}}};throw new TypeError(e?"Object is not iterable.":"Symbol.iterator is not defined.")}var k$1,commonjsGlobal="undefined"!=typeof globalThis?globalThis:"undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:{},goog=goog||{},l=commonjsGlobal||self;function aa$1(){}function ba$1(t){var e=typeof t;return"array"==(e="object"!=e?e:t?Array.isArray(t)?"array":e:"null")||"object"==e&&"number"==typeof t.length}function p(t){var e=typeof t;return"object"==e&&null!=t||"function"==e}function da$1(t){return Object.prototype.hasOwnProperty.call(t,ea$1)&&t[ea$1]||(t[ea$1]=++fa$1)}var ea$1="closure_uid_"+(1e9*Math.random()>>>0),fa$1=0;function ha$1(t,e,n){return t.call.apply(t.bind,arguments)}function ia$1(t,e,n){if(!t)throw Error();if(2<arguments.length){var r=Array.prototype.slice.call(arguments,2);return function(){var n=Array.prototype.slice.call(arguments);return Array.prototype.unshift.apply(n,r),t.apply(e,n)}}return function(){return t.apply(e,arguments)}}function q$1(t,e,n){return(q$1=Function.prototype.bind&&-1!=Function.prototype.bind.toString().indexOf("native code")?ha$1:ia$1).apply(null,arguments)}function ja$1(t,e){var n=Array.prototype.slice.call(arguments,1);return function(){var e=n.slice();return e.push.apply(e,arguments),t.apply(this,e)}}function t(t,e){function n(){}n.prototype=e.prototype,t.Z=e.prototype,t.prototype=new n,t.prototype.constructor=t,t.Vb=function(t,n,r){for(var s=Array(arguments.length-2),i=2;i<arguments.length;i++)s[i-2]=arguments[i];return e.prototype[n].apply(t,s)}}function v(){this.s=this.s,this.o=this.o}var ka$1=0,la$1={};v.prototype.s=!1,v.prototype.na=function(){if(!this.s&&(this.s=!0,this.M(),0!=ka$1)){var t=da$1(this);delete la$1[t]}},v.prototype.M=function(){if(this.o)for(;this.o.length;)this.o.shift()()};var ma$1=Array.prototype.indexOf?function(t,e){return Array.prototype.indexOf.call(t,e,void 0)}:function(t,e){if("string"==typeof t)return"string"!=typeof e||1!=e.length?-1:t.indexOf(e,0);for(var n=0;n<t.length;n++)if(n in t&&t[n]===e)return n;return-1},na$1=Array.prototype.forEach?function(t,e,n){Array.prototype.forEach.call(t,e,n)}:function(t,e,n){for(var r=t.length,s="string"==typeof t?t.split(""):t,i=0;i<r;i++)i in s&&e.call(n,s[i],i,t)};function oa$1(t){t:{for(var e=pa$1,n=t.length,r="string"==typeof t?t.split(""):t,s=0;s<n;s++)if(s in r&&e.call(void 0,r[s],s,t)){e=s;break t}e=-1}return 0>e?null:"string"==typeof t?t.charAt(e):t[e]}function qa$1(t){return Array.prototype.concat.apply([],arguments)}function ra$1(t){var e=t.length;if(0<e){for(var n=Array(e),r=0;r<e;r++)n[r]=t[r];return n}return[]}function sa$1(t){return/^[\s\xa0]*$/.test(t)}var x$1,ta$1=String.prototype.trim?function(t){return t.trim()}:function(t){return/^[\s\xa0]*([\s\S]*?)[\s\xa0]*$/.exec(t)[1]};function w(t,e){return-1!=t.indexOf(e)}function ua$1(t,e){return t<e?-1:t>e?1:0}t:{var va$1=l.navigator;if(va$1){var wa$1=va$1.userAgent;if(wa$1){x$1=wa$1;break t}}x$1=""}function xa$1(t,e,n){for(var r in t)e.call(n,t[r],r,t)}function ya$1(t){var e={};for(var n in t)e[n]=t[n];return e}var za$1="constructor hasOwnProperty isPrototypeOf propertyIsEnumerable toLocaleString toString valueOf".split(" ");function Aa$1(t,e){for(var n,r,s=1;s<arguments.length;s++){for(n in r=arguments[s])t[n]=r[n];for(var i=0;i<za$1.length;i++)n=za$1[i],Object.prototype.hasOwnProperty.call(r,n)&&(t[n]=r[n])}}function Ca$1(t){return Ca$1[" "](t),t}function Fa$1(t){var e=Ga$1;return Object.prototype.hasOwnProperty.call(e,9)?e[9]:e[9]=t(9)}Ca$1[" "]=aa$1;var Na$1,Ha$1=w(x$1,"Opera"),y=w(x$1,"Trident")||w(x$1,"MSIE"),Ia$1=w(x$1,"Edge"),Ja$1=Ia$1||y,Ka$1=w(x$1,"Gecko")&&!(w(x$1.toLowerCase(),"webkit")&&!w(x$1,"Edge"))&&!(w(x$1,"Trident")||w(x$1,"MSIE"))&&!w(x$1,"Edge"),La$1=w(x$1.toLowerCase(),"webkit")&&!w(x$1,"Edge");function Ma$1(){var t=l.document;return t?t.documentMode:void 0}t:{var Oa$1="",Pa$1=function(){var t=x$1;return Ka$1?/rv:([^\);]+)(\)|;)/.exec(t):Ia$1?/Edge\/([\d\.]+)/.exec(t):y?/\b(?:MSIE|rv)[: ]([^\);]+)(\)|;)/.exec(t):La$1?/WebKit\/(\S+)/.exec(t):Ha$1?/(?:Version)[ \/]?(\S+)/.exec(t):void 0}();if(Pa$1&&(Oa$1=Pa$1?Pa$1[1]:""),y){var Qa$1=Ma$1();if(null!=Qa$1&&Qa$1>parseFloat(Oa$1)){Na$1=String(Qa$1);break t}}Na$1=Oa$1}var Sa$1,Ga$1={};function Ra$1(){return Fa$1(function(){for(var t=0,e=ta$1(String(Na$1)).split("."),n=ta$1("9").split("."),r=Math.max(e.length,n.length),s=0;0==t&&s<r;s++){var i=e[s]||"",o=n[s]||"";do{if(i=/(\d*)(\D*)(.*)/.exec(i)||["","","",""],o=/(\d*)(\D*)(.*)/.exec(o)||["","","",""],0==i[0].length&&0==o[0].length)break;t=ua$1(0==i[1].length?0:parseInt(i[1],10),0==o[1].length?0:parseInt(o[1],10))||ua$1(0==i[2].length,0==o[2].length)||ua$1(i[2],o[2]),i=i[3],o=o[3]}while(0==t)}return 0<=t})}if(l.document&&y){var Ta$1=Ma$1();Sa$1=Ta$1||(parseInt(Na$1,10)||void 0)}else Sa$1=void 0;var Ua$1=Sa$1,Va$1=function(){if(!l.addEventListener||!Object.defineProperty)return!1;var t=!1,e=Object.defineProperty({},"passive",{get:function(){t=!0}});try{l.addEventListener("test",aa$1,e),l.removeEventListener("test",aa$1,e)}catch(t){}return t}();function z$1(t,e){this.type=t,this.g=this.target=e,this.defaultPrevented=!1}function A(t,e){if(z$1.call(this,t?t.type:""),this.relatedTarget=this.g=this.target=null,this.button=this.screenY=this.screenX=this.clientY=this.clientX=0,this.key="",this.metaKey=this.shiftKey=this.altKey=this.ctrlKey=!1,this.state=null,this.pointerId=0,this.pointerType="",this.i=null,t){var n=this.type=t.type,r=t.changedTouches&&t.changedTouches.length?t.changedTouches[0]:null;if(this.target=t.target||t.srcElement,this.g=e,e=t.relatedTarget){if(Ka$1){t:{try{Ca$1(e.nodeName);var s=!0;break t}catch(t){}s=!1}s||(e=null)}}else"mouseover"==n?e=t.fromElement:"mouseout"==n&&(e=t.toElement);this.relatedTarget=e,r?(this.clientX=void 0!==r.clientX?r.clientX:r.pageX,this.clientY=void 0!==r.clientY?r.clientY:r.pageY,this.screenX=r.screenX||0,this.screenY=r.screenY||0):(this.clientX=void 0!==t.clientX?t.clientX:t.pageX,this.clientY=void 0!==t.clientY?t.clientY:t.pageY,this.screenX=t.screenX||0,this.screenY=t.screenY||0),this.button=t.button,this.key=t.key||"",this.ctrlKey=t.ctrlKey,this.altKey=t.altKey,this.shiftKey=t.shiftKey,this.metaKey=t.metaKey,this.pointerId=t.pointerId||0,this.pointerType="string"==typeof t.pointerType?t.pointerType:Wa$1[t.pointerType]||"",this.state=t.state,this.i=t,t.defaultPrevented&&A.Z.h.call(this)}}z$1.prototype.h=function(){this.defaultPrevented=!0},t(A,z$1);var Wa$1={2:"touch",3:"pen",4:"mouse"};A.prototype.h=function(){A.Z.h.call(this);var t=this.i;t.preventDefault?t.preventDefault():t.returnValue=!1};var B$1="closure_listenable_"+(1e6*Math.random()|0),Xa$1=0;function Ya$1(t,e,n,r,s){this.listener=t,this.proxy=null,this.src=e,this.type=n,this.capture=!!r,this.ia=s,this.key=++Xa$1,this.ca=this.fa=!1}function Za$1(t){t.ca=!0,t.listener=null,t.proxy=null,t.src=null,t.ia=null}function $a$1(t){this.src=t,this.g={},this.h=0}function bb(t,e){var n=e.type;if(n in t.g){var r,s=t.g[n],i=ma$1(s,e);(r=0<=i)&&Array.prototype.splice.call(s,i,1),r&&(Za$1(e),0==t.g[n].length&&(delete t.g[n],t.h--))}}function ab(t,e,n,r){for(var s=0;s<t.length;++s){var i=t[s];if(!i.ca&&i.listener==e&&i.capture==!!n&&i.ia==r)return s}return-1}$a$1.prototype.add=function(t,e,n,r,s){var i=t.toString();(t=this.g[i])||(t=this.g[i]=[],this.h++);var o=ab(t,e,r,s);return-1<o?(e=t[o],n||(e.fa=!1)):((e=new Ya$1(e,this.src,i,!!r,s)).fa=n,t.push(e)),e};var cb="closure_lm_"+(1e6*Math.random()|0),db={};function fb(t,e,n,r,s){if(r&&r.once)return gb(t,e,n,r,s);if(Array.isArray(e)){for(var i=0;i<e.length;i++)fb(t,e[i],n,r,s);return null}return n=hb(n),t&&t[B$1]?t.N(e,n,p(r)?!!r.capture:!!r,s):ib(t,e,n,!1,r,s)}function ib(t,e,n,r,s,i){if(!e)throw Error("Invalid event type");var o=p(s)?!!s.capture:!!s,a=jb(t);if(a||(t[cb]=a=new $a$1(t)),(n=a.add(e,n,r,o,i)).proxy)return n;if(r=kb(),n.proxy=r,r.src=t,r.listener=n,t.addEventListener)Va$1||(s=o),void 0===s&&(s=!1),t.addEventListener(e.toString(),r,s);else if(t.attachEvent)t.attachEvent(lb(e.toString()),r);else{if(!t.addListener||!t.removeListener)throw Error("addEventListener and attachEvent are unavailable.");t.addListener(r)}return n}function kb(){var t=mb;return function e(n){return t.call(e.src,e.listener,n)}}function gb(t,e,n,r,s){if(Array.isArray(e)){for(var i=0;i<e.length;i++)gb(t,e[i],n,r,s);return null}return n=hb(n),t&&t[B$1]?t.O(e,n,p(r)?!!r.capture:!!r,s):ib(t,e,n,!0,r,s)}function nb(t,e,n,r,s){if(Array.isArray(e))for(var i=0;i<e.length;i++)nb(t,e[i],n,r,s);else r=p(r)?!!r.capture:!!r,n=hb(n),t&&t[B$1]?(t=t.i,(e=String(e).toString())in t.g&&(-1<(n=ab(i=t.g[e],n,r,s))&&(Za$1(i[n]),Array.prototype.splice.call(i,n,1),0==i.length&&(delete t.g[e],t.h--)))):t&&(t=jb(t))&&(e=t.g[e.toString()],t=-1,e&&(t=ab(e,n,r,s)),(n=-1<t?e[t]:null)&&ob(n))}function ob(t){if("number"!=typeof t&&t&&!t.ca){var e=t.src;if(e&&e[B$1])bb(e.i,t);else{var n=t.type,r=t.proxy;e.removeEventListener?e.removeEventListener(n,r,t.capture):e.detachEvent?e.detachEvent(lb(n),r):e.addListener&&e.removeListener&&e.removeListener(r),(n=jb(e))?(bb(n,t),0==n.h&&(n.src=null,e[cb]=null)):Za$1(t)}}}function lb(t){return t in db?db[t]:db[t]="on"+t}function mb(t,e){if(t.ca)t=!0;else{e=new A(e,this);var n=t.listener,r=t.ia||t.src;t.fa&&ob(t),t=n.call(r,e)}return t}function jb(t){return(t=t[cb])instanceof $a$1?t:null}var pb="__closure_events_fn_"+(1e9*Math.random()>>>0);function hb(t){return"function"==typeof t?t:(t[pb]||(t[pb]=function(e){return t.handleEvent(e)}),t[pb])}function C$1(){v.call(this),this.i=new $a$1(this),this.P=this,this.I=null}function D$1(t,e){var n,r=t.I;if(r)for(n=[];r;r=r.I)n.push(r);if(t=t.P,r=e.type||e,"string"==typeof e)e=new z$1(e,t);else if(e instanceof z$1)e.target=e.target||t;else{var s=e;Aa$1(e=new z$1(r,t),s)}if(s=!0,n)for(var i=n.length-1;0<=i;i--){var o=e.g=n[i];s=qb(o,r,!0,e)&&s}if(s=qb(o=e.g=t,r,!0,e)&&s,s=qb(o,r,!1,e)&&s,n)for(i=0;i<n.length;i++)s=qb(o=e.g=n[i],r,!1,e)&&s}function qb(t,e,n,r){if(!(e=t.i.g[String(e)]))return!0;e=e.concat();for(var s=!0,i=0;i<e.length;++i){var o=e[i];if(o&&!o.ca&&o.capture==n){var a=o.listener,c=o.ia||o.src;o.fa&&bb(t.i,o),s=!1!==a.call(c,r)&&s}}return s&&!r.defaultPrevented}t(C$1,v),C$1.prototype[B$1]=!0,C$1.prototype.removeEventListener=function(t,e,n,r){nb(this,t,e,n,r)},C$1.prototype.M=function(){if(C$1.Z.M.call(this),this.i){var t,e=this.i;for(t in e.g){for(var n=e.g[t],r=0;r<n.length;r++)Za$1(n[r]);delete e.g[t],e.h--}}this.I=null},C$1.prototype.N=function(t,e,n,r){return this.i.add(String(t),e,!1,n,r)},C$1.prototype.O=function(t,e,n,r){return this.i.add(String(t),e,!0,n,r)};var rb=l.JSON.stringify;function sb(){var t=tb,e=null;return t.g&&(e=t.g,t.g=t.g.next,t.g||(t.h=null),e.next=null),e}var Ab,ub=function(){function t(){this.h=this.g=null}return t.prototype.add=function(t,e){var n=vb.get();n.set(t,e),this.h?this.h.next=n:this.g=n,this.h=n},t}(),vb=new(function(){function t(t,e){this.i=t,this.j=e,this.h=0,this.g=null}return t.prototype.get=function(){var t;return 0<this.h?(this.h--,t=this.g,this.g=t.next,t.next=null):t=this.i(),t},t}())(function(){return new wb},function(t){return t.reset()}),wb=function(){function t(){this.next=this.g=this.h=null}return t.prototype.set=function(t,e){this.h=t,this.g=e,this.next=null},t.prototype.reset=function(){this.next=this.g=this.h=null},t}();function yb(t){l.setTimeout(function(){throw t},0)}function zb(t,e){Ab||Bb(),Cb||(Ab(),Cb=!0),tb.add(t,e)}function Bb(){var t=l.Promise.resolve(void 0);Ab=function(){t.then(Db)}}var Cb=!1,tb=new ub;function Db(){for(var t;t=sb();){try{t.h.call(t.g)}catch(t){yb(t)}var e=vb;e.j(t),100>e.h&&(e.h++,t.next=e.g,e.g=t)}Cb=!1}function Eb(t,e){C$1.call(this),this.h=t||1,this.g=e||l,this.j=q$1(this.kb,this),this.l=Date.now()}function Fb(t){t.da=!1,t.S&&(t.g.clearTimeout(t.S),t.S=null)}function Gb(t,e,n){if("function"==typeof t)n&&(t=q$1(t,n));else{if(!t||"function"!=typeof t.handleEvent)throw Error("Invalid listener argument");t=q$1(t.handleEvent,t)}return 2147483647<Number(e)?-1:l.setTimeout(t,e||0)}function Hb(t){t.g=Gb(function(){t.g=null,t.i&&(t.i=!1,Hb(t))},t.j);var e=t.h;t.h=null,t.m.apply(null,e)}t(Eb,C$1),(k$1=Eb.prototype).da=!1,k$1.S=null,k$1.kb=function(){if(this.da){var t=Date.now()-this.l;0<t&&t<.8*this.h?this.S=this.g.setTimeout(this.j,this.h-t):(this.S&&(this.g.clearTimeout(this.S),this.S=null),D$1(this,"tick"),this.da&&(Fb(this),this.start()))}},k$1.start=function(){this.da=!0,this.S||(this.S=this.g.setTimeout(this.j,this.h),this.l=Date.now())},k$1.M=function(){Eb.Z.M.call(this),Fb(this),delete this.g};var Ib=function(t){function e(e,n){var r=t.call(this)||this;return r.m=e,r.j=n,r.h=null,r.i=!1,r.g=null,r}return __extends(e,t),e.prototype.l=function(t){this.h=arguments,this.g?this.i=!0:Hb(this)},e.prototype.M=function(){t.prototype.M.call(this),this.g&&(l.clearTimeout(this.g),this.g=null,this.i=!1,this.h=null)},e}(v);function E(t){v.call(this),this.h=t,this.g={}}t(E,v);var Jb=[];function Kb(t,e,n,r){Array.isArray(n)||(n&&(Jb[0]=n.toString()),n=Jb);for(var s=0;s<n.length;s++){var i=fb(e,n[s],r||t.handleEvent,!1,t.h||t);if(!i)break;t.g[i.key]=i}}function Lb(t){xa$1(t.g,function(t,e){this.g.hasOwnProperty(e)&&ob(t)},t),t.g={}}function Mb(){this.g=!0}function Nb(t,e,n,r,s,i){t.info(function(){if(t.g)if(i)for(var o="",a=i.split("&"),c=0;c<a.length;c++){var u=a[c].split("=");if(1<u.length){var h=u[0];u=u[1];var l=h.split("_");o=2<=l.length&&"type"==l[1]?o+(h+"=")+u+"&":o+(h+"=redacted&")}}else o=null;else o=i;return"XMLHTTP REQ ("+r+") [attempt "+s+"]: "+e+"\n"+n+"\n"+o})}function Ob(t,e,n,r,s,i,o){t.info(function(){return"XMLHTTP RESP ("+r+") [ attempt "+s+"]: "+e+"\n"+n+"\n"+i+" "+o})}function F$1(t,e,n,r){t.info(function(){return"XMLHTTP TEXT ("+e+"): "+Pb(t,n)+(r?" "+r:"")})}function Qb(t,e){t.info(function(){return"TIMEOUT: "+e})}function Pb(t,e){if(!t.g)return e;if(!e)return null;try{var n=JSON.parse(e);if(n)for(t=0;t<n.length;t++)if(Array.isArray(n[t])){var r=n[t];if(!(2>r.length)){var s=r[1];if(Array.isArray(s)&&!(1>s.length)){var i=s[0];if("noop"!=i&&"stop"!=i&&"close"!=i)for(var o=1;o<s.length;o++)s[o]=""}}}return rb(n)}catch(t){return e}}E.prototype.M=function(){E.Z.M.call(this),Lb(this)},E.prototype.handleEvent=function(){throw Error("EventHandler.handleEvent not implemented")},Mb.prototype.Aa=function(){this.g=!1},Mb.prototype.info=function(){};var H$1={},Rb=null;function Sb(){return Rb=Rb||new C$1}function Tb(t){z$1.call(this,H$1.Ma,t)}function I(t){var e=Sb();D$1(e,new Tb(e,t))}function Ub(t,e){z$1.call(this,H$1.STAT_EVENT,t),this.stat=e}function J$1(t){var e=Sb();D$1(e,new Ub(e,t))}function Vb(t,e){z$1.call(this,H$1.Na,t),this.size=e}function K$1(t,e){if("function"!=typeof t)throw Error("Fn must not be null and must be a function");return l.setTimeout(function(){t()},e)}H$1.Ma="serverreachability",t(Tb,z$1),H$1.STAT_EVENT="statevent",t(Ub,z$1),H$1.Na="timingevent",t(Vb,z$1);var Wb={NO_ERROR:0,lb:1,yb:2,xb:3,sb:4,wb:5,zb:6,Ja:7,TIMEOUT:8,Cb:9},Xb={qb:"complete",Mb:"success",Ka:"error",Ja:"abort",Eb:"ready",Fb:"readystatechange",TIMEOUT:"timeout",Ab:"incrementaldata",Db:"progress",tb:"downloadprogress",Ub:"uploadprogress"};function Yb(){}function Zb(t){return t.h||(t.h=t.i())}function $b(){}Yb.prototype.h=null;var cc$1,L$1={OPEN:"a",pb:"b",Ka:"c",Bb:"d"};function ac$1(){z$1.call(this,"d")}function bc$1(){z$1.call(this,"c")}function dc$1(){}function M$1(t,e,n,r){this.l=t,this.j=e,this.m=n,this.X=r||1,this.V=new E(this),this.P=ec$1,t=Ja$1?125:void 0,this.W=new Eb(t),this.H=null,this.i=!1,this.s=this.A=this.v=this.K=this.F=this.Y=this.B=null,this.D=[],this.g=null,this.C=0,this.o=this.u=null,this.N=-1,this.I=!1,this.O=0,this.L=null,this.aa=this.J=this.$=this.U=!1,this.h=new fc$1}function fc$1(){this.i=null,this.g="",this.h=!1}t(ac$1,z$1),t(bc$1,z$1),t(dc$1,Yb),dc$1.prototype.g=function(){return new XMLHttpRequest},dc$1.prototype.i=function(){return{}},cc$1=new dc$1;var ec$1=45e3,gc$1={},hc$1={};function ic$1(t,e,n){t.K=1,t.v=jc$1(N$1(e)),t.s=n,t.U=!0,kc$1(t,null)}function kc$1(t,e){t.F=Date.now(),lc$1(t),t.A=N$1(t.v);var n=t.A,r=t.X;Array.isArray(r)||(r=[String(r)]),mc$1(n.h,"t",r),t.C=0,n=t.l.H,t.h=new fc$1,t.g=nc$1(t.l,n?e:null,!t.s),0<t.O&&(t.L=new Ib(q$1(t.Ia,t,t.g),t.O)),Kb(t.V,t.g,"readystatechange",t.gb),e=t.H?ya$1(t.H):{},t.s?(t.u||(t.u="POST"),e["Content-Type"]="application/x-www-form-urlencoded",t.g.ea(t.A,t.u,t.s,e)):(t.u="GET",t.g.ea(t.A,t.u,null,e)),I(1),Nb(t.j,t.u,t.A,t.m,t.X,t.s)}function qc$1(t){return!!t.g&&("GET"==t.u&&2!=t.K&&t.l.Ba)}function tc$1(t,e,n){for(var r,s=!0;!t.I&&t.C<n.length;){if((r=vc$1(t,n))==hc$1){4==e&&(t.o=4,J$1(14),s=!1),F$1(t.j,t.m,null,"[Incomplete Response]");break}if(r==gc$1){t.o=4,J$1(15),F$1(t.j,t.m,n,"[Invalid Chunk]"),s=!1;break}F$1(t.j,t.m,r,null),sc$1(t,r)}qc$1(t)&&r!=hc$1&&r!=gc$1&&(t.h.g="",t.C=0),4!=e||0!=n.length||t.h.h||(t.o=1,J$1(16),s=!1),t.i=t.i&&s,s?0<n.length&&!t.aa&&(t.aa=!0,(e=t.l).g==t&&e.$&&!e.L&&(e.h.info("Great, no buffering proxy detected. Bytes received: "+n.length),wc$1(e),e.L=!0,J$1(11))):(F$1(t.j,t.m,n,"[Invalid Chunked Response]"),P(t),rc$1(t))}function vc$1(t,e){var n=t.C,r=e.indexOf("\n",n);return-1==r?hc$1:(n=Number(e.substring(n,r)),isNaN(n)?gc$1:(r+=1)+n>e.length?hc$1:(e=e.substr(r,n),t.C=r+n,e))}function lc$1(t){t.Y=Date.now()+t.P,xc$1(t,t.P)}function xc$1(t,e){if(null!=t.B)throw Error("WatchDog timer not null");t.B=K$1(q$1(t.eb,t),e)}function pc$1(t){t.B&&(l.clearTimeout(t.B),t.B=null)}function rc$1(t){0==t.l.G||t.I||uc$1(t.l,t)}function P(t){pc$1(t);var e=t.L;e&&"function"==typeof e.na&&e.na(),t.L=null,Fb(t.W),Lb(t.V),t.g&&(e=t.g,t.g=null,e.abort(),e.na())}function sc$1(t,e){try{var n=t.l;if(0!=n.G&&(n.g==t||yc$1(n.i,t)))if(n.I=t.N,!t.J&&yc$1(n.i,t)&&3==n.G){try{var r=n.Ca.g.parse(e)}catch(i){r=null}if(Array.isArray(r)&&3==r.length){var s=r;if(0==s[0]){t:if(!n.u){if(n.g){if(!(n.g.F+3e3<t.F))break t;zc$1(n),Ac$1(n)}Bc$1(n),J$1(18)}}else n.ta=s[1],0<n.ta-n.U&&37500>s[2]&&n.N&&0==n.A&&!n.v&&(n.v=K$1(q$1(n.ab,n),6e3));if(1>=Cc$1(n.i)&&n.ka){try{n.ka()}catch(i){}n.ka=void 0}}else Q$1(n,11)}else if((t.J||n.g==t)&&zc$1(n),!sa$1(e))for(s=n.Ca.g.parse(e),e=0;e<s.length;e++){var i=s[e];if(n.U=i[0],i=i[1],2==n.G)if("c"==i[0]){n.J=i[1],n.la=i[2];var o=i[3];null!=o&&(n.ma=o,n.h.info("VER="+n.ma));var a=i[4];null!=a&&(n.za=a,n.h.info("SVER="+n.za));var c=i[5];null!=c&&"number"==typeof c&&0<c&&(r=1.5*c,n.K=r,n.h.info("backChannelRequestTimeoutMs_="+r)),r=n;var u=t.g;if(u){var h=u.g?u.g.getResponseHeader("X-Client-Wire-Protocol"):null;if(h){var l=r.i;!l.g&&(w(h,"spdy")||w(h,"quic")||w(h,"h2"))&&(l.j=l.l,l.g=new Set,l.h&&(Dc$1(l,l.h),l.h=null))}if(r.D){var d=u.g?u.g.getResponseHeader("X-HTTP-Session-Id"):null;d&&(r.sa=d,R(r.F,r.D,d))}}n.G=3,n.j&&n.j.xa(),n.$&&(n.O=Date.now()-t.F,n.h.info("Handshake RTT: "+n.O+"ms"));var f=t;if((r=n).oa=Ec$1(r,r.H?r.la:null,r.W),f.J){Fc$1(r.i,f);var g=f,m=r.K;m&&g.setTimeout(m),g.B&&(pc$1(g),lc$1(g)),r.g=f}else Gc$1(r);0<n.l.length&&Hc$1(n)}else"stop"!=i[0]&&"close"!=i[0]||Q$1(n,7);else 3==n.G&&("stop"==i[0]||"close"==i[0]?"stop"==i[0]?Q$1(n,7):Ic$1(n):"noop"!=i[0]&&n.j&&n.j.wa(i),n.A=0)}I(4)}catch(i){}}function Jc$1(t){if(t.R&&"function"==typeof t.R)return t.R();if("string"==typeof t)return t.split("");if(ba$1(t)){for(var e=[],n=t.length,r=0;r<n;r++)e.push(t[r]);return e}for(r in e=[],n=0,t)e[n++]=t[r];return e}function Kc$1(t,e){if(t.forEach&&"function"==typeof t.forEach)t.forEach(e,void 0);else if(ba$1(t)||"string"==typeof t)na$1(t,e,void 0);else{if(t.T&&"function"==typeof t.T)var n=t.T();else if(t.R&&"function"==typeof t.R)n=void 0;else if(ba$1(t)||"string"==typeof t){n=[];for(var r=t.length,s=0;s<r;s++)n.push(s)}else for(s in n=[],r=0,t)n[r++]=s;s=(r=Jc$1(t)).length;for(var i=0;i<s;i++)e.call(void 0,r[i],n&&n[i],t)}}function S$1(t,e){this.h={},this.g=[],this.i=0;var n=arguments.length;if(1<n){if(n%2)throw Error("Uneven number of arguments");for(var r=0;r<n;r+=2)this.set(arguments[r],arguments[r+1])}else if(t)if(t instanceof S$1)for(n=t.T(),r=0;r<n.length;r++)this.set(n[r],t.get(n[r]));else for(r in t)this.set(r,t[r])}function Lc$1(t){if(t.i!=t.g.length){for(var e=0,n=0;e<t.g.length;){var r=t.g[e];T(t.h,r)&&(t.g[n++]=r),e++}t.g.length=n}if(t.i!=t.g.length){var s={};for(n=e=0;e<t.g.length;)T(s,r=t.g[e])||(t.g[n++]=r,s[r]=1),e++;t.g.length=n}}function T(t,e){return Object.prototype.hasOwnProperty.call(t,e)}(k$1=M$1.prototype).setTimeout=function(t){this.P=t},k$1.gb=function(t){t=t.target;var e=this.L;e&&3==O$1(t)?e.l():this.Ia(t)},k$1.Ia=function(t){try{if(t==this.g)t:{var e=O$1(this.g),n=this.g.Da(),r=this.g.ba();if(!(3>e)&&(3!=e||Ja$1||this.g&&(this.h.h||this.g.ga()||oc$1(this.g)))){this.I||4!=e||7==n||I(8==n||0>=r?3:2),pc$1(this);var s=this.g.ba();this.N=s;e:if(qc$1(this)){var i=oc$1(this.g);t="";var o=i.length,a=4==O$1(this.g);if(!this.h.i){if("undefined"==typeof TextDecoder){P(this),rc$1(this);var c="";break e}this.h.i=new l.TextDecoder}for(n=0;n<o;n++)this.h.h=!0,t+=this.h.i.decode(i[n],{stream:a&&n==o-1});i.splice(0,o),this.h.g+=t,this.C=0,c=this.h.g}else c=this.g.ga();if(this.i=200==s,Ob(this.j,this.u,this.A,this.m,this.X,e,s),this.i){if(this.$&&!this.J){e:{if(this.g){var u,h=this.g;if((u=h.g?h.g.getResponseHeader("X-HTTP-Initial-Response"):null)&&!sa$1(u)){var d=u;break e}}d=null}if(!(s=d)){this.i=!1,this.o=3,J$1(12),P(this),rc$1(this);break t}F$1(this.j,this.m,s,"Initial handshake response via X-HTTP-Initial-Response"),this.J=!0,sc$1(this,s)}this.U?(tc$1(this,e,c),Ja$1&&this.i&&3==e&&(Kb(this.V,this.W,"tick",this.fb),this.W.start())):(F$1(this.j,this.m,c,null),sc$1(this,c)),4==e&&P(this),this.i&&!this.I&&(4==e?uc$1(this.l,this):(this.i=!1,lc$1(this)))}else 400==s&&0<c.indexOf("Unknown SID")?(this.o=3,J$1(12)):(this.o=0,J$1(13)),P(this),rc$1(this)}}}catch(e){}},k$1.fb=function(){if(this.g){var t=O$1(this.g),e=this.g.ga();this.C<e.length&&(pc$1(this),tc$1(this,t,e),this.i&&4!=t&&lc$1(this))}},k$1.cancel=function(){this.I=!0,P(this)},k$1.eb=function(){this.B=null;var t=Date.now();0<=t-this.Y?(Qb(this.j,this.A),2!=this.K&&(I(3),J$1(17)),P(this),this.o=2,rc$1(this)):xc$1(this,this.Y-t)},(k$1=S$1.prototype).R=function(){Lc$1(this);for(var t=[],e=0;e<this.g.length;e++)t.push(this.h[this.g[e]]);return t},k$1.T=function(){return Lc$1(this),this.g.concat()},k$1.get=function(t,e){return T(this.h,t)?this.h[t]:e},k$1.set=function(t,e){T(this.h,t)||(this.i++,this.g.push(t)),this.h[t]=e},k$1.forEach=function(t,e){for(var n=this.T(),r=0;r<n.length;r++){var s=n[r],i=this.get(s);t.call(e,i,s,this)}};var Mc$1=/^(?:([^:\/?#.]+):)?(?:\/\/(?:([^\\\/?#]*)@)?([^\\\/?#]*?)(?::([0-9]+))?(?=[\\\/?#]|$))?([^?#]+)?(?:\?([^#]*))?(?:#([\s\S]*))?$/;function Nc$1(t,e){if(t){t=t.split("&");for(var n=0;n<t.length;n++){var r=t[n].indexOf("="),s=null;if(0<=r){var i=t[n].substring(0,r);s=t[n].substring(r+1)}else i=t[n];e(i,s?decodeURIComponent(s.replace(/\+/g," ")):"")}}}function U$1(t,e){if(this.i=this.s=this.j="",this.m=null,this.o=this.l="",this.g=!1,t instanceof U$1){this.g=void 0!==e?e:t.g,Oc$1(this,t.j),this.s=t.s,Pc$1(this,t.i),Qc$1(this,t.m),this.l=t.l,e=t.h;var n=new Rc$1;n.i=e.i,e.g&&(n.g=new S$1(e.g),n.h=e.h),Sc$1(this,n),this.o=t.o}else t&&(n=String(t).match(Mc$1))?(this.g=!!e,Oc$1(this,n[1]||"",!0),this.s=Tc$1(n[2]||""),Pc$1(this,n[3]||"",!0),Qc$1(this,n[4]),this.l=Tc$1(n[5]||"",!0),Sc$1(this,n[6]||"",!0),this.o=Tc$1(n[7]||"")):(this.g=!!e,this.h=new Rc$1(null,this.g))}function N$1(t){return new U$1(t)}function Oc$1(t,e,n){t.j=n?Tc$1(e,!0):e,t.j&&(t.j=t.j.replace(/:$/,""))}function Pc$1(t,e,n){t.i=n?Tc$1(e,!0):e}function Qc$1(t,e){if(e){if(e=Number(e),isNaN(e)||0>e)throw Error("Bad port number "+e);t.m=e}else t.m=null}function Sc$1(t,e,n){e instanceof Rc$1?(t.h=e,Zc$1(t.h,t.g)):(n||(e=Uc$1(e,$c$1)),t.h=new Rc$1(e,t.g))}function R(t,e,n){t.h.set(e,n)}function jc$1(t){return R(t,"zx",Math.floor(2147483648*Math.random()).toString(36)+Math.abs(Math.floor(2147483648*Math.random())^Date.now()).toString(36)),t}function ad(t){return t instanceof U$1?N$1(t):new U$1(t,void 0)}function bd(t,e,n,r){var s=new U$1(null,void 0);return t&&Oc$1(s,t),e&&Pc$1(s,e),n&&Qc$1(s,n),r&&(s.l=r),s}function Tc$1(t,e){return t?e?decodeURI(t.replace(/%25/g,"%2525")):decodeURIComponent(t):""}function Uc$1(t,e,n){return"string"==typeof t?(t=encodeURI(t).replace(e,cd),n&&(t=t.replace(/%25([0-9a-fA-F]{2})/g,"%$1")),t):null}function cd(t){return"%"+((t=t.charCodeAt(0))>>4&15).toString(16)+(15&t).toString(16)}U$1.prototype.toString=function(){var t=[],e=this.j;e&&t.push(Uc$1(e,Vc$1,!0),":");var n=this.i;return(n||"file"==e)&&(t.push("//"),(e=this.s)&&t.push(Uc$1(e,Vc$1,!0),"@"),t.push(encodeURIComponent(String(n)).replace(/%25([0-9a-fA-F]{2})/g,"%$1")),null!=(n=this.m)&&t.push(":",String(n))),(n=this.l)&&(this.i&&"/"!=n.charAt(0)&&t.push("/"),t.push(Uc$1(n,"/"==n.charAt(0)?Wc$1:Xc$1,!0))),(n=this.h.toString())&&t.push("?",n),(n=this.o)&&t.push("#",Uc$1(n,Yc$1)),t.join("")};var Vc$1=/[#\/\?@]/g,Xc$1=/[#\?:]/g,Wc$1=/[#\?]/g,$c$1=/[#\?@]/g,Yc$1=/#/g;function Rc$1(t,e){this.h=this.g=null,this.i=t||null,this.j=!!e}function V(t){t.g||(t.g=new S$1,t.h=0,t.i&&Nc$1(t.i,function(e,n){t.add(decodeURIComponent(e.replace(/\+/g," ")),n)}))}function dd(t,e){V(t),e=W$1(t,e),T(t.g.h,e)&&(t.i=null,t.h-=t.g.get(e).length,T((t=t.g).h,e)&&(delete t.h[e],t.i--,t.g.length>2*t.i&&Lc$1(t)))}function ed(t,e){return V(t),e=W$1(t,e),T(t.g.h,e)}function mc$1(t,e,n){dd(t,e),0<n.length&&(t.i=null,t.g.set(W$1(t,e),ra$1(n)),t.h+=n.length)}function W$1(t,e){return e=String(e),t.j&&(e=e.toLowerCase()),e}function Zc$1(t,e){e&&!t.j&&(V(t),t.i=null,t.g.forEach(function(t,e){var n=e.toLowerCase();e!=n&&(dd(this,e),mc$1(this,n,t))},t)),t.j=e}(k$1=Rc$1.prototype).add=function(t,e){V(this),this.i=null,t=W$1(this,t);var n=this.g.get(t);return n||this.g.set(t,n=[]),n.push(e),this.h+=1,this},k$1.forEach=function(t,e){V(this),this.g.forEach(function(n,r){na$1(n,function(n){t.call(e,n,r,this)},this)},this)},k$1.T=function(){V(this);for(var t=this.g.R(),e=this.g.T(),n=[],r=0;r<e.length;r++)for(var s=t[r],i=0;i<s.length;i++)n.push(e[r]);return n},k$1.R=function(t){V(this);var e=[];if("string"==typeof t)ed(this,t)&&(e=qa$1(e,this.g.get(W$1(this,t))));else{t=this.g.R();for(var n=0;n<t.length;n++)e=qa$1(e,t[n])}return e},k$1.set=function(t,e){return V(this),this.i=null,ed(this,t=W$1(this,t))&&(this.h-=this.g.get(t).length),this.g.set(t,[e]),this.h+=1,this},k$1.get=function(t,e){return t&&0<(t=this.R(t)).length?String(t[0]):e},k$1.toString=function(){if(this.i)return this.i;if(!this.g)return"";for(var t=[],e=this.g.T(),n=0;n<e.length;n++){var r=e[n],s=encodeURIComponent(String(r));r=this.R(r);for(var i=0;i<r.length;i++){var o=s;""!==r[i]&&(o+="="+encodeURIComponent(String(r[i]))),t.push(o)}}return this.i=t.join("&")};var fd=function(){return function(t,e){this.h=t,this.g=e}}();function gd(t){this.l=t||hd,l.PerformanceNavigationTiming?t=0<(t=l.performance.getEntriesByType("navigation")).length&&("hq"==t[0].nextHopProtocol||"h2"==t[0].nextHopProtocol):t=!!(l.g&&l.g.Ea&&l.g.Ea()&&l.g.Ea().Zb),this.j=t?this.l:1,this.g=null,1<this.j&&(this.g=new Set),this.h=null,this.i=[]}var hd=10;function id(t){return!!t.h||!!t.g&&t.g.size>=t.j}function Cc$1(t){return t.h?1:t.g?t.g.size:0}function yc$1(t,e){return t.h?t.h==e:!!t.g&&t.g.has(e)}function Dc$1(t,e){t.g?t.g.add(e):t.h=e}function Fc$1(t,e){t.h&&t.h==e?t.h=null:t.g&&t.g.has(e)&&t.g.delete(e)}function jd(t){var e,n;if(null!=t.h)return t.i.concat(t.h.D);if(null!=t.g&&0!==t.g.size){var r=t.i;try{for(var s=__values(t.g.values()),i=s.next();!i.done;i=s.next()){var o=i.value;r=r.concat(o.D)}}catch(t){e={error:t}}finally{try{i&&!i.done&&(n=s.return)&&n.call(s)}finally{if(e)throw e.error}}return r}return ra$1(t.i)}function kd(){}function ld(){this.g=new kd}function md(t,e,n){var r=n||"";try{Kc$1(t,function(t,n){var s=t;p(t)&&(s=rb(t)),e.push(r+n+"="+encodeURIComponent(s))})}catch(t){throw e.push(r+"type="+encodeURIComponent("_badmap")),t}}function nd(t,e){var n=new Mb;if(l.Image){var r=new Image;r.onload=ja$1(od,n,r,"TestLoadImage: loaded",!0,e),r.onerror=ja$1(od,n,r,"TestLoadImage: error",!1,e),r.onabort=ja$1(od,n,r,"TestLoadImage: abort",!1,e),r.ontimeout=ja$1(od,n,r,"TestLoadImage: timeout",!1,e),l.setTimeout(function(){r.ontimeout&&r.ontimeout()},1e4),r.src=t}else e(!1)}function od(t,e,n,r,s){try{e.onload=null,e.onerror=null,e.onabort=null,e.ontimeout=null,s(r)}catch(t){}}function pd(t){this.l=t.$b||null,this.j=t.ib||!1}function qd(t,e){C$1.call(this),this.D=t,this.u=e,this.m=void 0,this.readyState=rd,this.status=0,this.responseType=this.responseText=this.response=this.statusText="",this.onreadystatechange=null,this.v=new Headers,this.h=null,this.C="GET",this.B="",this.g=!1,this.A=this.j=this.l=null}gd.prototype.cancel=function(){var t,e;if(this.i=jd(this),this.h)this.h.cancel(),this.h=null;else if(this.g&&0!==this.g.size){try{for(var n=__values(this.g.values()),r=n.next();!r.done;r=n.next()){r.value.cancel()}}catch(e){t={error:e}}finally{try{r&&!r.done&&(e=n.return)&&e.call(n)}finally{if(t)throw t.error}}this.g.clear()}},kd.prototype.stringify=function(t){return l.JSON.stringify(t,void 0)},kd.prototype.parse=function(t){return l.JSON.parse(t,void 0)},t(pd,Yb),pd.prototype.g=function(){return new qd(this.l,this.j)},pd.prototype.i=function(t){return function(){return t}}({}),t(qd,C$1);var rd=0;function ud(t){t.j.read().then(t.Sa.bind(t)).catch(t.ha.bind(t))}function td(t){t.readyState=4,t.l=null,t.j=null,t.A=null,sd(t)}function sd(t){t.onreadystatechange&&t.onreadystatechange.call(t)}(k$1=qd.prototype).open=function(t,e){if(this.readyState!=rd)throw this.abort(),Error("Error reopening a connection");this.C=t,this.B=e,this.readyState=1,sd(this)},k$1.send=function(t){if(1!=this.readyState)throw this.abort(),Error("need to call open() first. ");this.g=!0;var e={headers:this.v,method:this.C,credentials:this.m,cache:void 0};t&&(e.body=t),(this.D||l).fetch(new Request(this.B,e)).then(this.Va.bind(this),this.ha.bind(this))},k$1.abort=function(){this.response=this.responseText="",this.v=new Headers,this.status=0,this.j&&this.j.cancel("Request was aborted."),1<=this.readyState&&this.g&&4!=this.readyState&&(this.g=!1,td(this)),this.readyState=rd},k$1.Va=function(t){if(this.g&&(this.l=t,this.h||(this.status=this.l.status,this.statusText=this.l.statusText,this.h=t.headers,this.readyState=2,sd(this)),this.g&&(this.readyState=3,sd(this),this.g)))if("arraybuffer"===this.responseType)t.arrayBuffer().then(this.Ta.bind(this),this.ha.bind(this));else if(void 0!==l.ReadableStream&&"body"in t){if(this.j=t.body.getReader(),this.u){if(this.responseType)throw Error('responseType must be empty for "streamBinaryChunks" mode responses.');this.response=[]}else this.response=this.responseText="",this.A=new TextDecoder;ud(this)}else t.text().then(this.Ua.bind(this),this.ha.bind(this))},k$1.Sa=function(t){if(this.g){if(this.u&&t.value)this.response.push(t.value);else if(!this.u){var e=t.value?t.value:new Uint8Array(0);(e=this.A.decode(e,{stream:!t.done}))&&(this.response=this.responseText+=e)}t.done?td(this):sd(this),3==this.readyState&&ud(this)}},k$1.Ua=function(t){this.g&&(this.response=this.responseText=t,td(this))},k$1.Ta=function(t){this.g&&(this.response=t,td(this))},k$1.ha=function(){this.g&&td(this)},k$1.setRequestHeader=function(t,e){this.v.append(t,e)},k$1.getResponseHeader=function(t){return this.h&&this.h.get(t.toLowerCase())||""},k$1.getAllResponseHeaders=function(){if(!this.h)return"";for(var t=[],e=this.h.entries(),n=e.next();!n.done;)n=n.value,t.push(n[0]+": "+n[1]),n=e.next();return t.join("\r\n")},Object.defineProperty(qd.prototype,"withCredentials",{get:function(){return"include"===this.m},set:function(t){this.m=t?"include":"same-origin"}});var vd=l.JSON.parse;function X$1(t){C$1.call(this),this.headers=new S$1,this.u=t||null,this.h=!1,this.C=this.g=null,this.H="",this.m=0,this.j="",this.l=this.F=this.v=this.D=!1,this.B=0,this.A=null,this.J=wd,this.K=this.L=!1}t(X$1,C$1);var wd="",xd=/^https?$/i,yd=["POST","PUT"];function Bd(t){return y&&Ra$1()&&"number"==typeof t.timeout&&void 0!==t.ontimeout}function pa$1(t){return"content-type"==t.toLowerCase()}function zd(t,e){t.h=!1,t.g&&(t.l=!0,t.g.abort(),t.l=!1),t.j=e,t.m=5,Cd(t),Dd(t)}function Cd(t){t.D||(t.D=!0,D$1(t,"complete"),D$1(t,"error"))}function Ed(t){if(t.h&&void 0!==goog&&(!t.C[1]||4!=O$1(t)||2!=t.ba()))if(t.v&&4==O$1(t))Gb(t.Fa,0,t);else if(D$1(t,"readystatechange"),4==O$1(t)){t.h=!1;try{var e,n=t.ba();t:switch(n){case 200:case 201:case 202:case 204:case 206:case 304:case 1223:var r=!0;break t;default:r=!1}if(!(e=r)){var s;if(s=0===n){var i=String(t.H).match(Mc$1)[1]||null;if(!i&&l.self&&l.self.location){var o=l.self.location.protocol;i=o.substr(0,o.length-1)}s=!xd.test(i?i.toLowerCase():"")}e=s}if(e)D$1(t,"complete"),D$1(t,"success");else{t.m=6;try{var a=2<O$1(t)?t.g.statusText:""}catch(t){a=""}t.j=a+" ["+t.ba()+"]",Cd(t)}}finally{Dd(t)}}}function Dd(t,e){if(t.g){Ad(t);var n=t.g,r=t.C[0]?aa$1:null;t.g=null,t.C=null,e||D$1(t,"ready");try{n.onreadystatechange=r}catch(t){}}}function Ad(t){t.g&&t.K&&(t.g.ontimeout=null),t.A&&(l.clearTimeout(t.A),t.A=null)}function O$1(t){return t.g?t.g.readyState:0}function oc$1(t){try{if(!t.g)return null;if("response"in t.g)return t.g.response;switch(t.J){case wd:case"text":return t.g.responseText;case"arraybuffer":if("mozResponseArrayBuffer"in t.g)return t.g.mozResponseArrayBuffer}return null}catch(t){return null}}function Fd(t){var e="";return xa$1(t,function(t,n){e+=n,e+=":",e+=t,e+="\r\n"}),e}function Gd(t,e,n){t:{for(r in n){var r=!1;break t}r=!0}r||(n=Fd(n),"string"==typeof t?null!=n&&encodeURIComponent(String(n)):R(t,e,n))}function Hd(t,e,n){return n&&n.internalChannelParams&&n.internalChannelParams[t]||e}function Id(t){this.za=0,this.l=[],this.h=new Mb,this.la=this.oa=this.F=this.W=this.g=this.sa=this.D=this.aa=this.o=this.P=this.s=null,this.Za=this.V=0,this.Xa=Hd("failFast",!1,t),this.N=this.v=this.u=this.m=this.j=null,this.X=!0,this.I=this.ta=this.U=-1,this.Y=this.A=this.C=0,this.Pa=Hd("baseRetryDelayMs",5e3,t),this.$a=Hd("retryDelaySeedMs",1e4,t),this.Ya=Hd("forwardChannelMaxRetries",2,t),this.ra=Hd("forwardChannelRequestTimeoutMs",2e4,t),this.qa=t&&t.xmlHttpFactory||void 0,this.Ba=t&&t.Yb||!1,this.K=void 0,this.H=t&&t.supportsCrossDomainXhr||!1,this.J="",this.i=new gd(t&&t.concurrentRequestLimit),this.Ca=new ld,this.ja=t&&t.fastHandshake||!1,this.Ra=t&&t.Wb||!1,t&&t.Aa&&this.h.Aa(),t&&t.forceLongPolling&&(this.X=!1),this.$=!this.ja&&this.X&&t&&t.detectBufferingProxy||!1,this.ka=void 0,this.O=0,this.L=!1,this.B=null,this.Wa=!t||!1!==t.Xb}function Ic$1(t){if(Jd(t),3==t.G){var e=t.V++,n=N$1(t.F);R(n,"SID",t.J),R(n,"RID",e),R(n,"TYPE","terminate"),Kd(t,n),(e=new M$1(t,t.h,e,void 0)).K=2,e.v=jc$1(N$1(n)),n=!1,l.navigator&&l.navigator.sendBeacon&&(n=l.navigator.sendBeacon(e.v.toString(),"")),!n&&l.Image&&((new Image).src=e.v,n=!0),n||(e.g=nc$1(e.l,null),e.g.ea(e.v)),e.F=Date.now(),lc$1(e)}Ld(t)}function Ac$1(t){t.g&&(wc$1(t),t.g.cancel(),t.g=null)}function Jd(t){Ac$1(t),t.u&&(l.clearTimeout(t.u),t.u=null),zc$1(t),t.i.cancel(),t.m&&("number"==typeof t.m&&l.clearTimeout(t.m),t.m=null)}function Md(t,e){t.l.push(new fd(t.Za++,e)),3==t.G&&Hc$1(t)}function Hc$1(t){id(t.i)||t.m||(t.m=!0,zb(t.Ha,t),t.C=0)}function Nd(t,e){return!(Cc$1(t.i)>=t.i.j-(t.m?1:0))&&(t.m?(t.l=e.D.concat(t.l),!0):!(1==t.G||2==t.G||t.C>=(t.Xa?0:t.Ya))&&(t.m=K$1(q$1(t.Ha,t,e),Od(t,t.C)),t.C++,!0))}function Qd(t,e){var n;n=e?e.m:t.V++;var r=N$1(t.F);R(r,"SID",t.J),R(r,"RID",n),R(r,"AID",t.U),Kd(t,r),t.o&&t.s&&Gd(r,t.o,t.s),n=new M$1(t,t.h,n,t.C+1),null===t.o&&(n.H=t.s),e&&(t.l=e.D.concat(t.l)),e=Pd(t,n,1e3),n.setTimeout(Math.round(.5*t.ra)+Math.round(.5*t.ra*Math.random())),Dc$1(t.i,n),ic$1(n,r,e)}function Kd(t,e){t.j&&Kc$1({},function(t,n){R(e,n,t)})}function Pd(t,e,n){n=Math.min(t.l.length,n);var r=t.j?q$1(t.j.Oa,t.j,t):null;t:for(var s=t.l,i=-1;;){var o=["count="+n];-1==i?0<n?(i=s[0].h,o.push("ofs="+i)):i=0:o.push("ofs="+i);for(var a=!0,c=0;c<n;c++){var u=s[c].h,h=s[c].g;if(0>(u-=i))i=Math.max(0,s[c].h-100),a=!1;else try{md(h,o,"req"+u+"_")}catch(t){r&&r(h)}}if(a){r=o.join("&");break t}}return t=t.l.splice(0,n),e.D=t,r}function Gc$1(t){t.g||t.u||(t.Y=1,zb(t.Ga,t),t.A=0)}function Bc$1(t){return!(t.g||t.u||3<=t.A)&&(t.Y++,t.u=K$1(q$1(t.Ga,t),Od(t,t.A)),t.A++,!0)}function wc$1(t){null!=t.B&&(l.clearTimeout(t.B),t.B=null)}function Rd(t){t.g=new M$1(t,t.h,"rpc",t.Y),null===t.o&&(t.g.H=t.s),t.g.O=0;var e=N$1(t.oa);R(e,"RID","rpc"),R(e,"SID",t.J),R(e,"CI",t.N?"0":"1"),R(e,"AID",t.U),Kd(t,e),R(e,"TYPE","xmlhttp"),t.o&&t.s&&Gd(e,t.o,t.s),t.K&&t.g.setTimeout(t.K);var n=t.g;t=t.la,n.K=1,n.v=jc$1(N$1(e)),n.s=null,n.U=!0,kc$1(n,t)}function zc$1(t){null!=t.v&&(l.clearTimeout(t.v),t.v=null)}function uc$1(t,e){var n=null;if(t.g==e){zc$1(t),wc$1(t),t.g=null;var r=2}else{if(!yc$1(t.i,e))return;n=e.D,Fc$1(t.i,e),r=1}if(t.I=e.N,0!=t.G)if(e.i)if(1==r){n=e.s?e.s.length:0,e=Date.now()-e.F;var s=t.C;D$1(r=Sb(),new Vb(r,n,e,s)),Hc$1(t)}else Gc$1(t);else if(3==(s=e.o)||0==s&&0<t.I||!(1==r&&Nd(t,e)||2==r&&Bc$1(t)))switch(n&&0<n.length&&(e=t.i,e.i=e.i.concat(n)),s){case 1:Q$1(t,5);break;case 4:Q$1(t,10);break;case 3:Q$1(t,6);break;default:Q$1(t,2)}}function Od(t,e){var n=t.Pa+Math.floor(Math.random()*t.$a);return t.j||(n*=2),n*e}function Q$1(t,e){if(t.h.info("Error code "+e),2==e){var n=null;t.j&&(n=null);var r=q$1(t.jb,t);n||(n=new U$1("//www.google.com/images/cleardot.gif"),l.location&&"http"==l.location.protocol||Oc$1(n,"https"),jc$1(n)),nd(n.toString(),r)}else J$1(2);t.G=0,t.j&&t.j.va(e),Ld(t),Jd(t)}function Ld(t){t.G=0,t.I=-1,t.j&&(0==jd(t.i).length&&0==t.l.length||(t.i.i.length=0,ra$1(t.l),t.l.length=0),t.j.ua())}function Ec$1(t,e,n){var r=ad(n);if(""!=r.i)e&&Pc$1(r,e+"."+r.i),Qc$1(r,r.m);else{var s=l.location;r=bd(s.protocol,e?e+"."+s.hostname:s.hostname,+s.port,n)}return t.aa&&xa$1(t.aa,function(t,e){R(r,e,t)}),e=t.D,n=t.sa,e&&n&&R(r,e,n),R(r,"VER",t.ma),Kd(t,r),r}function nc$1(t,e,n){if(e&&!t.H)throw Error("Can't create secondary domain capable XhrIo object.");return(e=n&&t.Ba&&!t.qa?new X$1(new pd({ib:!0})):new X$1(t.qa)).L=t.H,e}function Sd(){}function Td(){if(y&&!(10<=Number(Ua$1)))throw Error("Environmental error: no available transport.")}function Y$1(t,e){C$1.call(this),this.g=new Id(e),this.l=t,this.h=e&&e.messageUrlParams||null,t=e&&e.messageHeaders||null,e&&e.clientProtocolHeaderRequired&&(t?t["X-Client-Protocol"]="webchannel":t={"X-Client-Protocol":"webchannel"}),this.g.s=t,t=e&&e.initMessageHeaders||null,e&&e.messageContentType&&(t?t["X-WebChannel-Content-Type"]=e.messageContentType:t={"X-WebChannel-Content-Type":e.messageContentType}),e&&e.ya&&(t?t["X-WebChannel-Client-Profile"]=e.ya:t={"X-WebChannel-Client-Profile":e.ya}),this.g.P=t,(t=e&&e.httpHeadersOverwriteParam)&&!sa$1(t)&&(this.g.o=t),this.A=e&&e.supportsCrossDomainXhr||!1,this.v=e&&e.sendRawJson||!1,(e=e&&e.httpSessionIdParam)&&!sa$1(e)&&(this.g.D=e,null!==(t=this.h)&&e in t&&(e in(t=this.h)&&delete t[e])),this.j=new Z$1(this)}function Ud(t){ac$1.call(this);var e=t.__sm__;if(e){t:{for(var n in e){t=n;break t}t=void 0}(this.i=t)&&(t=this.i,e=null!==e&&t in e?e[t]:void 0),this.data=e}else this.data=t}function Vd(){bc$1.call(this),this.status=1}function Z$1(t){this.g=t}(k$1=X$1.prototype).ea=function(t,e,n,r){if(this.g)throw Error("[goog.net.XhrIo] Object is active with another request="+this.H+"; newUri="+t);e=e?e.toUpperCase():"GET",this.H=t,this.j="",this.m=0,this.D=!1,this.h=!0,this.g=this.u?this.u.g():cc$1.g(),this.C=this.u?Zb(this.u):Zb(cc$1),this.g.onreadystatechange=q$1(this.Fa,this);try{this.F=!0,this.g.open(e,String(t),!0),this.F=!1}catch(t){return void zd(this,t)}t=n||"";var s=new S$1(this.headers);r&&Kc$1(r,function(t,e){s.set(e,t)}),r=oa$1(s.T()),n=l.FormData&&t instanceof l.FormData,!(0<=ma$1(yd,e))||r||n||s.set("Content-Type","application/x-www-form-urlencoded;charset=utf-8"),s.forEach(function(t,e){this.g.setRequestHeader(e,t)},this),this.J&&(this.g.responseType=this.J),"withCredentials"in this.g&&this.g.withCredentials!==this.L&&(this.g.withCredentials=this.L);try{Ad(this),0<this.B&&((this.K=Bd(this.g))?(this.g.timeout=this.B,this.g.ontimeout=q$1(this.pa,this)):this.A=Gb(this.pa,this.B,this)),this.v=!0,this.g.send(t),this.v=!1}catch(t){zd(this,t)}},k$1.pa=function(){void 0!==goog&&this.g&&(this.j="Timed out after "+this.B+"ms, aborting",this.m=8,D$1(this,"timeout"),this.abort(8))},k$1.abort=function(t){this.g&&this.h&&(this.h=!1,this.l=!0,this.g.abort(),this.l=!1,this.m=t||7,D$1(this,"complete"),D$1(this,"abort"),Dd(this))},k$1.M=function(){this.g&&(this.h&&(this.h=!1,this.l=!0,this.g.abort(),this.l=!1),Dd(this,!0)),X$1.Z.M.call(this)},k$1.Fa=function(){this.s||(this.F||this.v||this.l?Ed(this):this.cb())},k$1.cb=function(){Ed(this)},k$1.ba=function(){try{return 2<O$1(this)?this.g.status:-1}catch(t){return-1}},k$1.ga=function(){try{return this.g?this.g.responseText:""}catch(t){return""}},k$1.Qa=function(t){if(this.g){var e=this.g.responseText;return t&&0==e.indexOf(t)&&(e=e.substring(t.length)),vd(e)}},k$1.Da=function(){return this.m},k$1.La=function(){return"string"==typeof this.j?this.j:String(this.j)},(k$1=Id.prototype).ma=8,k$1.G=1,k$1.hb=function(t){try{this.h.info("Origin Trials invoked: "+t)}catch(t){}},k$1.Ha=function(t){if(this.m)if(this.m=null,1==this.G){if(!t){this.V=Math.floor(1e5*Math.random()),t=this.V++;var e=new M$1(this,this.h,t,void 0),n=this.s;if(this.P&&(n?Aa$1(n=ya$1(n),this.P):n=this.P),null===this.o&&(e.H=n),this.ja)t:{for(var r=0,s=0;s<this.l.length;s++){var i=this.l[s];if(void 0===(i="__data__"in i.g&&"string"==typeof(i=i.g.__data__)?i.length:void 0))break;if(4096<(r+=i)){r=s;break t}if(4096===r||s===this.l.length-1){r=s+1;break t}}r=1e3}else r=1e3;r=Pd(this,e,r),R(s=N$1(this.F),"RID",t),R(s,"CVER",22),this.D&&R(s,"X-HTTP-Session-Id",this.D),Kd(this,s),this.o&&n&&Gd(s,this.o,n),Dc$1(this.i,e),this.Ra&&R(s,"TYPE","init"),this.ja?(R(s,"$req",r),R(s,"SID","null"),e.$=!0,ic$1(e,s,null)):ic$1(e,s,r),this.G=2}}else 3==this.G&&(t?Qd(this,t):0==this.l.length||id(this.i)||Qd(this))},k$1.Ga=function(){if(this.u=null,Rd(this),this.$&&!(this.L||null==this.g||0>=this.O)){var t=2*this.O;this.h.info("BP detection timer enabled: "+t),this.B=K$1(q$1(this.bb,this),t)}},k$1.bb=function(){this.B&&(this.B=null,this.h.info("BP detection timeout reached."),this.h.info("Buffering proxy detected and switch to long-polling!"),this.N=!1,this.L=!0,J$1(10),Ac$1(this),Rd(this))},k$1.ab=function(){null!=this.v&&(this.v=null,Ac$1(this),Bc$1(this),J$1(19))},k$1.jb=function(t){t?(this.h.info("Successfully pinged google.com"),J$1(2)):(this.h.info("Failed to ping google.com"),J$1(1))},(k$1=Sd.prototype).xa=function(){},k$1.wa=function(){},k$1.va=function(){},k$1.ua=function(){},k$1.Oa=function(){},Td.prototype.g=function(t,e){return new Y$1(t,e)},t(Y$1,C$1),Y$1.prototype.m=function(){this.g.j=this.j,this.A&&(this.g.H=!0);var t=this.g,e=this.l,n=this.h||void 0;t.Wa&&(t.h.info("Origin Trials enabled."),zb(q$1(t.hb,t,e))),J$1(0),t.W=e,t.aa=n||{},t.N=t.X,t.F=Ec$1(t,null,t.W),Hc$1(t)},Y$1.prototype.close=function(){Ic$1(this.g)},Y$1.prototype.u=function(t){if("string"==typeof t){var e={};e.__data__=t,Md(this.g,e)}else this.v?((e={}).__data__=rb(t),Md(this.g,e)):Md(this.g,t)},Y$1.prototype.M=function(){this.g.j=null,delete this.j,Ic$1(this.g),delete this.g,Y$1.Z.M.call(this)},t(Ud,ac$1),t(Vd,bc$1),t(Z$1,Sd),Z$1.prototype.xa=function(){D$1(this.g,"a")},Z$1.prototype.wa=function(t){D$1(this.g,new Ud(t))},Z$1.prototype.va=function(t){D$1(this.g,new Vd(t))},Z$1.prototype.ua=function(){D$1(this.g,"b")},Td.prototype.createWebChannel=Td.prototype.g,Y$1.prototype.send=Y$1.prototype.u,Y$1.prototype.open=Y$1.prototype.m,Y$1.prototype.close=Y$1.prototype.close,Wb.NO_ERROR=0,Wb.TIMEOUT=8,Wb.HTTP_ERROR=6,Xb.COMPLETE="complete",$b.EventType=L$1,L$1.OPEN="a",L$1.CLOSE="b",L$1.ERROR="c",L$1.MESSAGE="d",C$1.prototype.listen=C$1.prototype.N,X$1.prototype.listenOnce=X$1.prototype.O,X$1.prototype.getLastError=X$1.prototype.La,X$1.prototype.getLastErrorCode=X$1.prototype.Da,X$1.prototype.getStatus=X$1.prototype.ba,X$1.prototype.getResponseJson=X$1.prototype.Qa,X$1.prototype.getResponseText=X$1.prototype.ga,X$1.prototype.send=X$1.prototype.ea;var createWebChannelTransport=function(){return new Td},getStatEventTarget=function(){return Sb()},ErrorCode=Wb,EventType=Xb,Event=H$1,Stat={rb:0,ub:1,vb:2,Ob:3,Tb:4,Qb:5,Rb:6,Pb:7,Nb:8,Sb:9,PROXY:10,NOPROXY:11,Lb:12,Hb:13,Ib:14,Gb:15,Jb:16,Kb:17,nb:18,mb:19,ob:20},FetchXmlHttpFactory=pd,WebChannel=$b,XhrIo=X$1;class S{constructor(t){this.uid=t}isAuthenticated(){return null!=this.uid}toKey(){return this.isAuthenticated()?"uid:"+this.uid:"anonymous-user"}isEqual(t){return t.uid===this.uid}}S.UNAUTHENTICATED=new S(null),S.GOOGLE_CREDENTIALS=new S("google-credentials-uid"),S.FIRST_PARTY=new S("first-party-uid"),S.MOCK_USER=new S("mock-user");let D="9.0.0";const C=new Logger("@firebase/firestore");function N(){return C.logLevel}function x(t){C.setLogLevel(t)}function k(t,...e){if(C.logLevel<=LogLevel.DEBUG){const n=e.map(F);C.debug(`Firestore (${D}): ${t}`,...n)}}function $(t,...e){if(C.logLevel<=LogLevel.ERROR){const n=e.map(F);C.error(`Firestore (${D}): ${t}`,...n)}}function O(t,...e){if(C.logLevel<=LogLevel.WARN){const n=e.map(F);C.warn(`Firestore (${D}): ${t}`,...n)}}function F(t){if("string"==typeof t)return t;try{return e=t,JSON.stringify(e)}catch(e){return t}var e}function M(t="Unexpected state"){const e=`FIRESTORE (${D}) INTERNAL ASSERTION FAILED: `+t;throw $(e),new Error(e)}function L(t,e){t||M()}function B(t,e){t||M()}function U(t,e){return t}const q={OK:"ok",CANCELLED:"cancelled",UNKNOWN:"unknown",INVALID_ARGUMENT:"invalid-argument",DEADLINE_EXCEEDED:"deadline-exceeded",NOT_FOUND:"not-found",ALREADY_EXISTS:"already-exists",PERMISSION_DENIED:"permission-denied",UNAUTHENTICATED:"unauthenticated",RESOURCE_EXHAUSTED:"resource-exhausted",FAILED_PRECONDITION:"failed-precondition",ABORTED:"aborted",OUT_OF_RANGE:"out-of-range",UNIMPLEMENTED:"unimplemented",INTERNAL:"internal",UNAVAILABLE:"unavailable",DATA_LOSS:"data-loss"};class K extends Error{constructor(t,e){super(e),this.code=t,this.message=e,this.name="FirebaseError",this.toString=(()=>`${this.name}: [code=${this.code}]: ${this.message}`)}}class j{constructor(){this.promise=new Promise((t,e)=>{this.resolve=t,this.reject=e})}}class Q{constructor(t,e){this.user=e,this.type="OAuth",this.authHeaders={},this.authHeaders.Authorization=`Bearer ${t}`}}class W{getToken(){return Promise.resolve(null)}invalidateToken(){}start(t,e){t.enqueueRetryable(()=>e(S.UNAUTHENTICATED))}shutdown(){}}class G{constructor(t){this.token=t,this.changeListener=null}getToken(){return Promise.resolve(this.token)}invalidateToken(){}start(t,e){this.changeListener=e,t.enqueueRetryable(()=>e(this.token.user))}shutdown(){this.changeListener=null}}class z{constructor(t){this.t=t,this.currentUser=S.UNAUTHENTICATED,this.i=0,this.forceRefresh=!1,this.auth=null}start(t,e){let n=this.i;const r=t=>this.i!==n?(n=this.i,e(t)):Promise.resolve();let s=new j;this.o=(()=>{this.i++,this.currentUser=this.u(),s.resolve(),s=new j,t.enqueueRetryable(()=>r(this.currentUser))});const i=e=>{t.enqueueRetryable(async()=>{k("FirebaseCredentialsProvider","Auth detected"),this.auth=e,this.auth.addAuthTokenListener(this.o),await s.promise,await r(this.currentUser)})};this.t.onInit(t=>i(t)),setTimeout(()=>{if(!this.auth){const t=this.t.getImmediate({optional:!0});t?i(t):(k("FirebaseCredentialsProvider","Auth not yet detected"),s.resolve(),s=new j)}},0),t.enqueueRetryable(async()=>{0===this.i&&(await s.promise,await r(this.currentUser))})}getToken(){const t=this.i,e=this.forceRefresh;return this.forceRefresh=!1,this.auth?this.auth.getToken(e).then(e=>this.i!==t?(k("FirebaseCredentialsProvider","getToken aborted due to token change."),this.getToken()):e?(L("string"==typeof e.accessToken),new Q(e.accessToken,this.currentUser)):null):Promise.resolve(null)}invalidateToken(){this.forceRefresh=!0}shutdown(){this.auth&&this.auth.removeAuthTokenListener(this.o)}u(){const t=this.auth&&this.auth.getUid();return L(null===t||"string"==typeof t),new S(t)}}class H{constructor(t,e,n){this.h=t,this.l=e,this.m=n,this.type="FirstParty",this.user=S.FIRST_PARTY}get authHeaders(){const t={"X-Goog-AuthUser":this.l},e=this.h.auth.getAuthHeaderValueForFirstParty([]);return e&&(t.Authorization=e),this.m&&(t["X-Goog-Iam-Authorization-Token"]=this.m),t}}class J{constructor(t,e,n){this.h=t,this.l=e,this.m=n}getToken(){return Promise.resolve(new H(this.h,this.l,this.m))}start(t,e){t.enqueueRetryable(()=>e(S.FIRST_PARTY))}shutdown(){}invalidateToken(){}}class Y{constructor(t,e){this.previousValue=t,e&&(e.sequenceNumberHandler=(t=>this.g(t)),this.p=(t=>e.writeSequenceNumber(t)))}g(t){return this.previousValue=Math.max(t,this.previousValue),this.previousValue}next(){const t=++this.previousValue;return this.p&&this.p(t),t}}function X(t){const e="undefined"!=typeof self&&(self.crypto||self.msCrypto),n=new Uint8Array(t);if(e&&"function"==typeof e.getRandomValues)e.getRandomValues(n);else for(let e=0;e<t;e++)n[e]=Math.floor(256*Math.random());return n}Y.T=-1;class Z{static I(){const t="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789",e=Math.floor(256/t.length)*t.length;let n="";for(;n.length<20;){const r=X(40);for(let s=0;s<r.length;++s)n.length<20&&r[s]<e&&(n+=t.charAt(r[s]%t.length))}return n}}function tt(t,e){return t<e?-1:t>e?1:0}function et(t,e,n){return t.length===e.length&&t.every((t,r)=>n(t,e[r]))}function nt(t){return t+"\0"}class st{constructor(t,e){if(this.seconds=t,this.nanoseconds=e,e<0)throw new K(q.INVALID_ARGUMENT,"Timestamp nanoseconds out of range: "+e);if(e>=1e9)throw new K(q.INVALID_ARGUMENT,"Timestamp nanoseconds out of range: "+e);if(t<-62135596800)throw new K(q.INVALID_ARGUMENT,"Timestamp seconds out of range: "+t);if(t>=253402300800)throw new K(q.INVALID_ARGUMENT,"Timestamp seconds out of range: "+t)}static now(){return st.fromMillis(Date.now())}static fromDate(t){return st.fromMillis(t.getTime())}static fromMillis(t){const e=Math.floor(t/1e3),n=Math.floor(1e6*(t-1e3*e));return new st(e,n)}toDate(){return new Date(this.toMillis())}toMillis(){return 1e3*this.seconds+this.nanoseconds/1e6}_compareTo(t){return this.seconds===t.seconds?tt(this.nanoseconds,t.nanoseconds):tt(this.seconds,t.seconds)}isEqual(t){return t.seconds===this.seconds&&t.nanoseconds===this.nanoseconds}toString(){return"Timestamp(seconds="+this.seconds+", nanoseconds="+this.nanoseconds+")"}toJSON(){return{seconds:this.seconds,nanoseconds:this.nanoseconds}}valueOf(){const t=this.seconds- -62135596800;return String(t).padStart(12,"0")+"."+String(this.nanoseconds).padStart(9,"0")}}class it{constructor(t){this.timestamp=t}static fromTimestamp(t){return new it(t)}static min(){return new it(new st(0,0))}compareTo(t){return this.timestamp._compareTo(t.timestamp)}isEqual(t){return this.timestamp.isEqual(t.timestamp)}toMicroseconds(){return 1e6*this.timestamp.seconds+this.timestamp.nanoseconds/1e3}toString(){return"SnapshotVersion("+this.timestamp.toString()+")"}toTimestamp(){return this.timestamp}}function rt(t){let e=0;for(const n in t)Object.prototype.hasOwnProperty.call(t,n)&&e++;return e}function ot(t,e){for(const n in t)Object.prototype.hasOwnProperty.call(t,n)&&e(n,t[n])}function at(t){for(const e in t)if(Object.prototype.hasOwnProperty.call(t,e))return!1;return!0}class ct{constructor(t,e,n){void 0===e?e=0:e>t.length&&M(),void 0===n?n=t.length-e:n>t.length-e&&M(),this.segments=t,this.offset=e,this.len=n}get length(){return this.len}isEqual(t){return 0===ct.comparator(this,t)}child(t){const e=this.segments.slice(this.offset,this.limit());return t instanceof ct?t.forEach(t=>{e.push(t)}):e.push(t),this.construct(e)}limit(){return this.offset+this.length}popFirst(t){return t=void 0===t?1:t,this.construct(this.segments,this.offset+t,this.length-t)}popLast(){return this.construct(this.segments,this.offset,this.length-1)}firstSegment(){return this.segments[this.offset]}lastSegment(){return this.get(this.length-1)}get(t){return this.segments[this.offset+t]}isEmpty(){return 0===this.length}isPrefixOf(t){if(t.length<this.length)return!1;for(let e=0;e<this.length;e++)if(this.get(e)!==t.get(e))return!1;return!0}isImmediateParentOf(t){if(this.length+1!==t.length)return!1;for(let e=0;e<this.length;e++)if(this.get(e)!==t.get(e))return!1;return!0}forEach(t){for(let e=this.offset,n=this.limit();e<n;e++)t(this.segments[e])}toArray(){return this.segments.slice(this.offset,this.limit())}static comparator(t,e){const n=Math.min(t.length,e.length);for(let r=0;r<n;r++){const n=t.get(r),s=e.get(r);if(n<s)return-1;if(n>s)return 1}return t.length<e.length?-1:t.length>e.length?1:0}}class ut extends ct{construct(t,e,n){return new ut(t,e,n)}canonicalString(){return this.toArray().join("/")}toString(){return this.canonicalString()}static fromString(...t){const e=[];for(const n of t){if(n.indexOf("//")>=0)throw new K(q.INVALID_ARGUMENT,`Invalid segment (${n}). Paths must not contain // in them.`);e.push(...n.split("/").filter(t=>t.length>0))}return new ut(e)}static emptyPath(){return new ut([])}}const ht=/^[_a-zA-Z][_a-zA-Z0-9]*$/;class lt extends ct{construct(t,e,n){return new lt(t,e,n)}static isValidIdentifier(t){return ht.test(t)}canonicalString(){return this.toArray().map(t=>(t=t.replace(/\\/g,"\\\\").replace(/`/g,"\\`"),lt.isValidIdentifier(t)||(t="`"+t+"`"),t)).join(".")}toString(){return this.canonicalString()}isKeyField(){return 1===this.length&&"__name__"===this.get(0)}static keyField(){return new lt(["__name__"])}static fromServerFormat(t){const e=[];let n="",r=0;const s=()=>{if(0===n.length)throw new K(q.INVALID_ARGUMENT,`Invalid field path (${t}). Paths must not be empty, begin with '.', end with '.', or contain '..'`);e.push(n),n=""};let i=!1;for(;r<t.length;){const e=t[r];if("\\"===e){if(r+1===t.length)throw new K(q.INVALID_ARGUMENT,"Path has trailing escape character: "+t);const e=t[r+1];if("\\"!==e&&"."!==e&&"`"!==e)throw new K(q.INVALID_ARGUMENT,"Path has invalid escape sequence: "+t);n+=e,r+=2}else"`"===e?(i=!i,r++):"."!==e||i?(n+=e,r++):(s(),r++)}if(s(),i)throw new K(q.INVALID_ARGUMENT,"Unterminated ` in path: "+t);return new lt(e)}static emptyPath(){return new lt([])}}class ft{constructor(t){this.fields=t,t.sort(lt.comparator)}covers(t){for(const e of this.fields)if(e.isPrefixOf(t))return!0;return!1}isEqual(t){return et(this.fields,t.fields,(t,e)=>t.isEqual(e))}}function dt(){return"undefined"!=typeof atob}class wt{constructor(t){this.binaryString=t}static fromBase64String(t){const e=atob(t);return new wt(e)}static fromUint8Array(t){const e=function(t){let e="";for(let n=0;n<t.length;++n)e+=String.fromCharCode(t[n]);return e}(t);return new wt(e)}toBase64(){return t=this.binaryString,btoa(t);var t}toUint8Array(){return function(t){const e=new Uint8Array(t.length);for(let n=0;n<t.length;n++)e[n]=t.charCodeAt(n);return e}(this.binaryString)}approximateByteSize(){return 2*this.binaryString.length}compareTo(t){return tt(this.binaryString,t.binaryString)}isEqual(t){return this.binaryString===t.binaryString}}wt.EMPTY_BYTE_STRING=new wt("");const _t=new RegExp(/^\d{4}-\d\d-\d\dT\d\d:\d\d:\d\d(?:\.(\d+))?Z$/);function mt(t){if(L(!!t),"string"==typeof t){let e=0;const n=_t.exec(t);if(L(!!n),n[1]){let t=n[1];t=(t+"000000000").substr(0,9),e=Number(t)}const r=new Date(t);return{seconds:Math.floor(r.getTime()/1e3),nanos:e}}return{seconds:gt(t.seconds),nanos:gt(t.nanos)}}function gt(t){return"number"==typeof t?t:"string"==typeof t?Number(t):0}function yt(t){return"string"==typeof t?wt.fromBase64String(t):wt.fromUint8Array(t)}function pt(t){var e,n;return"server_timestamp"===(null===(n=((null===(e=null==t?void 0:t.mapValue)||void 0===e?void 0:e.fields)||{}).__type__)||void 0===n?void 0:n.stringValue)}function Et(t){const e=t.mapValue.fields.__previous_value__;return pt(e)?Et(e):e}function Tt(t){const e=mt(t.mapValue.fields.__local_write_time__.timestampValue);return new st(e.seconds,e.nanos)}function It(t){return null==t}function At(t){return 0===t&&1/t==-1/0}function Rt(t){return"number"==typeof t&&Number.isInteger(t)&&!At(t)&&t<=Number.MAX_SAFE_INTEGER&&t>=Number.MIN_SAFE_INTEGER}class Pt{constructor(t){this.path=t}static fromPath(t){return new Pt(ut.fromString(t))}static fromName(t){return new Pt(ut.fromString(t).popFirst(5))}hasCollectionId(t){return this.path.length>=2&&this.path.get(this.path.length-2)===t}isEqual(t){return null!==t&&0===ut.comparator(this.path,t.path)}toString(){return this.path.toString()}static comparator(t,e){return ut.comparator(t.path,e.path)}static isDocumentKey(t){return t.length%2==0}static fromSegments(t){return new Pt(new ut(t.slice()))}}function bt(t){return"nullValue"in t?0:"booleanValue"in t?1:"integerValue"in t||"doubleValue"in t?2:"timestampValue"in t?3:"stringValue"in t?5:"bytesValue"in t?6:"referenceValue"in t?7:"geoPointValue"in t?8:"arrayValue"in t?9:"mapValue"in t?pt(t)?4:10:M()}function vt(t,e){const n=bt(t);if(n!==bt(e))return!1;switch(n){case 0:return!0;case 1:return t.booleanValue===e.booleanValue;case 4:return Tt(t).isEqual(Tt(e));case 3:return function(t,e){if("string"==typeof t.timestampValue&&"string"==typeof e.timestampValue&&t.timestampValue.length===e.timestampValue.length)return t.timestampValue===e.timestampValue;const n=mt(t.timestampValue),r=mt(e.timestampValue);return n.seconds===r.seconds&&n.nanos===r.nanos}(t,e);case 5:return t.stringValue===e.stringValue;case 6:return function(t,e){return yt(t.bytesValue).isEqual(yt(e.bytesValue))}(t,e);case 7:return t.referenceValue===e.referenceValue;case 8:return function(t,e){return gt(t.geoPointValue.latitude)===gt(e.geoPointValue.latitude)&&gt(t.geoPointValue.longitude)===gt(e.geoPointValue.longitude)}(t,e);case 2:return function(t,e){if("integerValue"in t&&"integerValue"in e)return gt(t.integerValue)===gt(e.integerValue);if("doubleValue"in t&&"doubleValue"in e){const n=gt(t.doubleValue),r=gt(e.doubleValue);return n===r?At(n)===At(r):isNaN(n)&&isNaN(r)}return!1}(t,e);case 9:return et(t.arrayValue.values||[],e.arrayValue.values||[],vt);case 10:return function(t,e){const n=t.mapValue.fields||{},r=e.mapValue.fields||{};if(rt(n)!==rt(r))return!1;for(const t in n)if(n.hasOwnProperty(t)&&(void 0===r[t]||!vt(n[t],r[t])))return!1;return!0}(t,e);default:return M()}}function Vt(t,e){return void 0!==(t.values||[]).find(t=>vt(t,e))}function St(t,e){const n=bt(t),r=bt(e);if(n!==r)return tt(n,r);switch(n){case 0:return 0;case 1:return tt(t.booleanValue,e.booleanValue);case 2:return function(t,e){const n=gt(t.integerValue||t.doubleValue),r=gt(e.integerValue||e.doubleValue);return n<r?-1:n>r?1:n===r?0:isNaN(n)?isNaN(r)?0:-1:1}(t,e);case 3:return Dt(t.timestampValue,e.timestampValue);case 4:return Dt(Tt(t),Tt(e));case 5:return tt(t.stringValue,e.stringValue);case 6:return function(t,e){const n=yt(t),r=yt(e);return n.compareTo(r)}(t.bytesValue,e.bytesValue);case 7:return function(t,e){const n=t.split("/"),r=e.split("/");for(let t=0;t<n.length&&t<r.length;t++){const e=tt(n[t],r[t]);if(0!==e)return e}return tt(n.length,r.length)}(t.referenceValue,e.referenceValue);case 8:return function(t,e){const n=tt(gt(t.latitude),gt(e.latitude));return 0!==n?n:tt(gt(t.longitude),gt(e.longitude))}(t.geoPointValue,e.geoPointValue);case 9:return function(t,e){const n=t.values||[],r=e.values||[];for(let t=0;t<n.length&&t<r.length;++t){const e=St(n[t],r[t]);if(e)return e}return tt(n.length,r.length)}(t.arrayValue,e.arrayValue);case 10:return function(t,e){const n=t.fields||{},r=Object.keys(n),s=e.fields||{},i=Object.keys(s);r.sort(),i.sort();for(let t=0;t<r.length&&t<i.length;++t){const e=tt(r[t],i[t]);if(0!==e)return e;const o=St(n[r[t]],s[i[t]]);if(0!==o)return o}return tt(r.length,i.length)}(t.mapValue,e.mapValue);default:throw M()}}function Dt(t,e){if("string"==typeof t&&"string"==typeof e&&t.length===e.length)return tt(t,e);const n=mt(t),r=mt(e),s=tt(n.seconds,r.seconds);return 0!==s?s:tt(n.nanos,r.nanos)}function Ct(t){return Nt(t)}function Nt(t){return"nullValue"in t?"null":"booleanValue"in t?""+t.booleanValue:"integerValue"in t?""+t.integerValue:"doubleValue"in t?""+t.doubleValue:"timestampValue"in t?function(t){const e=mt(t);return`time(${e.seconds},${e.nanos})`}(t.timestampValue):"stringValue"in t?t.stringValue:"bytesValue"in t?yt(t.bytesValue).toBase64():"referenceValue"in t?(n=t.referenceValue,Pt.fromName(n).toString()):"geoPointValue"in t?`geo(${(e=t.geoPointValue).latitude},${e.longitude})`:"arrayValue"in t?function(t){let e="[",n=!0;for(const r of t.values||[])n?n=!1:e+=",",e+=Nt(r);return e+"]"}(t.arrayValue):"mapValue"in t?function(t){const e=Object.keys(t.fields||{}).sort();let n="{",r=!0;for(const s of e)r?r=!1:n+=",",n+=`${s}:${Nt(t.fields[s])}`;return n+"}"}(t.mapValue):M();var e,n}function xt(t,e){return{referenceValue:`projects/${t.projectId}/databases/${t.database}/documents/${e.path.canonicalString()}`}}function kt(t){return!!t&&"integerValue"in t}function $t(t){return!!t&&"arrayValue"in t}function Ot(t){return!!t&&"nullValue"in t}function Ft(t){return!!t&&"doubleValue"in t&&isNaN(Number(t.doubleValue))}function Mt(t){return!!t&&"mapValue"in t}function Lt(t){if(t.geoPointValue)return{geoPointValue:Object.assign({},t.geoPointValue)};if(t.timestampValue&&"object"==typeof t.timestampValue)return{timestampValue:Object.assign({},t.timestampValue)};if(t.mapValue){const e={mapValue:{fields:{}}};return ot(t.mapValue.fields,(t,n)=>e.mapValue.fields[t]=Lt(n)),e}if(t.arrayValue){const e={arrayValue:{values:[]}};for(let n=0;n<(t.arrayValue.values||[]).length;++n)e.arrayValue.values[n]=Lt(t.arrayValue.values[n]);return e}return Object.assign({},t)}class Bt{constructor(t){this.value=t}static empty(){return new Bt({mapValue:{}})}field(t){if(t.isEmpty())return this.value;{let e=this.value;for(let n=0;n<t.length-1;++n)if(!Mt(e=(e.mapValue.fields||{})[t.get(n)]))return null;return(e=(e.mapValue.fields||{})[t.lastSegment()])||null}}set(t,e){this.getFieldsMap(t.popLast())[t.lastSegment()]=Lt(e)}setAll(t){let e=lt.emptyPath(),n={},r=[];t.forEach((t,s)=>{if(!e.isImmediateParentOf(s)){const t=this.getFieldsMap(e);this.applyChanges(t,n,r),n={},r=[],e=s.popLast()}t?n[s.lastSegment()]=Lt(t):r.push(s.lastSegment())});const s=this.getFieldsMap(e);this.applyChanges(s,n,r)}delete(t){const e=this.field(t.popLast());Mt(e)&&e.mapValue.fields&&delete e.mapValue.fields[t.lastSegment()]}isEqual(t){return vt(this.value,t.value)}getFieldsMap(t){let e=this.value;e.mapValue.fields||(e.mapValue={fields:{}});for(let n=0;n<t.length;++n){let r=e.mapValue.fields[t.get(n)];Mt(r)&&r.mapValue.fields||(r={mapValue:{fields:{}}},e.mapValue.fields[t.get(n)]=r),e=r}return e.mapValue.fields}applyChanges(t,e,n){ot(e,(e,n)=>t[e]=n);for(const e of n)delete t[e]}clone(){return new Bt(Lt(this.value))}}function Ut(t){const e=[];return ot(t.fields,(t,n)=>{const r=new lt([t]);if(Mt(n)){const t=Ut(n.mapValue).fields;if(0===t.length)e.push(r);else for(const n of t)e.push(r.child(n))}else e.push(r)}),new ft(e)}class qt{constructor(t,e,n,r,s){this.key=t,this.documentType=e,this.version=n,this.data=r,this.documentState=s}static newInvalidDocument(t){return new qt(t,0,it.min(),Bt.empty(),0)}static newFoundDocument(t,e,n){return new qt(t,1,e,n,0)}static newNoDocument(t,e){return new qt(t,2,e,Bt.empty(),0)}static newUnknownDocument(t,e){return new qt(t,3,e,Bt.empty(),2)}convertToFoundDocument(t,e){return this.version=t,this.documentType=1,this.data=e,this.documentState=0,this}convertToNoDocument(t){return this.version=t,this.documentType=2,this.data=Bt.empty(),this.documentState=0,this}convertToUnknownDocument(t){return this.version=t,this.documentType=3,this.data=Bt.empty(),this.documentState=2,this}setHasCommittedMutations(){return this.documentState=2,this}setHasLocalMutations(){return this.documentState=1,this}get hasLocalMutations(){return 1===this.documentState}get hasCommittedMutations(){return 2===this.documentState}get hasPendingWrites(){return this.hasLocalMutations||this.hasCommittedMutations}isValidDocument(){return 0!==this.documentType}isFoundDocument(){return 1===this.documentType}isNoDocument(){return 2===this.documentType}isUnknownDocument(){return 3===this.documentType}isEqual(t){return t instanceof qt&&this.key.isEqual(t.key)&&this.version.isEqual(t.version)&&this.documentType===t.documentType&&this.documentState===t.documentState&&this.data.isEqual(t.data)}clone(){return new qt(this.key,this.documentType,this.version,this.data.clone(),this.documentState)}toString(){return`Document(${this.key}, ${this.version}, ${JSON.stringify(this.data.value)}, {documentType: ${this.documentType}}), {documentState: ${this.documentState}})`}}class Kt{constructor(t,e=null,n=[],r=[],s=null,i=null,o=null){this.path=t,this.collectionGroup=e,this.orderBy=n,this.filters=r,this.limit=s,this.startAt=i,this.endAt=o,this.A=null}}function jt(t,e=null,n=[],r=[],s=null,i=null,o=null){return new Kt(t,e,n,r,s,i,o)}function Qt(t){const e=U(t);if(null===e.A){let t=e.path.canonicalString();null!==e.collectionGroup&&(t+="|cg:"+e.collectionGroup),t+="|f:",t+=e.filters.map(t=>Jt(t)).join(","),t+="|ob:",t+=e.orderBy.map(t=>(function(t){return t.field.canonicalString()+t.dir})(t)).join(","),It(e.limit)||(t+="|l:",t+=e.limit),e.startAt&&(t+="|lb:",t+=oe(e.startAt)),e.endAt&&(t+="|ub:",t+=oe(e.endAt)),e.A=t}return e.A}function Wt(t){let e=t.path.canonicalString();return null!==t.collectionGroup&&(e+=" collectionGroup="+t.collectionGroup),t.filters.length>0&&(e+=`, filters: [${t.filters.map(t=>{return`${(e=t).field.canonicalString()} ${e.op} ${Ct(e.value)}`;var e}).join(", ")}]`),It(t.limit)||(e+=", limit: "+t.limit),t.orderBy.length>0&&(e+=`, orderBy: [${t.orderBy.map(t=>(function(t){return`${t.field.canonicalString()} (${t.dir})`})(t)).join(", ")}]`),t.startAt&&(e+=", startAt: "+oe(t.startAt)),t.endAt&&(e+=", endAt: "+oe(t.endAt)),`Target(${e})`}function Gt(t,e){if(t.limit!==e.limit)return!1;if(t.orderBy.length!==e.orderBy.length)return!1;for(let n=0;n<t.orderBy.length;n++)if(!ce(t.orderBy[n],e.orderBy[n]))return!1;if(t.filters.length!==e.filters.length)return!1;for(let s=0;s<t.filters.length;s++)if(n=t.filters[s],r=e.filters[s],n.op!==r.op||!n.field.isEqual(r.field)||!vt(n.value,r.value))return!1;var n,r;return t.collectionGroup===e.collectionGroup&&!!t.path.isEqual(e.path)&&!!he(t.startAt,e.startAt)&&he(t.endAt,e.endAt)}function zt(t){return Pt.isDocumentKey(t.path)&&null===t.collectionGroup&&0===t.filters.length}class Ht extends class{}{constructor(t,e,n){super(),this.field=t,this.op=e,this.value=n}static create(t,e,n){return t.isKeyField()?"in"===e||"not-in"===e?this.R(t,e,n):new Yt(t,e,n):"array-contains"===e?new ee(t,n):"in"===e?new ne(t,n):"not-in"===e?new se(t,n):"array-contains-any"===e?new ie(t,n):new Ht(t,e,n)}static R(t,e,n){return"in"===e?new Xt(t,n):new Zt(t,n)}matches(t){const e=t.data.field(this.field);return"!="===this.op?null!==e&&this.P(St(e,this.value)):null!==e&&bt(this.value)===bt(e)&&this.P(St(e,this.value))}P(t){switch(this.op){case"<":return t<0;case"<=":return t<=0;case"==":return 0===t;case"!=":return 0!==t;case">":return t>0;case">=":return t>=0;default:return M()}}v(){return["<","<=",">",">=","!=","not-in"].indexOf(this.op)>=0}}function Jt(t){return t.field.canonicalString()+t.op.toString()+Ct(t.value)}class Yt extends Ht{constructor(t,e,n){super(t,e,n),this.key=Pt.fromName(n.referenceValue)}matches(t){const e=Pt.comparator(t.key,this.key);return this.P(e)}}class Xt extends Ht{constructor(t,e){super(t,"in",e),this.keys=te("in",e)}matches(t){return this.keys.some(e=>e.isEqual(t.key))}}class Zt extends Ht{constructor(t,e){super(t,"not-in",e),this.keys=te("not-in",e)}matches(t){return!this.keys.some(e=>e.isEqual(t.key))}}function te(t,e){var n;return((null===(n=e.arrayValue)||void 0===n?void 0:n.values)||[]).map(t=>Pt.fromName(t.referenceValue))}class ee extends Ht{constructor(t,e){super(t,"array-contains",e)}matches(t){const e=t.data.field(this.field);return $t(e)&&Vt(e.arrayValue,this.value)}}class ne extends Ht{constructor(t,e){super(t,"in",e)}matches(t){const e=t.data.field(this.field);return null!==e&&Vt(this.value.arrayValue,e)}}class se extends Ht{constructor(t,e){super(t,"not-in",e)}matches(t){if(Vt(this.value.arrayValue,{nullValue:"NULL_VALUE"}))return!1;const e=t.data.field(this.field);return null!==e&&!Vt(this.value.arrayValue,e)}}class ie extends Ht{constructor(t,e){super(t,"array-contains-any",e)}matches(t){const e=t.data.field(this.field);return!(!$t(e)||!e.arrayValue.values)&&e.arrayValue.values.some(t=>Vt(this.value.arrayValue,t))}}class re{constructor(t,e){this.position=t,this.before=e}}function oe(t){return`${t.before?"b":"a"}:${t.position.map(t=>Ct(t)).join(",")}`}class ae{constructor(t,e="asc"){this.field=t,this.dir=e}}function ce(t,e){return t.dir===e.dir&&t.field.isEqual(e.field)}function ue(t,e,n){let r=0;for(let s=0;s<t.position.length;s++){const i=e[s],o=t.position[s];if(r=i.field.isKeyField()?Pt.comparator(Pt.fromName(o.referenceValue),n.key):St(o,n.data.field(i.field)),"desc"===i.dir&&(r*=-1),0!==r)break}return t.before?r<=0:r<0}function he(t,e){if(null===t)return null===e;if(null===e)return!1;if(t.before!==e.before||t.position.length!==e.position.length)return!1;for(let n=0;n<t.position.length;n++)if(!vt(t.position[n],e.position[n]))return!1;return!0}class le{constructor(t,e=null,n=[],r=[],s=null,i="F",o=null,a=null){this.path=t,this.collectionGroup=e,this.explicitOrderBy=n,this.filters=r,this.limit=s,this.limitType=i,this.startAt=o,this.endAt=a,this.V=null,this.S=null,this.startAt,this.endAt}}function fe(t,e,n,r,s,i,o,a){return new le(t,e,n,r,s,i,o,a)}function de(t){return new le(t)}function we(t){return!It(t.limit)&&"F"===t.limitType}function _e(t){return!It(t.limit)&&"L"===t.limitType}function me(t){return t.explicitOrderBy.length>0?t.explicitOrderBy[0].field:null}function ge(t){for(const e of t.filters)if(e.v())return e.field;return null}function ye(t){return null!==t.collectionGroup}function pe(t){const e=U(t);if(null===e.V){e.V=[];const t=ge(e),n=me(e);if(null!==t&&null===n)t.isKeyField()||e.V.push(new ae(t)),e.V.push(new ae(lt.keyField(),"asc"));else{let t=!1;for(const n of e.explicitOrderBy)e.V.push(n),n.field.isKeyField()&&(t=!0);if(!t){const t=e.explicitOrderBy.length>0?e.explicitOrderBy[e.explicitOrderBy.length-1].dir:"asc";e.V.push(new ae(lt.keyField(),t))}}}return e.V}function Ee(t){const e=U(t);if(!e.S)if("F"===e.limitType)e.S=jt(e.path,e.collectionGroup,pe(e),e.filters,e.limit,e.startAt,e.endAt);else{const t=[];for(const n of pe(e)){const e="desc"===n.dir?"asc":"desc";t.push(new ae(n.field,e))}const n=e.endAt?new re(e.endAt.position,!e.endAt.before):null,r=e.startAt?new re(e.startAt.position,!e.startAt.before):null;e.S=jt(e.path,e.collectionGroup,t,e.filters,e.limit,n,r)}return e.S}function Te(t,e,n){return new le(t.path,t.collectionGroup,t.explicitOrderBy.slice(),t.filters.slice(),e,n,t.startAt,t.endAt)}function Ie(t,e){return Gt(Ee(t),Ee(e))&&t.limitType===e.limitType}function Ae(t){return`${Qt(Ee(t))}|lt:${t.limitType}`}function Re(t){return`Query(target=${Wt(Ee(t))}; limitType=${t.limitType})`}function Pe(t,e){return e.isFoundDocument()&&function(t,e){const n=e.key.path;return null!==t.collectionGroup?e.key.hasCollectionId(t.collectionGroup)&&t.path.isPrefixOf(n):Pt.isDocumentKey(t.path)?t.path.isEqual(n):t.path.isImmediateParentOf(n)}(t,e)&&function(t,e){for(const n of t.explicitOrderBy)if(!n.field.isKeyField()&&null===e.data.field(n.field))return!1;return!0}(t,e)&&function(t,e){for(const n of t.filters)if(!n.matches(e))return!1;return!0}(t,e)&&function(t,e){return!(t.startAt&&!ue(t.startAt,pe(t),e))&&(!t.endAt||!ue(t.endAt,pe(t),e))}(t,e)}function be(t){return(e,n)=>{let r=!1;for(const s of pe(t)){const t=ve(s,e,n);if(0!==t)return t;r=r||s.field.isKeyField()}return 0}}function ve(t,e,n){const r=t.field.isKeyField()?Pt.comparator(e.key,n.key):function(t,e,n){const r=e.data.field(t),s=n.data.field(t);return null!==r&&null!==s?St(r,s):M()}(t.field,e,n);switch(t.dir){case"asc":return r;case"desc":return-1*r;default:return M()}}function Ve(t,e){if(t.D){if(isNaN(e))return{doubleValue:"NaN"};if(e===1/0)return{doubleValue:"Infinity"};if(e===-1/0)return{doubleValue:"-Infinity"}}return{doubleValue:At(e)?"-0":e}}function Se(t){return{integerValue:""+t}}function De(t,e){return Rt(e)?Se(e):Ve(t,e)}class Ce{constructor(){this._=void 0}}function Ne(t,e,n){return t instanceof $e?function(t,e){const n={fields:{__type__:{stringValue:"server_timestamp"},__local_write_time__:{timestampValue:{seconds:t.seconds,nanos:t.nanoseconds}}}};return e&&(n.fields.__previous_value__=e),{mapValue:n}}(n,e):t instanceof Oe?Fe(t,e):t instanceof Me?Le(t,e):function(t,e){const n=ke(t,e),r=Ue(n)+Ue(t.C);return kt(n)&&kt(t.C)?Se(r):Ve(t.N,r)}(t,e)}function xe(t,e,n){return t instanceof Oe?Fe(t,e):t instanceof Me?Le(t,e):n}function ke(t,e){return t instanceof Be?kt(n=e)||n&&"doubleValue"in n?e:{integerValue:0}:null;var n}class $e extends Ce{}class Oe extends Ce{constructor(t){super(),this.elements=t}}function Fe(t,e){const n=qe(e);for(const e of t.elements)n.some(t=>vt(t,e))||n.push(e);return{arrayValue:{values:n}}}class Me extends Ce{constructor(t){super(),this.elements=t}}function Le(t,e){let n=qe(e);for(const e of t.elements)n=n.filter(t=>!vt(t,e));return{arrayValue:{values:n}}}class Be extends Ce{constructor(t,e){super(),this.N=t,this.C=e}}function Ue(t){return gt(t.integerValue||t.doubleValue)}function qe(t){return $t(t)&&t.arrayValue.values?t.arrayValue.values.slice():[]}class Ke{constructor(t,e){this.field=t,this.transform=e}}function je(t,e){return t.field.isEqual(e.field)&&function(t,e){return t instanceof Oe&&e instanceof Oe||t instanceof Me&&e instanceof Me?et(t.elements,e.elements,vt):t instanceof Be&&e instanceof Be?vt(t.C,e.C):t instanceof $e&&e instanceof $e}(t.transform,e.transform)}class Qe{constructor(t,e){this.version=t,this.transformResults=e}}class We{constructor(t,e){this.updateTime=t,this.exists=e}static none(){return new We}static exists(t){return new We(void 0,t)}static updateTime(t){return new We(t)}get isNone(){return void 0===this.updateTime&&void 0===this.exists}isEqual(t){return this.exists===t.exists&&(this.updateTime?!!t.updateTime&&this.updateTime.isEqual(t.updateTime):!t.updateTime)}}function Ge(t,e){return void 0!==t.updateTime?e.isFoundDocument()&&e.version.isEqual(t.updateTime):void 0===t.exists||t.exists===e.isFoundDocument()}class ze{}function He(t,e,n){t instanceof tn?function(t,e,n){const r=t.value.clone(),s=sn(t.fieldTransforms,e,n.transformResults);r.setAll(s),e.convertToFoundDocument(n.version,r).setHasCommittedMutations()}(t,e,n):t instanceof en?function(t,e,n){if(!Ge(t.precondition,e))return void e.convertToUnknownDocument(n.version);const r=sn(t.fieldTransforms,e,n.transformResults),s=e.data;s.setAll(nn(t)),s.setAll(r),e.convertToFoundDocument(n.version,s).setHasCommittedMutations()}(t,e,n):function(t,e,n){e.convertToNoDocument(n.version).setHasCommittedMutations()}(0,e,n)}function Je(t,e,n){t instanceof tn?function(t,e,n){if(!Ge(t.precondition,e))return;const r=t.value.clone(),s=rn(t.fieldTransforms,n,e);r.setAll(s),e.convertToFoundDocument(Ze(e),r).setHasLocalMutations()}(t,e,n):t instanceof en?function(t,e,n){if(!Ge(t.precondition,e))return;const r=rn(t.fieldTransforms,n,e),s=e.data;s.setAll(nn(t)),s.setAll(r),e.convertToFoundDocument(Ze(e),s).setHasLocalMutations()}(t,e,n):function(t,e){Ge(t.precondition,e)&&e.convertToNoDocument(it.min())}(t,e)}function Ye(t,e){let n=null;for(const r of t.fieldTransforms){const t=e.data.field(r.field),s=ke(r.transform,t||null);null!=s&&(null==n&&(n=Bt.empty()),n.set(r.field,s))}return n||null}function Xe(t,e){return t.type===e.type&&!!t.key.isEqual(e.key)&&!!t.precondition.isEqual(e.precondition)&&!!function(t,e){return void 0===t&&void 0===e||!(!t||!e)&&et(t,e,(t,e)=>je(t,e))}(t.fieldTransforms,e.fieldTransforms)&&(0===t.type?t.value.isEqual(e.value):1!==t.type||t.data.isEqual(e.data)&&t.fieldMask.isEqual(e.fieldMask))}function Ze(t){return t.isFoundDocument()?t.version:it.min()}class tn extends ze{constructor(t,e,n,r=[]){super(),this.key=t,this.value=e,this.precondition=n,this.fieldTransforms=r,this.type=0}}class en extends ze{constructor(t,e,n,r,s=[]){super(),this.key=t,this.data=e,this.fieldMask=n,this.precondition=r,this.fieldTransforms=s,this.type=1}}function nn(t){const e=new Map;return t.fieldMask.fields.forEach(n=>{if(!n.isEmpty()){const r=t.data.field(n);e.set(n,r)}}),e}function sn(t,e,n){const r=new Map;L(t.length===n.length);for(let s=0;s<n.length;s++){const i=t[s],o=i.transform,a=e.data.field(i.field);r.set(i.field,xe(o,a,n[s]))}return r}function rn(t,e,n){const r=new Map;for(const s of t){const t=s.transform,i=n.data.field(s.field);r.set(s.field,Ne(t,i,e))}return r}class on extends ze{constructor(t,e){super(),this.key=t,this.precondition=e,this.type=2,this.fieldTransforms=[]}}class an extends ze{constructor(t,e){super(),this.key=t,this.precondition=e,this.type=3,this.fieldTransforms=[]}}class cn{constructor(t){this.count=t}}var un,hn;function ln(t){switch(t){case q.OK:return M();case q.CANCELLED:case q.UNKNOWN:case q.DEADLINE_EXCEEDED:case q.RESOURCE_EXHAUSTED:case q.INTERNAL:case q.UNAVAILABLE:case q.UNAUTHENTICATED:return!1;case q.INVALID_ARGUMENT:case q.NOT_FOUND:case q.ALREADY_EXISTS:case q.PERMISSION_DENIED:case q.FAILED_PRECONDITION:case q.ABORTED:case q.OUT_OF_RANGE:case q.UNIMPLEMENTED:case q.DATA_LOSS:return!0;default:return M()}}function fn(t){if(void 0===t)return $("GRPC error has no .code"),q.UNKNOWN;switch(t){case un.OK:return q.OK;case un.CANCELLED:return q.CANCELLED;case un.UNKNOWN:return q.UNKNOWN;case un.DEADLINE_EXCEEDED:return q.DEADLINE_EXCEEDED;case un.RESOURCE_EXHAUSTED:return q.RESOURCE_EXHAUSTED;case un.INTERNAL:return q.INTERNAL;case un.UNAVAILABLE:return q.UNAVAILABLE;case un.UNAUTHENTICATED:return q.UNAUTHENTICATED;case un.INVALID_ARGUMENT:return q.INVALID_ARGUMENT;case un.NOT_FOUND:return q.NOT_FOUND;case un.ALREADY_EXISTS:return q.ALREADY_EXISTS;case un.PERMISSION_DENIED:return q.PERMISSION_DENIED;case un.FAILED_PRECONDITION:return q.FAILED_PRECONDITION;case un.ABORTED:return q.ABORTED;case un.OUT_OF_RANGE:return q.OUT_OF_RANGE;case un.UNIMPLEMENTED:return q.UNIMPLEMENTED;case un.DATA_LOSS:return q.DATA_LOSS;default:return M()}}(hn=un||(un={}))[hn.OK=0]="OK",hn[hn.CANCELLED=1]="CANCELLED",hn[hn.UNKNOWN=2]="UNKNOWN",hn[hn.INVALID_ARGUMENT=3]="INVALID_ARGUMENT",hn[hn.DEADLINE_EXCEEDED=4]="DEADLINE_EXCEEDED",hn[hn.NOT_FOUND=5]="NOT_FOUND",hn[hn.ALREADY_EXISTS=6]="ALREADY_EXISTS",hn[hn.PERMISSION_DENIED=7]="PERMISSION_DENIED",hn[hn.UNAUTHENTICATED=16]="UNAUTHENTICATED",hn[hn.RESOURCE_EXHAUSTED=8]="RESOURCE_EXHAUSTED",hn[hn.FAILED_PRECONDITION=9]="FAILED_PRECONDITION",hn[hn.ABORTED=10]="ABORTED",hn[hn.OUT_OF_RANGE=11]="OUT_OF_RANGE",hn[hn.UNIMPLEMENTED=12]="UNIMPLEMENTED",hn[hn.INTERNAL=13]="INTERNAL",hn[hn.UNAVAILABLE=14]="UNAVAILABLE",hn[hn.DATA_LOSS=15]="DATA_LOSS";class dn{constructor(t,e){this.comparator=t,this.root=e||_n.EMPTY}insert(t,e){return new dn(this.comparator,this.root.insert(t,e,this.comparator).copy(null,null,_n.BLACK,null,null))}remove(t){return new dn(this.comparator,this.root.remove(t,this.comparator).copy(null,null,_n.BLACK,null,null))}get(t){let e=this.root;for(;!e.isEmpty();){const n=this.comparator(t,e.key);if(0===n)return e.value;n<0?e=e.left:n>0&&(e=e.right)}return null}indexOf(t){let e=0,n=this.root;for(;!n.isEmpty();){const r=this.comparator(t,n.key);if(0===r)return e+n.left.size;r<0?n=n.left:(e+=n.left.size+1,n=n.right)}return-1}isEmpty(){return this.root.isEmpty()}get size(){return this.root.size}minKey(){return this.root.minKey()}maxKey(){return this.root.maxKey()}inorderTraversal(t){return this.root.inorderTraversal(t)}forEach(t){this.inorderTraversal((e,n)=>(t(e,n),!1))}toString(){const t=[];return this.inorderTraversal((e,n)=>(t.push(`${e}:${n}`),!1)),`{${t.join(", ")}}`}reverseTraversal(t){return this.root.reverseTraversal(t)}getIterator(){return new wn(this.root,null,this.comparator,!1)}getIteratorFrom(t){return new wn(this.root,t,this.comparator,!1)}getReverseIterator(){return new wn(this.root,null,this.comparator,!0)}getReverseIteratorFrom(t){return new wn(this.root,t,this.comparator,!0)}}class wn{constructor(t,e,n,r){this.isReverse=r,this.nodeStack=[];let s=1;for(;!t.isEmpty();)if(s=e?n(t.key,e):1,r&&(s*=-1),s<0)t=this.isReverse?t.left:t.right;else{if(0===s){this.nodeStack.push(t);break}this.nodeStack.push(t),t=this.isReverse?t.right:t.left}}getNext(){let t=this.nodeStack.pop();const e={key:t.key,value:t.value};if(this.isReverse)for(t=t.left;!t.isEmpty();)this.nodeStack.push(t),t=t.right;else for(t=t.right;!t.isEmpty();)this.nodeStack.push(t),t=t.left;return e}hasNext(){return this.nodeStack.length>0}peek(){if(0===this.nodeStack.length)return null;const t=this.nodeStack[this.nodeStack.length-1];return{key:t.key,value:t.value}}}class _n{constructor(t,e,n,r,s){this.key=t,this.value=e,this.color=null!=n?n:_n.RED,this.left=null!=r?r:_n.EMPTY,this.right=null!=s?s:_n.EMPTY,this.size=this.left.size+1+this.right.size}copy(t,e,n,r,s){return new _n(null!=t?t:this.key,null!=e?e:this.value,null!=n?n:this.color,null!=r?r:this.left,null!=s?s:this.right)}isEmpty(){return!1}inorderTraversal(t){return this.left.inorderTraversal(t)||t(this.key,this.value)||this.right.inorderTraversal(t)}reverseTraversal(t){return this.right.reverseTraversal(t)||t(this.key,this.value)||this.left.reverseTraversal(t)}min(){return this.left.isEmpty()?this:this.left.min()}minKey(){return this.min().key}maxKey(){return this.right.isEmpty()?this.key:this.right.maxKey()}insert(t,e,n){let r=this;const s=n(t,r.key);return(r=s<0?r.copy(null,null,null,r.left.insert(t,e,n),null):0===s?r.copy(null,e,null,null,null):r.copy(null,null,null,null,r.right.insert(t,e,n))).fixUp()}removeMin(){if(this.left.isEmpty())return _n.EMPTY;let t=this;return t.left.isRed()||t.left.left.isRed()||(t=t.moveRedLeft()),(t=t.copy(null,null,null,t.left.removeMin(),null)).fixUp()}remove(t,e){let n,r=this;if(e(t,r.key)<0)r.left.isEmpty()||r.left.isRed()||r.left.left.isRed()||(r=r.moveRedLeft()),r=r.copy(null,null,null,r.left.remove(t,e),null);else{if(r.left.isRed()&&(r=r.rotateRight()),r.right.isEmpty()||r.right.isRed()||r.right.left.isRed()||(r=r.moveRedRight()),0===e(t,r.key)){if(r.right.isEmpty())return _n.EMPTY;n=r.right.min(),r=r.copy(n.key,n.value,null,null,r.right.removeMin())}r=r.copy(null,null,null,null,r.right.remove(t,e))}return r.fixUp()}isRed(){return this.color}fixUp(){let t=this;return t.right.isRed()&&!t.left.isRed()&&(t=t.rotateLeft()),t.left.isRed()&&t.left.left.isRed()&&(t=t.rotateRight()),t.left.isRed()&&t.right.isRed()&&(t=t.colorFlip()),t}moveRedLeft(){let t=this.colorFlip();return t.right.left.isRed()&&(t=(t=(t=t.copy(null,null,null,null,t.right.rotateRight())).rotateLeft()).colorFlip()),t}moveRedRight(){let t=this.colorFlip();return t.left.left.isRed()&&(t=(t=t.rotateRight()).colorFlip()),t}rotateLeft(){const t=this.copy(null,null,_n.RED,null,this.right.left);return this.right.copy(null,null,this.color,t,null)}rotateRight(){const t=this.copy(null,null,_n.RED,this.left.right,null);return this.left.copy(null,null,this.color,null,t)}colorFlip(){const t=this.left.copy(null,null,!this.left.color,null,null),e=this.right.copy(null,null,!this.right.color,null,null);return this.copy(null,null,!this.color,t,e)}checkMaxDepth(){const t=this.check();return Math.pow(2,t)<=this.size+1}check(){if(this.isRed()&&this.left.isRed())throw M();if(this.right.isRed())throw M();const t=this.left.check();if(t!==this.right.check())throw M();return t+(this.isRed()?0:1)}}_n.EMPTY=null,_n.RED=!0,_n.BLACK=!1,_n.EMPTY=new class{constructor(){this.size=0}get key(){throw M()}get value(){throw M()}get color(){throw M()}get left(){throw M()}get right(){throw M()}copy(t,e,n,r,s){return this}insert(t,e,n){return new _n(t,e)}remove(t,e){return this}isEmpty(){return!0}inorderTraversal(t){return!1}reverseTraversal(t){return!1}minKey(){return null}maxKey(){return null}isRed(){return!1}checkMaxDepth(){return!0}check(){return 0}};class mn{constructor(t){this.comparator=t,this.data=new dn(this.comparator)}has(t){return null!==this.data.get(t)}first(){return this.data.minKey()}last(){return this.data.maxKey()}get size(){return this.data.size}indexOf(t){return this.data.indexOf(t)}forEach(t){this.data.inorderTraversal((e,n)=>(t(e),!1))}forEachInRange(t,e){const n=this.data.getIteratorFrom(t[0]);for(;n.hasNext();){const r=n.getNext();if(this.comparator(r.key,t[1])>=0)return;e(r.key)}}forEachWhile(t,e){let n;for(n=void 0!==e?this.data.getIteratorFrom(e):this.data.getIterator();n.hasNext();)if(!t(n.getNext().key))return}firstAfterOrEqual(t){const e=this.data.getIteratorFrom(t);return e.hasNext()?e.getNext().key:null}getIterator(){return new gn(this.data.getIterator())}getIteratorFrom(t){return new gn(this.data.getIteratorFrom(t))}add(t){return this.copy(this.data.remove(t).insert(t,!0))}delete(t){return this.has(t)?this.copy(this.data.remove(t)):this}isEmpty(){return this.data.isEmpty()}unionWith(t){let e=this;return e.size<t.size&&(e=t,t=this),t.forEach(t=>{e=e.add(t)}),e}isEqual(t){if(!(t instanceof mn))return!1;if(this.size!==t.size)return!1;const e=this.data.getIterator(),n=t.data.getIterator();for(;e.hasNext();){const t=e.getNext().key,r=n.getNext().key;if(0!==this.comparator(t,r))return!1}return!0}toArray(){const t=[];return this.forEach(e=>{t.push(e)}),t}toString(){const t=[];return this.forEach(e=>t.push(e)),"SortedSet("+t.toString()+")"}copy(t){const e=new mn(this.comparator);return e.data=t,e}}class gn{constructor(t){this.iter=t}getNext(){return this.iter.getNext().key}hasNext(){return this.iter.hasNext()}}const yn=new dn(Pt.comparator);function pn(){return yn}const En=new dn(Pt.comparator);function Tn(){return En}const In=new dn(Pt.comparator);function An(){return In}const Rn=new mn(Pt.comparator);function Pn(...t){let e=Rn;for(const n of t)e=e.add(n);return e}const bn=new mn(tt);function vn(){return bn}class Vn{constructor(t,e,n,r,s){this.snapshotVersion=t,this.targetChanges=e,this.targetMismatches=n,this.documentUpdates=r,this.resolvedLimboDocuments=s}static createSynthesizedRemoteEventForCurrentChange(t,e){const n=new Map;return n.set(t,Sn.createSynthesizedTargetChangeForCurrentChange(t,e)),new Vn(it.min(),n,vn(),pn(),Pn())}}class Sn{constructor(t,e,n,r,s){this.resumeToken=t,this.current=e,this.addedDocuments=n,this.modifiedDocuments=r,this.removedDocuments=s}static createSynthesizedTargetChangeForCurrentChange(t,e){return new Sn(wt.EMPTY_BYTE_STRING,e,Pn(),Pn(),Pn())}}class Dn{constructor(t,e,n,r){this.k=t,this.removedTargetIds=e,this.key=n,this.$=r}}class Cn{constructor(t,e){this.targetId=t,this.O=e}}class Nn{constructor(t,e,n=wt.EMPTY_BYTE_STRING,r=null){this.state=t,this.targetIds=e,this.resumeToken=n,this.cause=r}}class xn{constructor(){this.F=0,this.M=On(),this.L=wt.EMPTY_BYTE_STRING,this.B=!1,this.U=!0}get current(){return this.B}get resumeToken(){return this.L}get q(){return 0!==this.F}get K(){return this.U}j(t){t.approximateByteSize()>0&&(this.U=!0,this.L=t)}W(){let t=Pn(),e=Pn(),n=Pn();return this.M.forEach((r,s)=>{switch(s){case 0:t=t.add(r);break;case 2:e=e.add(r);break;case 1:n=n.add(r);break;default:M()}}),new Sn(this.L,this.B,t,e,n)}G(){this.U=!1,this.M=On()}H(t,e){this.U=!0,this.M=this.M.insert(t,e)}J(t){this.U=!0,this.M=this.M.remove(t)}Y(){this.F+=1}X(){this.F-=1}Z(){this.U=!0,this.B=!0}}class kn{constructor(t){this.tt=t,this.et=new Map,this.nt=pn(),this.st=$n(),this.it=new mn(tt)}rt(t){for(const e of t.k)t.$&&t.$.isFoundDocument()?this.ot(e,t.$):this.at(e,t.key,t.$);for(const e of t.removedTargetIds)this.at(e,t.key,t.$)}ct(t){this.forEachTarget(t,e=>{const n=this.ut(e);switch(t.state){case 0:this.ht(e)&&n.j(t.resumeToken);break;case 1:n.X(),n.q||n.G(),n.j(t.resumeToken);break;case 2:n.X(),n.q||this.removeTarget(e);break;case 3:this.ht(e)&&(n.Z(),n.j(t.resumeToken));break;case 4:this.ht(e)&&(this.lt(e),n.j(t.resumeToken));break;default:M()}})}forEachTarget(t,e){t.targetIds.length>0?t.targetIds.forEach(e):this.et.forEach((t,n)=>{this.ht(n)&&e(n)})}ft(t){const e=t.targetId,n=t.O.count,r=this.dt(e);if(r){const t=r.target;if(zt(t))if(0===n){const n=new Pt(t.path);this.at(e,n,qt.newNoDocument(n,it.min()))}else L(1===n);else this.wt(e)!==n&&(this.lt(e),this.it=this.it.add(e))}}_t(t){const e=new Map;this.et.forEach((n,r)=>{const s=this.dt(r);if(s){if(n.current&&zt(s.target)){const e=new Pt(s.target.path);null!==this.nt.get(e)||this.gt(r,e)||this.at(r,e,qt.newNoDocument(e,t))}n.K&&(e.set(r,n.W()),n.G())}});let n=Pn();this.st.forEach((t,e)=>{let r=!0;e.forEachWhile(t=>{const e=this.dt(t);return!e||2===e.purpose||(r=!1,!1)}),r&&(n=n.add(t))});const r=new Vn(t,e,this.it,this.nt,n);return this.nt=pn(),this.st=$n(),this.it=new mn(tt),r}ot(t,e){if(!this.ht(t))return;const n=this.gt(t,e.key)?2:0;this.ut(t).H(e.key,n),this.nt=this.nt.insert(e.key,e),this.st=this.st.insert(e.key,this.yt(e.key).add(t))}at(t,e,n){if(!this.ht(t))return;const r=this.ut(t);this.gt(t,e)?r.H(e,1):r.J(e),this.st=this.st.insert(e,this.yt(e).delete(t)),n&&(this.nt=this.nt.insert(e,n))}removeTarget(t){this.et.delete(t)}wt(t){const e=this.ut(t).W();return this.tt.getRemoteKeysForTarget(t).size+e.addedDocuments.size-e.removedDocuments.size}Y(t){this.ut(t).Y()}ut(t){let e=this.et.get(t);return e||(e=new xn,this.et.set(t,e)),e}yt(t){let e=this.st.get(t);return e||(e=new mn(tt),this.st=this.st.insert(t,e)),e}ht(t){const e=null!==this.dt(t);return e||k("WatchChangeAggregator","Detected inactive target",t),e}dt(t){const e=this.et.get(t);return e&&e.q?null:this.tt.Et(t)}lt(t){this.et.set(t,new xn),this.tt.getRemoteKeysForTarget(t).forEach(e=>{this.at(t,e,null)})}gt(t,e){return this.tt.getRemoteKeysForTarget(t).has(e)}}function $n(){return new dn(Pt.comparator)}function On(){return new dn(Pt.comparator)}const Fn={asc:"ASCENDING",desc:"DESCENDING"},Mn={"<":"LESS_THAN","<=":"LESS_THAN_OR_EQUAL",">":"GREATER_THAN",">=":"GREATER_THAN_OR_EQUAL","==":"EQUAL","!=":"NOT_EQUAL","array-contains":"ARRAY_CONTAINS",in:"IN","not-in":"NOT_IN","array-contains-any":"ARRAY_CONTAINS_ANY"};class Ln{constructor(t,e){this.databaseId=t,this.D=e}}function Bn(t,e){return t.D?`${new Date(1e3*e.seconds).toISOString().replace(/\.\d*/,"").replace("Z","")}.${("000000000"+e.nanoseconds).slice(-9)}Z`:{seconds:""+e.seconds,nanos:e.nanoseconds}}function Un(t,e){return t.D?e.toBase64():e.toUint8Array()}function qn(t,e){return Bn(t,e.toTimestamp())}function Kn(t){return L(!!t),it.fromTimestamp(function(t){const e=mt(t);return new st(e.seconds,e.nanos)}(t))}function jn(t,e){return function(t){return new ut(["projects",t.projectId,"databases",t.database])}(t).child("documents").child(e).canonicalString()}function Qn(t){const e=ut.fromString(t);return L(ps(e)),e}function Wn(t,e){return jn(t.databaseId,e.path)}function Gn(t,e){const n=Qn(e);if(n.get(1)!==t.databaseId.projectId)throw new K(q.INVALID_ARGUMENT,"Tried to deserialize key from different project: "+n.get(1)+" vs "+t.databaseId.projectId);if(n.get(3)!==t.databaseId.database)throw new K(q.INVALID_ARGUMENT,"Tried to deserialize key from different database: "+n.get(3)+" vs "+t.databaseId.database);return new Pt(Yn(n))}function zn(t,e){return jn(t.databaseId,e)}function Hn(t){const e=Qn(t);return 4===e.length?ut.emptyPath():Yn(e)}function Jn(t){return new ut(["projects",t.databaseId.projectId,"databases",t.databaseId.database]).canonicalString()}function Yn(t){return L(t.length>4&&"documents"===t.get(4)),t.popFirst(5)}function Xn(t,e,n){return{name:Wn(t,e),fields:n.value.mapValue.fields}}function Zn(t,e,n){const r=Gn(t,e.name),s=Kn(e.updateTime),i=new Bt({mapValue:{fields:e.fields}}),o=qt.newFoundDocument(r,s,i);return n&&o.setHasCommittedMutations(),n?o.setHasCommittedMutations():o}function ts(t,e){return"found"in e?function(t,e){L(!!e.found),e.found.name,e.found.updateTime;const n=Gn(t,e.found.name),r=Kn(e.found.updateTime),s=new Bt({mapValue:{fields:e.found.fields}});return qt.newFoundDocument(n,r,s)}(t,e):"missing"in e?function(t,e){L(!!e.missing),L(!!e.readTime);const n=Gn(t,e.missing),r=Kn(e.readTime);return qt.newNoDocument(n,r)}(t,e):M()}function es(t,e){let n;if("targetChange"in e){e.targetChange;const r=function(t){return"NO_CHANGE"===t?0:"ADD"===t?1:"REMOVE"===t?2:"CURRENT"===t?3:"RESET"===t?4:M()}(e.targetChange.targetChangeType||"NO_CHANGE"),s=e.targetChange.targetIds||[],i=function(t,e){return t.D?(L(void 0===e||"string"==typeof e),wt.fromBase64String(e||"")):(L(void 0===e||e instanceof Uint8Array),wt.fromUint8Array(e||new Uint8Array))}(t,e.targetChange.resumeToken),o=e.targetChange.cause,a=o&&function(t){const e=void 0===t.code?q.UNKNOWN:fn(t.code);return new K(e,t.message||"")}(o);n=new Nn(r,s,i,a||null)}else if("documentChange"in e){e.documentChange;const r=e.documentChange;r.document,r.document.name,r.document.updateTime;const s=Gn(t,r.document.name),i=Kn(r.document.updateTime),o=new Bt({mapValue:{fields:r.document.fields}}),a=qt.newFoundDocument(s,i,o),c=r.targetIds||[],u=r.removedTargetIds||[];n=new Dn(c,u,a.key,a)}else if("documentDelete"in e){e.documentDelete;const r=e.documentDelete;r.document;const s=Gn(t,r.document),i=r.readTime?Kn(r.readTime):it.min(),o=qt.newNoDocument(s,i),a=r.removedTargetIds||[];n=new Dn([],a,o.key,o)}else if("documentRemove"in e){e.documentRemove;const r=e.documentRemove;r.document;const s=Gn(t,r.document),i=r.removedTargetIds||[];n=new Dn([],i,s,null)}else{if(!("filter"in e))return M();{e.filter;const t=e.filter;t.targetId;const r=t.count||0,s=new cn(r),i=t.targetId;n=new Cn(i,s)}}return n}function ns(t,e){let n;if(e instanceof tn)n={update:Xn(t,e.key,e.value)};else if(e instanceof on)n={delete:Wn(t,e.key)};else if(e instanceof en)n={update:Xn(t,e.key,e.data),updateMask:ys(e.fieldMask)};else{if(!(e instanceof an))return M();n={verify:Wn(t,e.key)}}return e.fieldTransforms.length>0&&(n.updateTransforms=e.fieldTransforms.map(t=>(function(t,e){const n=e.transform;if(n instanceof $e)return{fieldPath:e.field.canonicalString(),setToServerValue:"REQUEST_TIME"};if(n instanceof Oe)return{fieldPath:e.field.canonicalString(),appendMissingElements:{values:n.elements}};if(n instanceof Me)return{fieldPath:e.field.canonicalString(),removeAllFromArray:{values:n.elements}};if(n instanceof Be)return{fieldPath:e.field.canonicalString(),increment:n.C};throw M()})(0,t))),e.precondition.isNone||(n.currentDocument=function(t,e){return void 0!==e.updateTime?{updateTime:qn(t,e.updateTime)}:void 0!==e.exists?{exists:e.exists}:M()}(t,e.precondition)),n}function ss(t,e){const n=e.currentDocument?function(t){return void 0!==t.updateTime?We.updateTime(Kn(t.updateTime)):void 0!==t.exists?We.exists(t.exists):We.none()}(e.currentDocument):We.none(),r=e.updateTransforms?e.updateTransforms.map(e=>(function(t,e){let n=null;if("setToServerValue"in e)L("REQUEST_TIME"===e.setToServerValue),n=new $e;else if("appendMissingElements"in e){const t=e.appendMissingElements.values||[];n=new Oe(t)}else if("removeAllFromArray"in e){const t=e.removeAllFromArray.values||[];n=new Me(t)}else"increment"in e?n=new Be(t,e.increment):M();const r=lt.fromServerFormat(e.fieldPath);return new Ke(r,n)})(t,e)):[];if(e.update){e.update.name;const s=Gn(t,e.update.name),i=new Bt({mapValue:{fields:e.update.fields}});if(e.updateMask){const t=function(t){const e=t.fieldPaths||[];return new ft(e.map(t=>lt.fromServerFormat(t)))}(e.updateMask);return new en(s,i,t,n,r)}return new tn(s,i,n,r)}if(e.delete){const r=Gn(t,e.delete);return new on(r,n)}if(e.verify){const r=Gn(t,e.verify);return new an(r,n)}return M()}function is(t,e){return t&&t.length>0?(L(void 0!==e),t.map(t=>(function(t,e){let n=t.updateTime?Kn(t.updateTime):Kn(e);return n.isEqual(it.min())&&(n=Kn(e)),new Qe(n,t.transformResults||[])})(t,e))):[]}function rs(t,e){return{documents:[zn(t,e.path)]}}function os(t,e){const n={structuredQuery:{}},r=e.path;null!==e.collectionGroup?(n.parent=zn(t,r),n.structuredQuery.from=[{collectionId:e.collectionGroup,allDescendants:!0}]):(n.parent=zn(t,r.popLast()),n.structuredQuery.from=[{collectionId:r.lastSegment()}]);const s=function(t){if(0===t.length)return;const e=t.map(t=>(function(t){if("=="===t.op){if(Ft(t.value))return{unaryFilter:{field:ws(t.field),op:"IS_NAN"}};if(Ot(t.value))return{unaryFilter:{field:ws(t.field),op:"IS_NULL"}}}else if("!="===t.op){if(Ft(t.value))return{unaryFilter:{field:ws(t.field),op:"IS_NOT_NAN"}};if(Ot(t.value))return{unaryFilter:{field:ws(t.field),op:"IS_NOT_NULL"}}}return{fieldFilter:{field:ws(t.field),op:ds(t.op),value:t.value}}})(t));return 1===e.length?e[0]:{compositeFilter:{op:"AND",filters:e}}}(e.filters);s&&(n.structuredQuery.where=s);const i=function(t){if(0!==t.length)return t.map(t=>(function(t){return{field:ws(t.field),direction:fs(t.dir)}})(t))}(e.orderBy);i&&(n.structuredQuery.orderBy=i);const o=function(t,e){return t.D||It(e)?e:{value:e}}(t,e.limit);return null!==o&&(n.structuredQuery.limit=o),e.startAt&&(n.structuredQuery.startAt=hs(e.startAt)),e.endAt&&(n.structuredQuery.endAt=hs(e.endAt)),n}function as(t){let e=Hn(t.parent);const n=t.structuredQuery,r=n.from?n.from.length:0;let s=null;if(r>0){L(1===r);const t=n.from[0];t.allDescendants?s=t.collectionId:e=e.child(t.collectionId)}let i=[];n.where&&(i=us(n.where));let o=[];n.orderBy&&(o=n.orderBy.map(t=>(function(t){return new ae(_s(t.field),function(t){switch(t){case"ASCENDING":return"asc";case"DESCENDING":return"desc";default:return}}(t.direction))})(t)));let a=null;n.limit&&(a=function(t){let e;return It(e="object"==typeof t?t.value:t)?null:e}(n.limit));let c=null;n.startAt&&(c=ls(n.startAt));let u=null;return n.endAt&&(u=ls(n.endAt)),fe(e,s,o,i,a,"F",c,u)}function cs(t,e){const n=function(t,e){switch(e){case 0:return null;case 1:return"existence-filter-mismatch";case 2:return"limbo-document";default:return M()}}(0,e.purpose);return null==n?null:{"goog-listen-tags":n}}function us(t){return t?void 0!==t.unaryFilter?[gs(t)]:void 0!==t.fieldFilter?[ms(t)]:void 0!==t.compositeFilter?t.compositeFilter.filters.map(t=>us(t)).reduce((t,e)=>t.concat(e)):M():[]}function hs(t){return{before:t.before,values:t.position}}function ls(t){const e=!!t.before,n=t.values||[];return new re(n,e)}function fs(t){return Fn[t]}function ds(t){return Mn[t]}function ws(t){return{fieldPath:t.canonicalString()}}function _s(t){return lt.fromServerFormat(t.fieldPath)}function ms(t){return Ht.create(_s(t.fieldFilter.field),function(t){switch(t){case"EQUAL":return"==";case"NOT_EQUAL":return"!=";case"GREATER_THAN":return">";case"GREATER_THAN_OR_EQUAL":return">=";case"LESS_THAN":return"<";case"LESS_THAN_OR_EQUAL":return"<=";case"ARRAY_CONTAINS":return"array-contains";case"IN":return"in";case"NOT_IN":return"not-in";case"ARRAY_CONTAINS_ANY":return"array-contains-any";case"OPERATOR_UNSPECIFIED":default:return M()}}(t.fieldFilter.op),t.fieldFilter.value)}function gs(t){switch(t.unaryFilter.op){case"IS_NAN":const e=_s(t.unaryFilter.field);return Ht.create(e,"==",{doubleValue:NaN});case"IS_NULL":const n=_s(t.unaryFilter.field);return Ht.create(n,"==",{nullValue:"NULL_VALUE"});case"IS_NOT_NAN":const r=_s(t.unaryFilter.field);return Ht.create(r,"!=",{doubleValue:NaN});case"IS_NOT_NULL":const s=_s(t.unaryFilter.field);return Ht.create(s,"!=",{nullValue:"NULL_VALUE"});case"OPERATOR_UNSPECIFIED":default:return M()}}function ys(t){const e=[];return t.fields.forEach(t=>e.push(t.canonicalString())),{fieldPaths:e}}function ps(t){return t.length>=4&&"projects"===t.get(0)&&"databases"===t.get(2)}function Es(t){let e="";for(let n=0;n<t.length;n++)e.length>0&&(e=Is(e)),e=Ts(t.get(n),e);return Is(e)}function Ts(t,e){let n=e;const r=t.length;for(let e=0;e<r;e++){const r=t.charAt(e);switch(r){case"\0":n+="";break;case"":n+="";break;default:n+=r}}return n}function Is(t){return t+""}function As(t){const e=t.length;if(L(e>=2),2===e)return L(""===t.charAt(0)&&""===t.charAt(1)),ut.emptyPath();const n=e-2,r=[];let s="";for(let n=0;n<e;){const e=t.indexOf("",n);switch((e<0||e>i)&&M(),t.charAt(e+1)){case"":const i=t.substring(n,e);let o;0===s.length?o=i:(o=s+=i,s=""),r.push(o);break;case"":s+=t.substring(n,e),s+="\0";break;case"":s+=t.substring(n,e+1);break;default:M()}n=e+2}return new ut(r)}class Rs{constructor(t,e){this.seconds=t,this.nanoseconds=e}}class Ps{constructor(t,e,n){this.ownerId=t,this.allowTabSynchronization=e,this.leaseTimestampMs=n}}Ps.store="owner",Ps.key="owner";class bs{constructor(t,e,n){this.userId=t,this.lastAcknowledgedBatchId=e,this.lastStreamToken=n}}bs.store="mutationQueues",bs.keyPath="userId";class vs{constructor(t,e,n,r,s){this.userId=t,this.batchId=e,this.localWriteTimeMs=n,this.baseMutations=r,this.mutations=s}}vs.store="mutations",vs.keyPath="batchId",vs.userMutationsIndex="userMutationsIndex",vs.userMutationsKeyPath=["userId","batchId"];class Vs{constructor(){}static prefixForUser(t){return[t]}static prefixForPath(t,e){return[t,Es(e)]}static key(t,e,n){return[t,Es(e),n]}}Vs.store="documentMutations",Vs.PLACEHOLDER=new Vs;class Ss{constructor(t,e){this.path=t,this.readTime=e}}class Ds{constructor(t,e){this.path=t,this.version=e}}class Cs{constructor(t,e,n,r,s,i){this.unknownDocument=t,this.noDocument=e,this.document=n,this.hasCommittedMutations=r,this.readTime=s,this.parentPath=i}}Cs.store="remoteDocuments",Cs.readTimeIndex="readTimeIndex",Cs.readTimeIndexPath="readTime",Cs.collectionReadTimeIndex="collectionReadTimeIndex",Cs.collectionReadTimeIndexPath=["parentPath","readTime"];class Ns{constructor(t){this.byteSize=t}}Ns.store="remoteDocumentGlobal",Ns.key="remoteDocumentGlobalKey";class xs{constructor(t,e,n,r,s,i,o){this.targetId=t,this.canonicalId=e,this.readTime=n,this.resumeToken=r,this.lastListenSequenceNumber=s,this.lastLimboFreeSnapshotVersion=i,this.query=o}}xs.store="targets",xs.keyPath="targetId",xs.queryTargetsIndexName="queryTargetsIndex",xs.queryTargetsKeyPath=["canonicalId","targetId"];class ks{constructor(t,e,n){this.targetId=t,this.path=e,this.sequenceNumber=n}}ks.store="targetDocuments",ks.keyPath=["targetId","path"],ks.documentTargetsIndex="documentTargetsIndex",ks.documentTargetsKeyPath=["path","targetId"];class $s{constructor(t,e,n,r){this.highestTargetId=t,this.highestListenSequenceNumber=e,this.lastRemoteSnapshotVersion=n,this.targetCount=r}}$s.key="targetGlobalKey",$s.store="targetGlobal";class Os{constructor(t,e){this.collectionId=t,this.parent=e}}Os.store="collectionParents",Os.keyPath=["collectionId","parent"];class Fs{constructor(t,e,n,r){this.clientId=t,this.updateTimeMs=e,this.networkEnabled=n,this.inForeground=r}}Fs.store="clientMetadata",Fs.keyPath="clientId";class Ms{constructor(t,e,n){this.bundleId=t,this.createTime=e,this.version=n}}Ms.store="bundles",Ms.keyPath="bundleId";class Ls{constructor(t,e,n){this.name=t,this.readTime=e,this.bundledQuery=n}}Ls.store="namedQueries",Ls.keyPath="name";const Bs=[bs.store,vs.store,Vs.store,Cs.store,xs.store,Ps.store,$s.store,ks.store,Fs.store,Ns.store,Os.store,Ms.store,Ls.store],Us="The current tab is not in the required state to perform this operation. It might be necessary to refresh the browser tab.";class qs{constructor(){this.onCommittedListeners=[]}addOnCommittedListener(t){this.onCommittedListeners.push(t)}raiseOnCommittedEvent(){this.onCommittedListeners.forEach(t=>t())}}class Ks{constructor(t){this.nextCallback=null,this.catchCallback=null,this.result=void 0,this.error=void 0,this.isDone=!1,this.callbackAttached=!1,t(t=>{this.isDone=!0,this.result=t,this.nextCallback&&this.nextCallback(t)},t=>{this.isDone=!0,this.error=t,this.catchCallback&&this.catchCallback(t)})}catch(t){return this.next(void 0,t)}next(t,e){return this.callbackAttached&&M(),this.callbackAttached=!0,this.isDone?this.error?this.wrapFailure(e,this.error):this.wrapSuccess(t,this.result):new Ks((n,r)=>{this.nextCallback=(e=>{this.wrapSuccess(t,e).next(n,r)}),this.catchCallback=(t=>{this.wrapFailure(e,t).next(n,r)})})}toPromise(){return new Promise((t,e)=>{this.next(t,e)})}wrapUserFunction(t){try{const e=t();return e instanceof Ks?e:Ks.resolve(e)}catch(t){return Ks.reject(t)}}wrapSuccess(t,e){return t?this.wrapUserFunction(()=>t(e)):Ks.resolve(e)}wrapFailure(t,e){return t?this.wrapUserFunction(()=>t(e)):Ks.reject(e)}static resolve(t){return new Ks((e,n)=>{e(t)})}static reject(t){return new Ks((e,n)=>{n(t)})}static waitFor(t){return new Ks((e,n)=>{let r=0,s=0,i=!1;t.forEach(t=>{++r,t.next(()=>{++s,i&&s===r&&e()},t=>n(t))}),i=!0,s===r&&e()})}static or(t){let e=Ks.resolve(!1);for(const n of t)e=e.next(t=>t?Ks.resolve(t):n());return e}static forEach(t,e){const n=[];return t.forEach((t,r)=>{n.push(e.call(this,t,r))}),this.waitFor(n)}}class js{constructor(t,e){this.action=t,this.transaction=e,this.aborted=!1,this.Tt=new j,this.transaction.oncomplete=(()=>{this.Tt.resolve()}),this.transaction.onabort=(()=>{e.error?this.Tt.reject(new Gs(t,e.error)):this.Tt.resolve()}),this.transaction.onerror=(e=>{const n=Xs(e.target.error);this.Tt.reject(new Gs(t,n))})}static open(t,e,n,r){try{return new js(e,t.transaction(r,n))}catch(t){throw new Gs(e,t)}}get It(){return this.Tt.promise}abort(t){t&&this.Tt.reject(t),this.aborted||(k("SimpleDb","Aborting transaction:",t?t.message:"Client-initiated abort"),this.aborted=!0,this.transaction.abort())}store(t){const e=this.transaction.objectStore(t);return new Hs(e)}}class Qs{constructor(t,e,n){this.name=t,this.version=e,this.At=n,12.2===Qs.Rt(getUA())&&$("Firestore persistence suffers from a bug in iOS 12.2 Safari that may cause your app to stop working. See https://stackoverflow.com/q/56496296/110915 for details and a potential workaround.")}static delete(t){return k("SimpleDb","Removing database:",t),Js(window.indexedDB.deleteDatabase(t)).toPromise()}static Pt(){if("undefined"==typeof indexedDB)return!1;if(Qs.bt())return!0;const t=getUA(),e=Qs.Rt(t),n=0<e&&e<10,r=Qs.vt(t),s=0<r&&r<4.5;return!(t.indexOf("MSIE ")>0||t.indexOf("Trident/")>0||t.indexOf("Edge/")>0||n||s)}static bt(){var t;return"undefined"!=typeof process&&"YES"===(null===(t=process.env)||void 0===t?void 0:t.Vt)}static St(t,e){return t.store(e)}static Rt(t){const e=t.match(/i(?:phone|pad|pod) os ([\d_]+)/i),n=e?e[1].split("_").slice(0,2).join("."):"-1";return Number(n)}static vt(t){const e=t.match(/Android ([\d.]+)/i),n=e?e[1].split(".").slice(0,2).join("."):"-1";return Number(n)}async Dt(t){return this.db||(k("SimpleDb","Opening database:",this.name),this.db=await new Promise((e,n)=>{const r=indexedDB.open(this.name,this.version);r.onsuccess=(t=>{const n=t.target.result;e(n)}),r.onblocked=(()=>{n(new Gs(t,"Cannot upgrade IndexedDB schema while another tab is open. Close all tabs that access Firestore and reload this page to proceed."))}),r.onerror=(e=>{const r=e.target.error;"VersionError"===r.name?n(new K(q.FAILED_PRECONDITION,"A newer version of the Firestore SDK was previously used and so the persisted data is not compatible with the version of the SDK you are now using. The SDK will operate with persistence disabled. If you need persistence, please re-upgrade to a newer version of the SDK or else clear the persisted IndexedDB data for your app to start fresh.")):n(new Gs(t,r))}),r.onupgradeneeded=(t=>{k("SimpleDb",'Database "'+this.name+'" requires upgrade from version:',t.oldVersion);const e=t.target.result;this.At.Ct(e,r.transaction,t.oldVersion,this.version).next(()=>{k("SimpleDb","Database upgrade to version "+this.version+" complete")})})})),this.Nt&&(this.db.onversionchange=(t=>this.Nt(t))),this.db}xt(t){this.Nt=t,this.db&&(this.db.onversionchange=(e=>t(e)))}async runTransaction(t,e,n,r){const s="readonly"===e;for(;;){0;try{this.db=await this.Dt(t);const e=js.open(this.db,t,s?"readonly":"readwrite",n),i=r(e).catch(t=>(e.abort(t),Ks.reject(t))).toPromise();return i.catch(()=>{}),await e.It,i}catch(t){const e="FirebaseError"!==t.name&&i<3;if(k("SimpleDb","Transaction failed with error:",t.message,"Retrying:",e),this.close(),!e)return Promise.reject(t)}}}close(){this.db&&this.db.close(),this.db=void 0}}class Ws{constructor(t){this.kt=t,this.$t=!1,this.Ot=null}get isDone(){return this.$t}get Ft(){return this.Ot}set cursor(t){this.kt=t}done(){this.$t=!0}Mt(t){this.Ot=t}delete(){return Js(this.kt.delete())}}class Gs extends K{constructor(t,e){super(q.UNAVAILABLE,`IndexedDB transaction '${t}' failed: ${e}`),this.name="IndexedDbTransactionError"}}function zs(t){return"IndexedDbTransactionError"===t.name}class Hs{constructor(t){this.store=t}put(t,e){let n;return void 0!==e?(k("SimpleDb","PUT",this.store.name,t,e),n=this.store.put(e,t)):(k("SimpleDb","PUT",this.store.name,"<auto-key>",t),n=this.store.put(t)),Js(n)}add(t){return k("SimpleDb","ADD",this.store.name,t,t),Js(this.store.add(t))}get(t){return Js(this.store.get(t)).next(e=>(void 0===e&&(e=null),k("SimpleDb","GET",this.store.name,t,e),e))}delete(t){return k("SimpleDb","DELETE",this.store.name,t),Js(this.store.delete(t))}count(){return k("SimpleDb","COUNT",this.store.name),Js(this.store.count())}Lt(t,e){const n=this.cursor(this.options(t,e)),r=[];return this.Bt(n,(t,e)=>{r.push(e)}).next(()=>r)}Ut(t,e){k("SimpleDb","DELETE ALL",this.store.name);const n=this.options(t,e);n.qt=!1;const r=this.cursor(n);return this.Bt(r,(t,e,n)=>n.delete())}Kt(t,e){let n;e?n=t:(n={},e=t);const r=this.cursor(n);return this.Bt(r,e)}jt(t){const e=this.cursor({});return new Ks((n,r)=>{e.onerror=(t=>{const e=Xs(t.target.error);r(e)}),e.onsuccess=(e=>{const r=e.target.result;r?t(r.primaryKey,r.value).next(t=>{t?r.continue():n()}):n()})})}Bt(t,e){const n=[];return new Ks((r,s)=>{t.onerror=(t=>{s(t.target.error)}),t.onsuccess=(t=>{const s=t.target.result;if(!s)return void r();const i=new Ws(s),o=e(s.primaryKey,s.value,i);if(o instanceof Ks){const t=o.catch(t=>(i.done(),Ks.reject(t)));n.push(t)}i.isDone?r():null===i.Ft?s.continue():s.continue(i.Ft)})}).next(()=>Ks.waitFor(n))}options(t,e){let n;return void 0!==t&&("string"==typeof t?n=t:e=t),{index:n,range:e}}cursor(t){let e="next";if(t.reverse&&(e="prev"),t.index){const n=this.store.index(t.index);return t.qt?n.openKeyCursor(t.range,e):n.openCursor(t.range,e)}return this.store.openCursor(t.range,e)}}function Js(t){return new Ks((e,n)=>{t.onsuccess=(t=>{const n=t.target.result;e(n)}),t.onerror=(t=>{const e=Xs(t.target.error);n(e)})})}let Ys=!1;function Xs(t){const e=Qs.Rt(getUA());if(e>=12.2&&e<13){const e="An internal error was encountered in the Indexed Database server";if(t.message.indexOf(e)>=0){const t=new K("internal",`IOS_INDEXEDDB_BUG1: IndexedDb has thrown '${e}'. This is likely due to an unavoidable bug in iOS. See https://stackoverflow.com/q/56496296/110915 for details and a potential workaround.`);return Ys||(Ys=!0,setTimeout(()=>{throw t},0)),t}}return t}class Zs extends qs{constructor(t,e){super(),this.Qt=t,this.currentSequenceNumber=e}}function ti(t,e){const n=U(t);return Qs.St(n.Qt,e)}class ei{constructor(t,e,n,r){this.batchId=t,this.localWriteTime=e,this.baseMutations=n,this.mutations=r}applyToRemoteDocument(t,e){const n=e.mutationResults;for(let e=0;e<this.mutations.length;e++){const r=this.mutations[e];r.key.isEqual(t.key)&&He(r,t,n[e])}}applyToLocalView(t){for(const e of this.baseMutations)e.key.isEqual(t.key)&&Je(e,t,this.localWriteTime);for(const e of this.mutations)e.key.isEqual(t.key)&&Je(e,t,this.localWriteTime)}applyToLocalDocumentSet(t){this.mutations.forEach(e=>{const n=t.get(e.key),r=n;this.applyToLocalView(r),n.isValidDocument()||r.convertToNoDocument(it.min())})}keys(){return this.mutations.reduce((t,e)=>t.add(e.key),Pn())}isEqual(t){return this.batchId===t.batchId&&et(this.mutations,t.mutations,(t,e)=>Xe(t,e))&&et(this.baseMutations,t.baseMutations,(t,e)=>Xe(t,e))}}class ni{constructor(t,e,n,r){this.batch=t,this.commitVersion=e,this.mutationResults=n,this.docVersions=r}static from(t,e,n){L(t.mutations.length===n.length);let r=An();const s=t.mutations;for(let t=0;t<s.length;t++)r=r.insert(s[t].key,n[t].version);return new ni(t,e,n,r)}}class si{constructor(t,e,n,r,s=it.min(),i=it.min(),o=wt.EMPTY_BYTE_STRING){this.target=t,this.targetId=e,this.purpose=n,this.sequenceNumber=r,this.snapshotVersion=s,this.lastLimboFreeSnapshotVersion=i,this.resumeToken=o}withSequenceNumber(t){return new si(this.target,this.targetId,this.purpose,t,this.snapshotVersion,this.lastLimboFreeSnapshotVersion,this.resumeToken)}withResumeToken(t,e){return new si(this.target,this.targetId,this.purpose,this.sequenceNumber,e,this.lastLimboFreeSnapshotVersion,t)}withLastLimboFreeSnapshotVersion(t){return new si(this.target,this.targetId,this.purpose,this.sequenceNumber,this.snapshotVersion,t,this.resumeToken)}}class ii{constructor(t){this.Wt=t}}function ri(t,e){if(e.document)return Zn(t.Wt,e.document,!!e.hasCommittedMutations);if(e.noDocument){const t=Pt.fromSegments(e.noDocument.path),n=hi(e.noDocument.readTime),r=qt.newNoDocument(t,n);return e.hasCommittedMutations?r.setHasCommittedMutations():r}if(e.unknownDocument){const t=Pt.fromSegments(e.unknownDocument.path),n=hi(e.unknownDocument.version);return qt.newUnknownDocument(t,n)}return M()}function oi(t,e,n){const r=ai(n),s=e.key.path.popLast().toArray();if(e.isFoundDocument()){const n=function(t,e){return{name:Wn(t,e.key),fields:e.data.value.mapValue.fields,updateTime:Bn(t,e.version.toTimestamp())}}(t.Wt,e),i=e.hasCommittedMutations;return new Cs(null,null,n,i,r,s)}if(e.isNoDocument()){const t=e.key.path.toArray(),n=ui(e.version),i=e.hasCommittedMutations;return new Cs(null,new Ss(t,n),null,i,r,s)}if(e.isUnknownDocument()){const t=e.key.path.toArray(),n=ui(e.version);return new Cs(new Ds(t,n),null,null,!0,r,s)}return M()}function ai(t){const e=t.toTimestamp();return[e.seconds,e.nanoseconds]}function ci(t){const e=new st(t[0],t[1]);return it.fromTimestamp(e)}function ui(t){const e=t.toTimestamp();return new Rs(e.seconds,e.nanoseconds)}function hi(t){const e=new st(t.seconds,t.nanoseconds);return it.fromTimestamp(e)}function li(t,e){const n=(e.baseMutations||[]).map(e=>ss(t.Wt,e));for(let t=0;t<e.mutations.length-1;++t){const n=e.mutations[t];if(t+1<e.mutations.length&&void 0!==e.mutations[t+1].transform){const r=e.mutations[t+1];n.updateTransforms=r.transform.fieldTransforms,e.mutations.splice(t+1,1),++t}}const r=e.mutations.map(e=>ss(t.Wt,e)),s=st.fromMillis(e.localWriteTimeMs);return new ei(e.batchId,s,n,r)}function fi(t){const e=hi(t.readTime),n=void 0!==t.lastLimboFreeSnapshotVersion?hi(t.lastLimboFreeSnapshotVersion):it.min();let r;var s;return void 0!==t.query.documents?(L(1===(s=t.query).documents.length),r=Ee(de(Hn(s.documents[0])))):r=function(t){return Ee(as(t))}(t.query),new si(r,t.targetId,0,t.lastListenSequenceNumber,e,n,wt.fromBase64String(t.resumeToken))}function di(t,e){const n=ui(e.snapshotVersion),r=ui(e.lastLimboFreeSnapshotVersion);let s;s=zt(e.target)?rs(t.Wt,e.target):os(t.Wt,e.target);const i=e.resumeToken.toBase64();return new xs(e.targetId,Qt(e.target),n,i,e.sequenceNumber,r,s)}function wi(t){const e=as({parent:t.parent,structuredQuery:t.structuredQuery});return"LAST"===t.limitType?Te(e,e.limit,"L"):e}class _i{getBundleMetadata(t,e){return mi(t).get(e).next(t=>{if(t)return{id:(e=t).bundleId,createTime:hi(e.createTime),version:e.version};var e})}saveBundleMetadata(t,e){return mi(t).put({bundleId:(n=e).id,createTime:ui(Kn(n.createTime)),version:n.version});var n}getNamedQuery(t,e){return gi(t).get(e).next(t=>{if(t)return{name:(e=t).name,query:wi(e.bundledQuery),readTime:hi(e.readTime)};var e})}saveNamedQuery(t,e){return gi(t).put(function(t){return{name:t.name,readTime:ui(Kn(t.readTime)),bundledQuery:t.bundledQuery}}(e))}}function mi(t){return ti(t,Ms.store)}function gi(t){return ti(t,Ls.store)}class yi{constructor(){this.Gt=new pi}addToCollectionParentIndex(t,e){return this.Gt.add(e),Ks.resolve()}getCollectionParents(t,e){return Ks.resolve(this.Gt.getEntries(e))}}class pi{constructor(){this.index={}}add(t){const e=t.lastSegment(),n=t.popLast(),r=this.index[e]||new mn(ut.comparator),s=!r.has(n);return this.index[e]=r.add(n),s}has(t){const e=t.lastSegment(),n=t.popLast(),r=this.index[e];return r&&r.has(n)}getEntries(t){return(this.index[t]||new mn(ut.comparator)).toArray()}}class Ei{constructor(){this.zt=new pi}addToCollectionParentIndex(t,e){if(!this.zt.has(e)){const n=e.lastSegment(),r=e.popLast();t.addOnCommittedListener(()=>{this.zt.add(e)});const s={collectionId:n,parent:Es(r)};return Ti(t).put(s)}return Ks.resolve()}getCollectionParents(t,e){const n=[],r=IDBKeyRange.bound([e,""],[nt(e),""],!1,!0);return Ti(t).Lt(r).next(t=>{for(const r of t){if(r.collectionId!==e)break;n.push(As(r.parent))}return n})}}function Ti(t){return ti(t,Os.store)}const Ii={didRun:!1,sequenceNumbersCollected:0,targetsRemoved:0,documentsRemoved:0};class Ai{constructor(t,e,n){this.cacheSizeCollectionThreshold=t,this.percentileToCollect=e,this.maximumSequenceNumbersToCollect=n}static withCacheSize(t){return new Ai(t,Ai.DEFAULT_COLLECTION_PERCENTILE,Ai.DEFAULT_MAX_SEQUENCE_NUMBERS_TO_COLLECT)}}function Ri(t,e,n){const r=t.store(vs.store),s=t.store(Vs.store),i=[],o=IDBKeyRange.only(n.batchId);let a=0;const c=r.Kt({range:o},(t,e,n)=>(a++,n.delete()));i.push(c.next(()=>{L(1===a)}));const u=[];for(const t of n.mutations){const r=Vs.key(e,t.key.path,n.batchId);i.push(s.delete(r)),u.push(t.key)}return Ks.waitFor(i).next(()=>u)}function Pi(t){if(!t)return 0;let e;if(t.document)e=t.document;else if(t.unknownDocument)e=t.unknownDocument;else{if(!t.noDocument)throw M();e=t.noDocument}return JSON.stringify(e).length}Ai.DEFAULT_COLLECTION_PERCENTILE=10,Ai.DEFAULT_MAX_SEQUENCE_NUMBERS_TO_COLLECT=1e3,Ai.DEFAULT=new Ai(41943040,Ai.DEFAULT_COLLECTION_PERCENTILE,Ai.DEFAULT_MAX_SEQUENCE_NUMBERS_TO_COLLECT),Ai.DISABLED=new Ai(-1,0,0);class bi{constructor(t,e,n,r){this.userId=t,this.N=e,this.Ht=n,this.referenceDelegate=r,this.Jt={}}static Yt(t,e,n,r){L(""!==t.uid);const s=t.isAuthenticated()?t.uid:"";return new bi(s,e,n,r)}checkEmpty(t){let e=!0;const n=IDBKeyRange.bound([this.userId,Number.NEGATIVE_INFINITY],[this.userId,Number.POSITIVE_INFINITY]);return Vi(t).Kt({index:vs.userMutationsIndex,range:n},(t,n,r)=>{e=!1,r.done()}).next(()=>e)}addMutationBatch(t,e,n,r){const s=Si(t),i=Vi(t);return i.add({}).next(o=>{L("number"==typeof o);const a=new ei(o,e,n,r),c=function(t,e,n){const r=n.baseMutations.map(e=>ns(t.Wt,e)),s=n.mutations.map(e=>ns(t.Wt,e));return new vs(e,n.batchId,n.localWriteTime.toMillis(),r,s)}(this.N,this.userId,a),u=[];let h=new mn((t,e)=>tt(t.canonicalString(),e.canonicalString()));for(const t of r){const e=Vs.key(this.userId,t.key.path,o);h=h.add(t.key.path.popLast()),u.push(i.put(c)),u.push(s.put(e,Vs.PLACEHOLDER))}return h.forEach(e=>{u.push(this.Ht.addToCollectionParentIndex(t,e))}),t.addOnCommittedListener(()=>{this.Jt[o]=a.keys()}),Ks.waitFor(u).next(()=>a)})}lookupMutationBatch(t,e){return Vi(t).get(e).next(t=>t?(L(t.userId===this.userId),li(this.N,t)):null)}Xt(t,e){return this.Jt[e]?Ks.resolve(this.Jt[e]):this.lookupMutationBatch(t,e).next(t=>{if(t){const n=t.keys();return this.Jt[e]=n,n}return null})}getNextMutationBatchAfterBatchId(t,e){const n=e+1,r=IDBKeyRange.lowerBound([this.userId,n]);let s=null;return Vi(t).Kt({index:vs.userMutationsIndex,range:r},(t,e,r)=>{e.userId===this.userId&&(L(e.batchId>=n),s=li(this.N,e)),r.done()}).next(()=>s)}getHighestUnacknowledgedBatchId(t){const e=IDBKeyRange.upperBound([this.userId,Number.POSITIVE_INFINITY]);let n=-1;return Vi(t).Kt({index:vs.userMutationsIndex,range:e,reverse:!0},(t,e,r)=>{n=e.batchId,r.done()}).next(()=>n)}getAllMutationBatches(t){const e=IDBKeyRange.bound([this.userId,-1],[this.userId,Number.POSITIVE_INFINITY]);return Vi(t).Lt(vs.userMutationsIndex,e).next(t=>t.map(t=>li(this.N,t)))}getAllMutationBatchesAffectingDocumentKey(t,e){const n=Vs.prefixForPath(this.userId,e.path),r=IDBKeyRange.lowerBound(n),s=[];return Si(t).Kt({range:r},(n,r,i)=>{const[o,a,c]=n,u=As(a);if(o===this.userId&&e.path.isEqual(u))return Vi(t).get(c).next(t=>{if(!t)throw M();L(t.userId===this.userId),s.push(li(this.N,t))});i.done()}).next(()=>s)}getAllMutationBatchesAffectingDocumentKeys(t,e){let n=new mn(tt);const r=[];return e.forEach(e=>{const s=Vs.prefixForPath(this.userId,e.path),i=IDBKeyRange.lowerBound(s),o=Si(t).Kt({range:i},(t,r,s)=>{const[i,o,a]=t,c=As(o);i===this.userId&&e.path.isEqual(c)?n=n.add(a):s.done()});r.push(o)}),Ks.waitFor(r).next(()=>this.Zt(t,n))}getAllMutationBatchesAffectingQuery(t,e){const n=e.path,r=n.length+1,s=Vs.prefixForPath(this.userId,n),i=IDBKeyRange.lowerBound(s);let o=new mn(tt);return Si(t).Kt({range:i},(t,e,s)=>{const[i,a,c]=t,u=As(a);i===this.userId&&n.isPrefixOf(u)?u.length===r&&(o=o.add(c)):s.done()}).next(()=>this.Zt(t,o))}Zt(t,e){const n=[],r=[];return e.forEach(e=>{r.push(Vi(t).get(e).next(t=>{if(null===t)throw M();L(t.userId===this.userId),n.push(li(this.N,t))}))}),Ks.waitFor(r).next(()=>n)}removeMutationBatch(t,e){return Ri(t.Qt,this.userId,e).next(n=>(t.addOnCommittedListener(()=>{this.te(e.batchId)}),Ks.forEach(n,e=>this.referenceDelegate.markPotentiallyOrphaned(t,e))))}te(t){delete this.Jt[t]}performConsistencyCheck(t){return this.checkEmpty(t).next(e=>{if(!e)return Ks.resolve();const n=IDBKeyRange.lowerBound(Vs.prefixForUser(this.userId)),r=[];return Si(t).Kt({range:n},(t,e,n)=>{if(t[0]===this.userId){const e=As(t[1]);r.push(e)}else n.done()}).next(()=>{L(0===r.length)})})}containsKey(t,e){return vi(t,this.userId,e)}ee(t){return Di(t).get(this.userId).next(t=>t||new bs(this.userId,-1,""))}}function vi(t,e,n){const r=Vs.prefixForPath(e,n.path),s=r[1],i=IDBKeyRange.lowerBound(r);let o=!1;return Si(t).Kt({range:i,qt:!0},(t,n,r)=>{const[i,a,c]=t;i===e&&a===s&&(o=!0),r.done()}).next(()=>o)}function Vi(t){return ti(t,vs.store)}function Si(t){return ti(t,Vs.store)}function Di(t){return ti(t,bs.store)}class Ci{constructor(t){this.ne=t}next(){return this.ne+=2,this.ne}static se(){return new Ci(0)}static ie(){return new Ci(-1)}}class Ni{constructor(t,e){this.referenceDelegate=t,this.N=e}allocateTargetId(t){return this.re(t).next(e=>{const n=new Ci(e.highestTargetId);return e.highestTargetId=n.next(),this.oe(t,e).next(()=>e.highestTargetId)})}getLastRemoteSnapshotVersion(t){return this.re(t).next(t=>it.fromTimestamp(new st(t.lastRemoteSnapshotVersion.seconds,t.lastRemoteSnapshotVersion.nanoseconds)))}getHighestSequenceNumber(t){return this.re(t).next(t=>t.highestListenSequenceNumber)}setTargetsMetadata(t,e,n){return this.re(t).next(r=>(r.highestListenSequenceNumber=e,n&&(r.lastRemoteSnapshotVersion=n.toTimestamp()),e>r.highestListenSequenceNumber&&(r.highestListenSequenceNumber=e),this.oe(t,r)))}addTargetData(t,e){return this.ae(t,e).next(()=>this.re(t).next(n=>(n.targetCount+=1,this.ce(e,n),this.oe(t,n))))}updateTargetData(t,e){return this.ae(t,e)}removeTargetData(t,e){return this.removeMatchingKeysForTargetId(t,e.targetId).next(()=>xi(t).delete(e.targetId)).next(()=>this.re(t)).next(e=>(L(e.targetCount>0),e.targetCount-=1,this.oe(t,e)))}removeTargets(t,e,n){let r=0;const s=[];return xi(t).Kt((i,o)=>{const a=fi(o);a.sequenceNumber<=e&&null===n.get(a.targetId)&&(r++,s.push(this.removeTargetData(t,a)))}).next(()=>Ks.waitFor(s)).next(()=>r)}forEachTarget(t,e){return xi(t).Kt((t,n)=>{const r=fi(n);e(r)})}re(t){return ki(t).get($s.key).next(t=>(L(null!==t),t))}oe(t,e){return ki(t).put($s.key,e)}ae(t,e){return xi(t).put(di(this.N,e))}ce(t,e){let n=!1;return t.targetId>e.highestTargetId&&(e.highestTargetId=t.targetId,n=!0),t.sequenceNumber>e.highestListenSequenceNumber&&(e.highestListenSequenceNumber=t.sequenceNumber,n=!0),n}getTargetCount(t){return this.re(t).next(t=>t.targetCount)}getTargetData(t,e){const n=Qt(e),r=IDBKeyRange.bound([n,Number.NEGATIVE_INFINITY],[n,Number.POSITIVE_INFINITY]);let s=null;return xi(t).Kt({range:r,index:xs.queryTargetsIndexName},(t,n,r)=>{const i=fi(n);Gt(e,i.target)&&(s=i,r.done())}).next(()=>s)}addMatchingKeys(t,e,n){const r=[],s=$i(t);return e.forEach(e=>{const i=Es(e.path);r.push(s.put(new ks(n,i))),r.push(this.referenceDelegate.addReference(t,n,e))}),Ks.waitFor(r)}removeMatchingKeys(t,e,n){const r=$i(t);return Ks.forEach(e,e=>{const s=Es(e.path);return Ks.waitFor([r.delete([n,s]),this.referenceDelegate.removeReference(t,n,e)])})}removeMatchingKeysForTargetId(t,e){const n=$i(t),r=IDBKeyRange.bound([e],[e+1],!1,!0);return n.delete(r)}getMatchingKeysForTargetId(t,e){const n=IDBKeyRange.bound([e],[e+1],!1,!0),r=$i(t);let s=Pn();return r.Kt({range:n,qt:!0},(t,e,n)=>{const r=As(t[1]),i=new Pt(r);s=s.add(i)}).next(()=>s)}containsKey(t,e){const n=Es(e.path),r=IDBKeyRange.bound([n],[nt(n)],!1,!0);let s=0;return $i(t).Kt({index:ks.documentTargetsIndex,qt:!0,range:r},([t,e],n,r)=>{0!==t&&(s++,r.done())}).next(()=>s>0)}Et(t,e){return xi(t).get(e).next(t=>t?fi(t):null)}}function xi(t){return ti(t,xs.store)}function ki(t){return ti(t,$s.store)}function $i(t){return ti(t,ks.store)}async function Oi(t){if(t.code!==q.FAILED_PRECONDITION||t.message!==Us)throw t;k("LocalStore","Unexpectedly lost primary lease")}function Fi([t,e],[n,r]){const s=tt(t,n);return 0===s?tt(e,r):s}class Mi{constructor(t){this.ue=t,this.buffer=new mn(Fi),this.he=0}le(){return++this.he}fe(t){const e=[t,this.le()];if(this.buffer.size<this.ue)this.buffer=this.buffer.add(e);else{const t=this.buffer.last();Fi(e,t)<0&&(this.buffer=this.buffer.delete(t).add(e))}}get maxValue(){return this.buffer.last()[0]}}class Li{constructor(t,e){this.garbageCollector=t,this.asyncQueue=e,this.de=!1,this.we=null}start(t){-1!==this.garbageCollector.params.cacheSizeCollectionThreshold&&this._e(t)}stop(){this.we&&(this.we.cancel(),this.we=null)}get started(){return null!==this.we}_e(t){const e=this.de?3e5:6e4;k("LruGarbageCollector",`Garbage collection scheduled in ${e}ms`),this.we=this.asyncQueue.enqueueAfterDelay("lru_garbage_collection",e,async()=>{this.we=null,this.de=!0;try{await t.collectGarbage(this.garbageCollector)}catch(t){zs(t)?k("LruGarbageCollector","Ignoring IndexedDB error during garbage collection: ",t):await Oi(t)}await this._e(t)})}}class Bi{constructor(t,e){this.me=t,this.params=e}calculateTargetCount(t,e){return this.me.ge(t).next(t=>Math.floor(e/100*t))}nthSequenceNumber(t,e){if(0===e)return Ks.resolve(Y.T);const n=new Mi(e);return this.me.forEachTarget(t,t=>n.fe(t.sequenceNumber)).next(()=>this.me.ye(t,t=>n.fe(t))).next(()=>n.maxValue)}removeTargets(t,e,n){return this.me.removeTargets(t,e,n)}removeOrphanedDocuments(t,e){return this.me.removeOrphanedDocuments(t,e)}collect(t,e){return-1===this.params.cacheSizeCollectionThreshold?(k("LruGarbageCollector","Garbage collection skipped; disabled"),Ks.resolve(Ii)):this.getCacheSize(t).next(n=>n<this.params.cacheSizeCollectionThreshold?(k("LruGarbageCollector",`Garbage collection skipped; Cache size ${n} is lower than threshold ${this.params.cacheSizeCollectionThreshold}`),Ii):this.pe(t,e))}getCacheSize(t){return this.me.getCacheSize(t)}pe(t,e){let n,r,s,i,o,a,c;const u=Date.now();return this.calculateTargetCount(t,this.params.percentileToCollect).next(e=>(e>this.params.maximumSequenceNumbersToCollect?(k("LruGarbageCollector",`Capping sequence numbers to collect down to the maximum of ${this.params.maximumSequenceNumbersToCollect} from ${e}`),r=this.params.maximumSequenceNumbersToCollect):r=e,i=Date.now(),this.nthSequenceNumber(t,r))).next(r=>(n=r,o=Date.now(),this.removeTargets(t,n,e))).next(e=>(s=e,a=Date.now(),this.removeOrphanedDocuments(t,n))).next(t=>(c=Date.now(),N()<=LogLevel.DEBUG&&k("LruGarbageCollector",`LRU Garbage Collection\n\tCounted targets in ${i-u}ms\n\tDetermined least recently used ${r} in `+(o-i)+"ms\n"+`\tRemoved ${s} targets in `+(a-o)+"ms\n"+`\tRemoved ${t} documents in `+(c-a)+"ms\n"+`Total Duration: ${c-u}ms`),Ks.resolve({didRun:!0,sequenceNumbersCollected:r,targetsRemoved:s,documentsRemoved:t})))}}class Ui{constructor(t,e){this.db=t,this.garbageCollector=function(t,e){return new Bi(t,e)}(this,e)}ge(t){const e=this.Ee(t);return this.db.getTargetCache().getTargetCount(t).next(t=>e.next(e=>t+e))}Ee(t){let e=0;return this.ye(t,t=>{e++}).next(()=>e)}forEachTarget(t,e){return this.db.getTargetCache().forEachTarget(t,e)}ye(t,e){return this.Te(t,(t,n)=>e(n))}addReference(t,e,n){return qi(t,n)}removeReference(t,e,n){return qi(t,n)}removeTargets(t,e,n){return this.db.getTargetCache().removeTargets(t,e,n)}markPotentiallyOrphaned(t,e){return qi(t,e)}Ie(t,e){return function(t,e){let n=!1;return Di(t).jt(r=>vi(t,r,e).next(t=>(t&&(n=!0),Ks.resolve(!t)))).next(()=>n)}(t,e)}removeOrphanedDocuments(t,e){const n=this.db.getRemoteDocumentCache().newChangeBuffer(),r=[];let s=0;return this.Te(t,(i,o)=>{if(o<=e){const e=this.Ie(t,i).next(e=>{if(!e)return s++,n.getEntry(t,i).next(()=>(n.removeEntry(i),$i(t).delete([0,Es(i.path)])))});r.push(e)}}).next(()=>Ks.waitFor(r)).next(()=>n.apply(t)).next(()=>s)}removeTarget(t,e){const n=e.withSequenceNumber(t.currentSequenceNumber);return this.db.getTargetCache().updateTargetData(t,n)}updateLimboDocument(t,e){return qi(t,e)}Te(t,e){const n=$i(t);let r,s=Y.T;return n.Kt({index:ks.documentTargetsIndex},([t,n],{path:i,sequenceNumber:o})=>{0===t?(s!==Y.T&&e(new Pt(As(r)),s),s=o,r=i):s=Y.T}).next(()=>{s!==Y.T&&e(new Pt(As(r)),s)})}getCacheSize(t){return this.db.getRemoteDocumentCache().getSize(t)}}function qi(t,e){return $i(t).put(function(t,e){return new ks(0,Es(t.path),e)}(e,t.currentSequenceNumber))}class Ki{constructor(t,e){this.mapKeyFn=t,this.equalsFn=e,this.inner={}}get(t){const e=this.mapKeyFn(t),n=this.inner[e];if(void 0!==n)for(const[e,r]of n)if(this.equalsFn(e,t))return r}has(t){return void 0!==this.get(t)}set(t,e){const n=this.mapKeyFn(t),r=this.inner[n];if(void 0!==r){for(let n=0;n<r.length;n++)if(this.equalsFn(r[n][0],t))return void(r[n]=[t,e]);r.push([t,e])}else this.inner[n]=[[t,e]]}delete(t){const e=this.mapKeyFn(t),n=this.inner[e];if(void 0===n)return!1;for(let r=0;r<n.length;r++)if(this.equalsFn(n[r][0],t))return 1===n.length?delete this.inner[e]:n.splice(r,1),!0;return!1}forEach(t){ot(this.inner,(e,n)=>{for(const[e,r]of n)t(e,r)})}isEmpty(){return at(this.inner)}}class ji{constructor(){this.changes=new Ki(t=>t.toString(),(t,e)=>t.isEqual(e)),this.changesApplied=!1}getReadTime(t){const e=this.changes.get(t);return e?e.readTime:it.min()}addEntry(t,e){this.assertNotApplied(),this.changes.set(t.key,{document:t,readTime:e})}removeEntry(t,e=null){this.assertNotApplied(),this.changes.set(t,{document:qt.newInvalidDocument(t),readTime:e})}getEntry(t,e){this.assertNotApplied();const n=this.changes.get(e);return void 0!==n?Ks.resolve(n.document):this.getFromCache(t,e)}getEntries(t,e){return this.getAllFromCache(t,e)}apply(t){return this.assertNotApplied(),this.changesApplied=!0,this.applyChanges(t)}assertNotApplied(){}}class Qi{constructor(t,e){this.N=t,this.Ht=e}addEntry(t,e,n){return zi(t).put(Hi(e),n)}removeEntry(t,e){const n=zi(t),r=Hi(e);return n.delete(r)}updateMetadata(t,e){return this.getMetadata(t).next(n=>(n.byteSize+=e,this.Ae(t,n)))}getEntry(t,e){return zi(t).get(Hi(e)).next(t=>this.Re(e,t))}Pe(t,e){return zi(t).get(Hi(e)).next(t=>({document:this.Re(e,t),size:Pi(t)}))}getEntries(t,e){let n=pn();return this.be(t,e,(t,e)=>{const r=this.Re(t,e);n=n.insert(t,r)}).next(()=>n)}ve(t,e){let n=pn(),r=new dn(Pt.comparator);return this.be(t,e,(t,e)=>{const s=this.Re(t,e);n=n.insert(t,s),r=r.insert(t,Pi(e))}).next(()=>({documents:n,Ve:r}))}be(t,e,n){if(e.isEmpty())return Ks.resolve();const r=IDBKeyRange.bound(e.first().path.toArray(),e.last().path.toArray()),s=e.getIterator();let i=s.getNext();return zi(t).Kt({range:r},(t,e,r)=>{const o=Pt.fromSegments(t);for(;i&&Pt.comparator(i,o)<0;)n(i,null),i=s.getNext();i&&i.isEqual(o)&&(n(i,e),i=s.hasNext()?s.getNext():null),i?r.Mt(i.path.toArray()):r.done()}).next(()=>{for(;i;)n(i,null),i=s.hasNext()?s.getNext():null})}getDocumentsMatchingQuery(t,e,n){let r=pn();const s=e.path.length+1,i={};if(n.isEqual(it.min())){const t=e.path.toArray();i.range=IDBKeyRange.lowerBound(t)}else{const t=e.path.toArray(),r=ai(n);i.range=IDBKeyRange.lowerBound([t,r],!0),i.index=Cs.collectionReadTimeIndex}return zi(t).Kt(i,(t,n,i)=>{if(t.length!==s)return;const o=ri(this.N,n);e.path.isPrefixOf(o.key.path)?Pe(e,o)&&(r=r.insert(o.key,o)):i.done()}).next(()=>r)}newChangeBuffer(t){return new Wi(this,!!t&&t.trackRemovals)}getSize(t){return this.getMetadata(t).next(t=>t.byteSize)}getMetadata(t){return Gi(t).get(Ns.key).next(t=>(L(!!t),t))}Ae(t,e){return Gi(t).put(Ns.key,e)}Re(t,e){if(e){const t=ri(this.N,e);if(!t.isNoDocument()||!t.version.isEqual(it.min()))return t}return qt.newInvalidDocument(t)}}class Wi extends ji{constructor(t,e){super(),this.Se=t,this.trackRemovals=e,this.De=new Ki(t=>t.toString(),(t,e)=>t.isEqual(e))}applyChanges(t){const e=[];let n=0,r=new mn((t,e)=>tt(t.canonicalString(),e.canonicalString()));return this.changes.forEach((s,i)=>{const o=this.De.get(s);if(i.document.isValidDocument()){const a=oi(this.Se.N,i.document,this.getReadTime(s));r=r.add(s.path.popLast());const c=Pi(a);n+=c-o,e.push(this.Se.addEntry(t,s,a))}else if(n-=o,this.trackRemovals){const n=oi(this.Se.N,qt.newNoDocument(s,it.min()),this.getReadTime(s));e.push(this.Se.addEntry(t,s,n))}else e.push(this.Se.removeEntry(t,s))}),r.forEach(n=>{e.push(this.Se.Ht.addToCollectionParentIndex(t,n))}),e.push(this.Se.updateMetadata(t,n)),Ks.waitFor(e)}getFromCache(t,e){return this.Se.Pe(t,e).next(t=>(this.De.set(e,t.size),t.document))}getAllFromCache(t,e){return this.Se.ve(t,e).next(({documents:t,Ve:e})=>(e.forEach((t,e)=>{this.De.set(t,e)}),t))}}function Gi(t){return ti(t,Ns.store)}function zi(t){return ti(t,Cs.store)}function Hi(t){return t.path.toArray()}class Ji{constructor(t){this.N=t}Ct(t,e,n,r){L(n<r&&n>=0&&r<=11);const s=new js("createOrUpgrade",e);n<1&&r>=1&&(function(t){t.createObjectStore(Ps.store)}(t),function(t){t.createObjectStore(bs.store,{keyPath:bs.keyPath}),t.createObjectStore(vs.store,{keyPath:vs.keyPath,autoIncrement:!0}).createIndex(vs.userMutationsIndex,vs.userMutationsKeyPath,{unique:!0}),t.createObjectStore(Vs.store)}(t),Yi(t),function(t){t.createObjectStore(Cs.store)}(t));let i=Ks.resolve();return n<3&&r>=3&&(0!==n&&(function(t){t.deleteObjectStore(ks.store),t.deleteObjectStore(xs.store),t.deleteObjectStore($s.store)}(t),Yi(t)),i=i.next(()=>(function(t){const e=s.store($s.store),n=new $s(0,0,it.min().toTimestamp(),0);return e.put($s.key,n)})())),n<4&&r>=4&&(0!==n&&(i=i.next(()=>(function(t,e){return e.store(vs.store).Lt().next(n=>{t.deleteObjectStore(vs.store),t.createObjectStore(vs.store,{keyPath:vs.keyPath,autoIncrement:!0}).createIndex(vs.userMutationsIndex,vs.userMutationsKeyPath,{unique:!0});const r=e.store(vs.store),s=n.map(t=>r.put(t));return Ks.waitFor(s)})})(t,s))),i=i.next(()=>{!function(t){t.createObjectStore(Fs.store,{keyPath:Fs.keyPath})}(t)})),n<5&&r>=5&&(i=i.next(()=>this.Ce(s))),n<6&&r>=6&&(i=i.next(()=>(function(t){t.createObjectStore(Ns.store)}(t),this.Ne(s)))),n<7&&r>=7&&(i=i.next(()=>this.xe(s))),n<8&&r>=8&&(i=i.next(()=>this.ke(t,s))),n<9&&r>=9&&(i=i.next(()=>{!function(t){t.objectStoreNames.contains("remoteDocumentChanges")&&t.deleteObjectStore("remoteDocumentChanges")}(t),function(t){const e=t.objectStore(Cs.store);e.createIndex(Cs.readTimeIndex,Cs.readTimeIndexPath,{unique:!1}),e.createIndex(Cs.collectionReadTimeIndex,Cs.collectionReadTimeIndexPath,{unique:!1})}(e)})),n<10&&r>=10&&(i=i.next(()=>this.$e(s))),n<11&&r>=11&&(i=i.next(()=>{!function(t){t.createObjectStore(Ms.store,{keyPath:Ms.keyPath})}(t),function(t){t.createObjectStore(Ls.store,{keyPath:Ls.keyPath})}(t)})),i}Ne(t){let e=0;return t.store(Cs.store).Kt((t,n)=>{e+=Pi(n)}).next(()=>{const n=new Ns(e);return t.store(Ns.store).put(Ns.key,n)})}Ce(t){const e=t.store(bs.store),n=t.store(vs.store);return e.Lt().next(e=>Ks.forEach(e,e=>{const r=IDBKeyRange.bound([e.userId,-1],[e.userId,e.lastAcknowledgedBatchId]);return n.Lt(vs.userMutationsIndex,r).next(n=>Ks.forEach(n,n=>{L(n.userId===e.userId);const r=li(this.N,n);return Ri(t,e.userId,r).next(()=>{})}))}))}xe(t){const e=t.store(ks.store),n=t.store(Cs.store);return t.store($s.store).get($s.key).next(t=>{const r=[];return n.Kt((n,s)=>{const i=new ut(n),o=function(t){return[0,Es(i)]}();r.push(e.get(o).next(n=>n?Ks.resolve():(n=>e.put(new ks(0,Es(n),t.highestListenSequenceNumber)))(i)))}).next(()=>Ks.waitFor(r))})}ke(t,e){t.createObjectStore(Os.store,{keyPath:Os.keyPath});const n=e.store(Os.store),r=new pi,s=t=>{if(r.add(t)){const e=t.lastSegment(),r=t.popLast();return n.put({collectionId:e,parent:Es(r)})}};return e.store(Cs.store).Kt({qt:!0},(t,e)=>{const n=new ut(t);return s(n.popLast())}).next(()=>e.store(Vs.store).Kt({qt:!0},([t,e,n],r)=>{const i=As(e);return s(i.popLast())}))}$e(t){const e=t.store(xs.store);return e.Kt((t,n)=>{const r=fi(n),s=di(this.N,r);return e.put(s)})}}function Yi(t){t.createObjectStore(ks.store,{keyPath:ks.keyPath}).createIndex(ks.documentTargetsIndex,ks.documentTargetsKeyPath,{unique:!0}),t.createObjectStore(xs.store,{keyPath:xs.keyPath}).createIndex(xs.queryTargetsIndexName,xs.queryTargetsKeyPath,{unique:!0}),t.createObjectStore($s.store)}const Xi="Failed to obtain exclusive access to the persistence layer. To allow shared access, multi-tab synchronization has to be enabled in all tabs. If you are using `experimentalForceOwningTab:true`, make sure that only one tab has persistence enabled at any given time.";class Zi{constructor(t,e,n,r,s,i,o,a,c,u){if(this.allowTabSynchronization=t,this.persistenceKey=e,this.clientId=n,this.Oe=s,this.window=i,this.document=o,this.Fe=c,this.Me=u,this.Le=null,this.Be=!1,this.isPrimary=!1,this.networkEnabled=!0,this.Ue=null,this.inForeground=!1,this.qe=null,this.Ke=null,this.je=Number.NEGATIVE_INFINITY,this.Qe=(t=>Promise.resolve()),!Zi.Pt())throw new K(q.UNIMPLEMENTED,"This platform is either missing IndexedDB or is known to have an incomplete implementation. Offline persistence has been disabled.");this.referenceDelegate=new Ui(this,r),this.We=e+"main",this.N=new ii(a),this.Ge=new Qs(this.We,11,new Ji(this.N)),this.ze=new Ni(this.referenceDelegate,this.N),this.Ht=new Ei,this.He=function(t,e){return new Qi(t,e)}(this.N,this.Ht),this.Je=new _i,this.window&&this.window.localStorage?this.Ye=this.window.localStorage:(this.Ye=null,!1===u&&$("IndexedDbPersistence","LocalStorage is unavailable. As a result, persistence may not work reliably. In particular enablePersistence() could fail immediately after refreshing the page."))}start(){return this.Xe().then(()=>{if(!this.isPrimary&&!this.allowTabSynchronization)throw new K(q.FAILED_PRECONDITION,Xi);return this.Ze(),this.tn(),this.en(),this.runTransaction("getHighestListenSequenceNumber","readonly",t=>this.ze.getHighestSequenceNumber(t))}).then(t=>{this.Le=new Y(t,this.Fe)}).then(()=>{this.Be=!0}).catch(t=>(this.Ge&&this.Ge.close(),Promise.reject(t)))}nn(t){return this.Qe=(async e=>{if(this.started)return t(e)}),t(this.isPrimary)}setDatabaseDeletedListener(t){this.Ge.xt(async e=>{null===e.newVersion&&await t()})}setNetworkEnabled(t){this.networkEnabled!==t&&(this.networkEnabled=t,this.Oe.enqueueAndForget(async()=>{this.started&&await this.Xe()}))}Xe(){return this.runTransaction("updateClientMetadataAndTryBecomePrimary","readwrite",t=>er(t).put(new Fs(this.clientId,Date.now(),this.networkEnabled,this.inForeground)).next(()=>{if(this.isPrimary)return this.sn(t).next(t=>{t||(this.isPrimary=!1,this.Oe.enqueueRetryable(()=>this.Qe(!1)))})}).next(()=>this.rn(t)).next(e=>this.isPrimary&&!e?this.on(t).next(()=>!1):!!e&&this.an(t).next(()=>!0))).catch(t=>{if(zs(t))return k("IndexedDbPersistence","Failed to extend owner lease: ",t),this.isPrimary;if(!this.allowTabSynchronization)throw t;return k("IndexedDbPersistence","Releasing owner lease after error during lease refresh",t),!1}).then(t=>{this.isPrimary!==t&&this.Oe.enqueueRetryable(()=>this.Qe(t)),this.isPrimary=t})}sn(t){return tr(t).get(Ps.key).next(t=>Ks.resolve(this.cn(t)))}un(t){return er(t).delete(this.clientId)}async hn(){if(this.isPrimary&&!this.ln(this.je,18e5)){this.je=Date.now();const t=await this.runTransaction("maybeGarbageCollectMultiClientState","readwrite-primary",t=>{const e=ti(t,Fs.store);return e.Lt().next(t=>{const n=this.fn(t,18e5),r=t.filter(t=>-1===n.indexOf(t));return Ks.forEach(r,t=>e.delete(t.clientId)).next(()=>r)})}).catch(()=>[]);if(this.Ye)for(const e of t)this.Ye.removeItem(this.dn(e.clientId))}}en(){this.Ke=this.Oe.enqueueAfterDelay("client_metadata_refresh",4e3,()=>this.Xe().then(()=>this.hn()).then(()=>this.en()))}cn(t){return!!t&&t.ownerId===this.clientId}rn(t){return this.Me?Ks.resolve(!0):tr(t).get(Ps.key).next(e=>{if(null!==e&&this.ln(e.leaseTimestampMs,5e3)&&!this.wn(e.ownerId)){if(this.cn(e)&&this.networkEnabled)return!0;if(!this.cn(e)){if(!e.allowTabSynchronization)throw new K(q.FAILED_PRECONDITION,Xi);return!1}}return!(!this.networkEnabled||!this.inForeground)||er(t).Lt().next(t=>void 0===this.fn(t,5e3).find(t=>{if(this.clientId!==t.clientId){const e=!this.networkEnabled&&t.networkEnabled,n=!this.inForeground&&t.inForeground,r=this.networkEnabled===t.networkEnabled;if(e||n&&r)return!0}return!1}))}).next(t=>(this.isPrimary!==t&&k("IndexedDbPersistence",`Client ${t?"is":"is not"} eligible for a primary lease.`),t))}async shutdown(){this.Be=!1,this._n(),this.Ke&&(this.Ke.cancel(),this.Ke=null),this.mn(),this.gn(),await this.Ge.runTransaction("shutdown","readwrite",[Ps.store,Fs.store],t=>{const e=new Zs(t,Y.T);return this.on(e).next(()=>this.un(e))}),this.Ge.close(),this.yn()}fn(t,e){return t.filter(t=>this.ln(t.updateTimeMs,e)&&!this.wn(t.clientId))}pn(){return this.runTransaction("getActiveClients","readonly",t=>er(t).Lt().next(t=>this.fn(t,18e5).map(t=>t.clientId)))}get started(){return this.Be}getMutationQueue(t){return bi.Yt(t,this.N,this.Ht,this.referenceDelegate)}getTargetCache(){return this.ze}getRemoteDocumentCache(){return this.He}getIndexManager(){return this.Ht}getBundleCache(){return this.Je}runTransaction(t,e,n){k("IndexedDbPersistence","Starting transaction:",t);const r="readonly"===e?"readonly":"readwrite";let s;return this.Ge.runTransaction(t,r,Bs,r=>(s=new Zs(r,this.Le?this.Le.next():Y.T),"readwrite-primary"===e?this.sn(s).next(t=>!!t||this.rn(s)).next(e=>{if(!e)throw $(`Failed to obtain primary lease for action '${t}'.`),this.isPrimary=!1,this.Oe.enqueueRetryable(()=>this.Qe(!1)),new K(q.FAILED_PRECONDITION,Us);return n(s)}).next(t=>this.an(s).next(()=>t)):this.En(s).next(()=>n(s)))).then(t=>(s.raiseOnCommittedEvent(),t))}En(t){return tr(t).get(Ps.key).next(t=>{if(null!==t&&this.ln(t.leaseTimestampMs,5e3)&&!this.wn(t.ownerId)&&!this.cn(t)&&!(this.Me||this.allowTabSynchronization&&t.allowTabSynchronization))throw new K(q.FAILED_PRECONDITION,Xi)})}an(t){const e=new Ps(this.clientId,this.allowTabSynchronization,Date.now());return tr(t).put(Ps.key,e)}static Pt(){return Qs.Pt()}on(t){const e=tr(t);return e.get(Ps.key).next(t=>this.cn(t)?(k("IndexedDbPersistence","Releasing primary lease."),e.delete(Ps.key)):Ks.resolve())}ln(t,e){const n=Date.now();return!(t<n-e||t>n&&($(`Detected an update time that is in the future: ${t} > ${n}`),1))}Ze(){null!==this.document&&"function"==typeof this.document.addEventListener&&(this.qe=(()=>{this.Oe.enqueueAndForget(()=>(this.inForeground="visible"===this.document.visibilityState,this.Xe()))}),this.document.addEventListener("visibilitychange",this.qe),this.inForeground="visible"===this.document.visibilityState)}mn(){this.qe&&(this.document.removeEventListener("visibilitychange",this.qe),this.qe=null)}tn(){var t;"function"==typeof(null===(t=this.window)||void 0===t?void 0:t.addEventListener)&&(this.Ue=(()=>{this._n(),isSafari()&&navigator.appVersion.match("Version/14")&&this.Oe.enterRestrictedMode(!0),this.Oe.enqueueAndForget(()=>this.shutdown())}),this.window.addEventListener("pagehide",this.Ue))}gn(){this.Ue&&(this.window.removeEventListener("pagehide",this.Ue),this.Ue=null)}wn(t){var e;try{const n=null!==(null===(e=this.Ye)||void 0===e?void 0:e.getItem(this.dn(t)));return k("IndexedDbPersistence",`Client '${t}' ${n?"is":"is not"} zombied in LocalStorage`),n}catch(t){return $("IndexedDbPersistence","Failed to get zombied client id.",t),!1}}_n(){if(this.Ye)try{this.Ye.setItem(this.dn(this.clientId),String(Date.now()))}catch(t){$("Failed to set zombie client id.",t)}}yn(){if(this.Ye)try{this.Ye.removeItem(this.dn(this.clientId))}catch(t){}}dn(t){return`firestore_zombie_${this.persistenceKey}_${t}`}}function tr(t){return ti(t,Ps.store)}function er(t){return ti(t,Fs.store)}function nr(t,e){let n=t.projectId;return t.isDefaultDatabase||(n+="."+t.database),"firestore/"+e+"/"+n+"/"}class sr{constructor(t,e){this.progress=t,this.Tn=e}}class ir{constructor(t,e,n){this.He=t,this.In=e,this.Ht=n}An(t,e){return this.In.getAllMutationBatchesAffectingDocumentKey(t,e).next(n=>this.Rn(t,e,n))}Rn(t,e,n){return this.He.getEntry(t,e).next(t=>{for(const e of n)e.applyToLocalView(t);return t})}Pn(t,e){t.forEach((t,n)=>{for(const t of e)t.applyToLocalView(n)})}bn(t,e){return this.He.getEntries(t,e).next(e=>this.vn(t,e).next(()=>e))}vn(t,e){return this.In.getAllMutationBatchesAffectingDocumentKeys(t,e).next(t=>this.Pn(e,t))}getDocumentsMatchingQuery(t,e,n){return function(t){return Pt.isDocumentKey(t.path)&&null===t.collectionGroup&&0===t.filters.length}(e)?this.Vn(t,e.path):ye(e)?this.Sn(t,e,n):this.Dn(t,e,n)}Vn(t,e){return this.An(t,new Pt(e)).next(t=>{let e=Tn();return t.isFoundDocument()&&(e=e.insert(t.key,t)),e})}Sn(t,e,n){const r=e.collectionGroup;let s=Tn();return this.Ht.getCollectionParents(t,r).next(i=>Ks.forEach(i,i=>{const o=function(t,e){return new le(e,null,t.explicitOrderBy.slice(),t.filters.slice(),t.limit,t.limitType,t.startAt,t.endAt)}(e,i.child(r));return this.Dn(t,o,n).next(t=>{t.forEach((t,e)=>{s=s.insert(t,e)})})}).next(()=>s))}Dn(t,e,n){let r,s;return this.He.getDocumentsMatchingQuery(t,e,n).next(n=>(r=n,this.In.getAllMutationBatchesAffectingQuery(t,e))).next(e=>(s=e,this.Cn(t,s,r).next(t=>{r=t;for(const t of s)for(const e of t.mutations){const n=e.key;let s=r.get(n);null==s&&(s=qt.newInvalidDocument(n),r=r.insert(n,s)),Je(e,s,t.localWriteTime),s.isFoundDocument()||(r=r.remove(n))}}))).next(()=>(r.forEach((t,n)=>{Pe(e,n)||(r=r.remove(t))}),r))}Cn(t,e,n){let r=Pn();for(const t of e)for(const e of t.mutations)e instanceof en&&null===n.get(e.key)&&(r=r.add(e.key));let s=n;return this.He.getEntries(t,r).next(t=>(t.forEach((t,e)=>{e.isFoundDocument()&&(s=s.insert(t,e))}),s))}}class rr{constructor(t,e,n,r){this.targetId=t,this.fromCache=e,this.Nn=n,this.xn=r}static kn(t,e){let n=Pn(),r=Pn();for(const t of e.docChanges)switch(t.type){case 0:n=n.add(t.doc.key);break;case 1:r=r.add(t.doc.key)}return new rr(t,e.fromCache,n,r)}}class or{$n(t){this.On=t}getDocumentsMatchingQuery(t,e,n,r){return function(t){return 0===t.filters.length&&null===t.limit&&null==t.startAt&&null==t.endAt&&(0===t.explicitOrderBy.length||1===t.explicitOrderBy.length&&t.explicitOrderBy[0].field.isKeyField())}(e)||n.isEqual(it.min())?this.Fn(t,e):this.On.bn(t,r).next(s=>{const i=this.Mn(e,s);return(we(e)||_e(e))&&this.Ln(e.limitType,i,r,n)?this.Fn(t,e):(N()<=LogLevel.DEBUG&&k("QueryEngine","Re-using previous result from %s to execute query: %s",n.toString(),Re(e)),this.On.getDocumentsMatchingQuery(t,e,n).next(t=>(i.forEach(e=>{t=t.insert(e.key,e)}),t)))})}Mn(t,e){let n=new mn(be(t));return e.forEach((e,r)=>{Pe(t,r)&&(n=n.add(r))}),n}Ln(t,e,n,r){if(n.size!==e.size)return!0;const s="F"===t?e.last():e.first();return!!s&&(s.hasPendingWrites||s.version.compareTo(r)>0)}Fn(t,e){return N()<=LogLevel.DEBUG&&k("QueryEngine","Using full collection scan to execute query:",Re(e)),this.On.getDocumentsMatchingQuery(t,e,it.min())}}class ar{constructor(t,e,n,r){this.persistence=t,this.Bn=e,this.N=r,this.Un=new dn(tt),this.qn=new Ki(t=>Qt(t),Gt),this.Kn=it.min(),this.In=t.getMutationQueue(n),this.jn=t.getRemoteDocumentCache(),this.ze=t.getTargetCache(),this.Qn=new ir(this.jn,this.In,this.persistence.getIndexManager()),this.Je=t.getBundleCache(),this.Bn.$n(this.Qn)}collectGarbage(t){return this.persistence.runTransaction("Collect garbage","readwrite-primary",e=>t.collect(e,this.Un))}}function cr(t,e,n,r){return new ar(t,e,n,r)}async function ur(t,e){const n=U(t);let r=n.In,s=n.Qn;const i=await n.persistence.runTransaction("Handle user change","readonly",t=>{let i;return n.In.getAllMutationBatches(t).next(o=>(i=o,r=n.persistence.getMutationQueue(e),s=new ir(n.jn,r,n.persistence.getIndexManager()),r.getAllMutationBatches(t))).next(e=>{const n=[],r=[];let o=Pn();for(const t of i){n.push(t.batchId);for(const e of t.mutations)o=o.add(e.key)}for(const t of e){r.push(t.batchId);for(const e of t.mutations)o=o.add(e.key)}return s.bn(t,o).next(t=>({Wn:t,removedBatchIds:n,addedBatchIds:r}))})});return n.In=r,n.Qn=s,n.Bn.$n(n.Qn),i}function hr(t,e){const n=U(t);return n.persistence.runTransaction("Acknowledge batch","readwrite-primary",t=>{const r=e.batch.keys(),s=n.jn.newChangeBuffer({trackRemovals:!0});return function(t,e,n,r){const s=n.batch,i=s.keys();let o=Ks.resolve();return i.forEach(t=>{o=o.next(()=>r.getEntry(e,t)).next(e=>{const i=n.docVersions.get(t);L(null!==i),e.version.compareTo(i)<0&&(s.applyToRemoteDocument(e,n),e.isValidDocument()&&r.addEntry(e,n.commitVersion))})}),o.next(()=>t.In.removeMutationBatch(e,s))}(n,t,e,s).next(()=>s.apply(t)).next(()=>n.In.performConsistencyCheck(t)).next(()=>n.Qn.bn(t,r))})}function lr(t){const e=U(t);return e.persistence.runTransaction("Get last remote snapshot version","readonly",t=>e.ze.getLastRemoteSnapshotVersion(t))}function fr(t,e){const n=U(t),r=e.snapshotVersion;let s=n.Un;return n.persistence.runTransaction("Apply remote event","readwrite-primary",t=>{const i=n.jn.newChangeBuffer({trackRemovals:!0});s=n.Un;const o=[];e.targetChanges.forEach((e,i)=>{const a=s.get(i);if(!a)return;o.push(n.ze.removeMatchingKeys(t,e.removedDocuments,i).next(()=>n.ze.addMatchingKeys(t,e.addedDocuments,i)));const c=e.resumeToken;if(c.approximateByteSize()>0){const u=a.withResumeToken(c,r).withSequenceNumber(t.currentSequenceNumber);s=s.insert(i,u),function(t,e,n){return L(e.resumeToken.approximateByteSize()>0),0===t.resumeToken.approximateByteSize()||(e.snapshotVersion.toMicroseconds()-t.snapshotVersion.toMicroseconds()>=3e8||n.addedDocuments.size+n.modifiedDocuments.size+n.removedDocuments.size>0)}(a,u,e)&&o.push(n.ze.updateTargetData(t,u))}});let a=pn();if(e.documentUpdates.forEach((r,s)=>{e.resolvedLimboDocuments.has(r)&&o.push(n.persistence.referenceDelegate.updateLimboDocument(t,r))}),o.push(dr(t,i,e.documentUpdates,r,void 0).next(t=>{a=t})),!r.isEqual(it.min())){const e=n.ze.getLastRemoteSnapshotVersion(t).next(e=>n.ze.setTargetsMetadata(t,t.currentSequenceNumber,r));o.push(e)}return Ks.waitFor(o).next(()=>i.apply(t)).next(()=>n.Qn.vn(t,a)).next(()=>a)}).then(t=>(n.Un=s,t))}function dr(t,e,n,r,s){let i=Pn();return n.forEach(t=>i=i.add(t)),e.getEntries(t,i).next(t=>{let i=pn();return n.forEach((n,o)=>{const a=t.get(n),c=(null==s?void 0:s.get(n))||r;o.isNoDocument()&&o.version.isEqual(it.min())?(e.removeEntry(n,c),i=i.insert(n,o)):!a.isValidDocument()||o.version.compareTo(a.version)>0||0===o.version.compareTo(a.version)&&a.hasPendingWrites?(e.addEntry(o,c),i=i.insert(n,o)):k("LocalStore","Ignoring outdated watch update for ",n,". Current version:",a.version," Watch version:",o.version)}),i})}function wr(t,e){const n=U(t);return n.persistence.runTransaction("Get next mutation batch","readonly",t=>(void 0===e&&(e=-1),n.In.getNextMutationBatchAfterBatchId(t,e)))}function _r(t,e){const n=U(t);return n.persistence.runTransaction("Allocate target","readwrite",t=>{let r;return n.ze.getTargetData(t,e).next(s=>s?(r=s,Ks.resolve(r)):n.ze.allocateTargetId(t).next(s=>(r=new si(e,s,0,t.currentSequenceNumber),n.ze.addTargetData(t,r).next(()=>r))))}).then(t=>{const r=n.Un.get(t.targetId);return(null===r||t.snapshotVersion.compareTo(r.snapshotVersion)>0)&&(n.Un=n.Un.insert(t.targetId,t),n.qn.set(e,t.targetId)),t})}async function mr(t,e,n){const r=U(t),s=r.Un.get(e),i=n?"readwrite":"readwrite-primary";try{n||await r.persistence.runTransaction("Release target",i,t=>r.persistence.referenceDelegate.removeTarget(t,s))}catch(t){if(!zs(t))throw t;k("LocalStore",`Failed to update sequence numbers for target ${e}: ${t}`)}r.Un=r.Un.remove(e),r.qn.delete(s.target)}function gr(t,e,n){const r=U(t);let s=it.min(),i=Pn();return r.persistence.runTransaction("Execute query","readonly",t=>(function(t,e,n){const r=U(t),s=r.qn.get(n);return void 0!==s?Ks.resolve(r.Un.get(s)):r.ze.getTargetData(e,n)})(r,t,Ee(e)).next(e=>{if(e)return s=e.lastLimboFreeSnapshotVersion,r.ze.getMatchingKeysForTargetId(t,e.targetId).next(t=>{i=t})}).next(()=>r.Bn.getDocumentsMatchingQuery(t,e,n?s:it.min(),n?i:Pn())).next(t=>({documents:t,Gn:i})))}function yr(t,e){const n=U(t),r=U(n.ze),s=n.Un.get(e);return s?Promise.resolve(s.target):n.persistence.runTransaction("Get target data","readonly",t=>r.Et(t,e).next(t=>t?t.target:null))}function pr(t){const e=U(t);return e.persistence.runTransaction("Get new document changes","readonly",t=>(function(t,e,n){const r=U(t);let s=pn(),i=ai(n);const o=zi(e),a=IDBKeyRange.lowerBound(i,!0);return o.Kt({index:Cs.readTimeIndex,range:a},(t,e)=>{const n=ri(r.N,e);s=s.insert(n.key,n),i=e.readTime}).next(()=>({Tn:s,readTime:ci(i)}))})(e.jn,t,e.Kn)).then(({Tn:t,readTime:n})=>(e.Kn=n,t))}async function Er(t){const e=U(t);return e.persistence.runTransaction("Synchronize last document change read time","readonly",t=>(function(t){const e=zi(t);let n=it.min();return e.Kt({index:Cs.readTimeIndex,reverse:!0},(t,e,r)=>{e.readTime&&(n=ci(e.readTime)),r.done()}).next(()=>n)})(t)).then(t=>{e.Kn=t})}async function Tr(t,e,n,r){const s=U(t);let i=Pn(),o=pn(),a=An();for(const t of n){const n=e.zn(t.metadata.name);t.document&&(i=i.add(n)),o=o.insert(n,e.Hn(t)),a=a.insert(n,e.Jn(t.metadata.readTime))}const c=s.jn.newChangeBuffer({trackRemovals:!0}),u=await _r(s,function(t){return Ee(de(ut.fromString(`__bundle__/docs/${t}`)))}(r));return s.persistence.runTransaction("Apply bundle documents","readwrite",t=>dr(t,c,o,it.min(),a).next(e=>(c.apply(t),e)).next(e=>s.ze.removeMatchingKeysForTargetId(t,u.targetId).next(()=>s.ze.addMatchingKeys(t,i,u.targetId)).next(()=>s.Qn.vn(t,e)).next(()=>e)))}async function Ir(t,e,n=Pn()){const r=await _r(t,Ee(wi(e.bundledQuery))),s=U(t);return s.persistence.runTransaction("Save named query","readwrite",t=>{const i=Kn(e.readTime);if(r.snapshotVersion.compareTo(i)>=0)return s.Je.saveNamedQuery(t,e);const o=r.withResumeToken(wt.EMPTY_BYTE_STRING,i);return s.Un=s.Un.insert(o.targetId,o),s.ze.updateTargetData(t,o).next(()=>s.ze.removeMatchingKeysForTargetId(t,r.targetId)).next(()=>s.ze.addMatchingKeys(t,n,r.targetId)).next(()=>s.Je.saveNamedQuery(t,e))})}class Ar{constructor(t){this.N=t,this.Yn=new Map,this.Xn=new Map}getBundleMetadata(t,e){return Ks.resolve(this.Yn.get(e))}saveBundleMetadata(t,e){var n;return this.Yn.set(e.id,{id:(n=e).id,version:n.version,createTime:Kn(n.createTime)}),Ks.resolve()}getNamedQuery(t,e){return Ks.resolve(this.Xn.get(e))}saveNamedQuery(t,e){return this.Xn.set(e.name,function(t){return{name:t.name,query:wi(t.bundledQuery),readTime:Kn(t.readTime)}}(e)),Ks.resolve()}}class Rr{constructor(){this.Zn=new mn(Pr.ts),this.es=new mn(Pr.ns)}isEmpty(){return this.Zn.isEmpty()}addReference(t,e){const n=new Pr(t,e);this.Zn=this.Zn.add(n),this.es=this.es.add(n)}ss(t,e){t.forEach(t=>this.addReference(t,e))}removeReference(t,e){this.rs(new Pr(t,e))}os(t,e){t.forEach(t=>this.removeReference(t,e))}cs(t){const e=new Pt(new ut([])),n=new Pr(e,t),r=new Pr(e,t+1),s=[];return this.es.forEachInRange([n,r],t=>{this.rs(t),s.push(t.key)}),s}us(){this.Zn.forEach(t=>this.rs(t))}rs(t){this.Zn=this.Zn.delete(t),this.es=this.es.delete(t)}hs(t){const e=new Pt(new ut([])),n=new Pr(e,t),r=new Pr(e,t+1);let s=Pn();return this.es.forEachInRange([n,r],t=>{s=s.add(t.key)}),s}containsKey(t){const e=new Pr(t,0),n=this.Zn.firstAfterOrEqual(e);return null!==n&&t.isEqual(n.key)}}class Pr{constructor(t,e){this.key=t,this.ls=e}static ts(t,e){return Pt.comparator(t.key,e.key)||tt(t.ls,e.ls)}static ns(t,e){return tt(t.ls,e.ls)||Pt.comparator(t.key,e.key)}}class br{constructor(t,e){this.Ht=t,this.referenceDelegate=e,this.In=[],this.fs=1,this.ds=new mn(Pr.ts)}checkEmpty(t){return Ks.resolve(0===this.In.length)}addMutationBatch(t,e,n,r){const s=this.fs;this.fs++,this.In.length>0&&this.In[this.In.length-1];const i=new ei(s,e,n,r);this.In.push(i);for(const e of r)this.ds=this.ds.add(new Pr(e.key,s)),this.Ht.addToCollectionParentIndex(t,e.key.path.popLast());return Ks.resolve(i)}lookupMutationBatch(t,e){return Ks.resolve(this.ws(e))}getNextMutationBatchAfterBatchId(t,e){const n=e+1,r=this._s(n),s=r<0?0:r;return Ks.resolve(this.In.length>s?this.In[s]:null)}getHighestUnacknowledgedBatchId(){return Ks.resolve(0===this.In.length?-1:this.fs-1)}getAllMutationBatches(t){return Ks.resolve(this.In.slice())}getAllMutationBatchesAffectingDocumentKey(t,e){const n=new Pr(e,0),r=new Pr(e,Number.POSITIVE_INFINITY),s=[];return this.ds.forEachInRange([n,r],t=>{const e=this.ws(t.ls);s.push(e)}),Ks.resolve(s)}getAllMutationBatchesAffectingDocumentKeys(t,e){let n=new mn(tt);return e.forEach(t=>{const e=new Pr(t,0),r=new Pr(t,Number.POSITIVE_INFINITY);this.ds.forEachInRange([e,r],t=>{n=n.add(t.ls)})}),Ks.resolve(this.gs(n))}getAllMutationBatchesAffectingQuery(t,e){const n=e.path,r=n.length+1;let s=n;Pt.isDocumentKey(s)||(s=s.child(""));const i=new Pr(new Pt(s),0);let o=new mn(tt);return this.ds.forEachWhile(t=>{const e=t.key.path;return!!n.isPrefixOf(e)&&(e.length===r&&(o=o.add(t.ls)),!0)},i),Ks.resolve(this.gs(o))}gs(t){const e=[];return t.forEach(t=>{const n=this.ws(t);null!==n&&e.push(n)}),e}removeMutationBatch(t,e){L(0===this.ys(e.batchId,"removed")),this.In.shift();let n=this.ds;return Ks.forEach(e.mutations,r=>{const s=new Pr(r.key,e.batchId);return n=n.delete(s),this.referenceDelegate.markPotentiallyOrphaned(t,r.key)}).next(()=>{this.ds=n})}te(t){}containsKey(t,e){const n=new Pr(e,0),r=this.ds.firstAfterOrEqual(n);return Ks.resolve(e.isEqual(r&&r.key))}performConsistencyCheck(t){return this.In.length,Ks.resolve()}ys(t,e){return this._s(t)}_s(t){return 0===this.In.length?0:t-this.In[0].batchId}ws(t){const e=this._s(t);return e<0||e>=this.In.length?null:this.In[e]}}class vr{constructor(t,e){this.Ht=t,this.ps=e,this.docs=new dn(Pt.comparator),this.size=0}addEntry(t,e,n){const r=e.key,s=this.docs.get(r),i=s?s.size:0,o=this.ps(e);return this.docs=this.docs.insert(r,{document:e.clone(),size:o,readTime:n}),this.size+=o-i,this.Ht.addToCollectionParentIndex(t,r.path.popLast())}removeEntry(t){const e=this.docs.get(t);e&&(this.docs=this.docs.remove(t),this.size-=e.size)}getEntry(t,e){const n=this.docs.get(e);return Ks.resolve(n?n.document.clone():qt.newInvalidDocument(e))}getEntries(t,e){let n=pn();return e.forEach(t=>{const e=this.docs.get(t);n=n.insert(t,e?e.document.clone():qt.newInvalidDocument(t))}),Ks.resolve(n)}getDocumentsMatchingQuery(t,e,n){let r=pn();const s=new Pt(e.path.child("")),i=this.docs.getIteratorFrom(s);for(;i.hasNext();){const{key:t,value:{document:s,readTime:o}}=i.getNext();if(!e.path.isPrefixOf(t.path))break;o.compareTo(n)<=0||Pe(e,s)&&(r=r.insert(s.key,s.clone()))}return Ks.resolve(r)}Es(t,e){return Ks.forEach(this.docs,t=>e(t))}newChangeBuffer(t){return new Vr(this)}getSize(t){return Ks.resolve(this.size)}}class Vr extends ji{constructor(t){super(),this.Se=t}applyChanges(t){const e=[];return this.changes.forEach((n,r)=>{r.document.isValidDocument()?e.push(this.Se.addEntry(t,r.document,this.getReadTime(n))):this.Se.removeEntry(n)}),Ks.waitFor(e)}getFromCache(t,e){return this.Se.getEntry(t,e)}getAllFromCache(t,e){return this.Se.getEntries(t,e)}}class Sr{constructor(t){this.persistence=t,this.Ts=new Ki(t=>Qt(t),Gt),this.lastRemoteSnapshotVersion=it.min(),this.highestTargetId=0,this.Is=0,this.As=new Rr,this.targetCount=0,this.Rs=Ci.se()}forEachTarget(t,e){return this.Ts.forEach((t,n)=>e(n)),Ks.resolve()}getLastRemoteSnapshotVersion(t){return Ks.resolve(this.lastRemoteSnapshotVersion)}getHighestSequenceNumber(t){return Ks.resolve(this.Is)}allocateTargetId(t){return this.highestTargetId=this.Rs.next(),Ks.resolve(this.highestTargetId)}setTargetsMetadata(t,e,n){return n&&(this.lastRemoteSnapshotVersion=n),e>this.Is&&(this.Is=e),Ks.resolve()}ae(t){this.Ts.set(t.target,t);const e=t.targetId;e>this.highestTargetId&&(this.Rs=new Ci(e),this.highestTargetId=e),t.sequenceNumber>this.Is&&(this.Is=t.sequenceNumber)}addTargetData(t,e){return this.ae(e),this.targetCount+=1,Ks.resolve()}updateTargetData(t,e){return this.ae(e),Ks.resolve()}removeTargetData(t,e){return this.Ts.delete(e.target),this.As.cs(e.targetId),this.targetCount-=1,Ks.resolve()}removeTargets(t,e,n){let r=0;const s=[];return this.Ts.forEach((i,o)=>{o.sequenceNumber<=e&&null===n.get(o.targetId)&&(this.Ts.delete(i),s.push(this.removeMatchingKeysForTargetId(t,o.targetId)),r++)}),Ks.waitFor(s).next(()=>r)}getTargetCount(t){return Ks.resolve(this.targetCount)}getTargetData(t,e){const n=this.Ts.get(e)||null;return Ks.resolve(n)}addMatchingKeys(t,e,n){return this.As.ss(e,n),Ks.resolve()}removeMatchingKeys(t,e,n){this.As.os(e,n);const r=this.persistence.referenceDelegate,s=[];return r&&e.forEach(e=>{s.push(r.markPotentiallyOrphaned(t,e))}),Ks.waitFor(s)}removeMatchingKeysForTargetId(t,e){return this.As.cs(e),Ks.resolve()}getMatchingKeysForTargetId(t,e){const n=this.As.hs(e);return Ks.resolve(n)}containsKey(t,e){return Ks.resolve(this.As.containsKey(e))}}class Dr{constructor(t,e){this.Ps={},this.Le=new Y(0),this.Be=!1,this.Be=!0,this.referenceDelegate=t(this),this.ze=new Sr(this),this.Ht=new yi,this.He=function(t,e){return new vr(t,e)}(this.Ht,t=>this.referenceDelegate.bs(t)),this.N=new ii(e),this.Je=new Ar(this.N)}start(){return Promise.resolve()}shutdown(){return this.Be=!1,Promise.resolve()}get started(){return this.Be}setDatabaseDeletedListener(){}setNetworkEnabled(){}getIndexManager(){return this.Ht}getMutationQueue(t){let e=this.Ps[t.toKey()];return e||(e=new br(this.Ht,this.referenceDelegate),this.Ps[t.toKey()]=e),e}getTargetCache(){return this.ze}getRemoteDocumentCache(){return this.He}getBundleCache(){return this.Je}runTransaction(t,e,n){k("MemoryPersistence","Starting transaction:",t);const r=new Cr(this.Le.next());return this.referenceDelegate.vs(),n(r).next(t=>this.referenceDelegate.Vs(r).next(()=>t)).toPromise().then(t=>(r.raiseOnCommittedEvent(),t))}Ss(t,e){return Ks.or(Object.values(this.Ps).map(n=>()=>n.containsKey(t,e)))}}class Cr extends qs{constructor(t){super(),this.currentSequenceNumber=t}}class Nr{constructor(t){this.persistence=t,this.Ds=new Rr,this.Cs=null}static Ns(t){return new Nr(t)}get xs(){if(this.Cs)return this.Cs;throw M()}addReference(t,e,n){return this.Ds.addReference(n,e),this.xs.delete(n.toString()),Ks.resolve()}removeReference(t,e,n){return this.Ds.removeReference(n,e),this.xs.add(n.toString()),Ks.resolve()}markPotentiallyOrphaned(t,e){return this.xs.add(e.toString()),Ks.resolve()}removeTarget(t,e){this.Ds.cs(e.targetId).forEach(t=>this.xs.add(t.toString()));const n=this.persistence.getTargetCache();return n.getMatchingKeysForTargetId(t,e.targetId).next(t=>{t.forEach(t=>this.xs.add(t.toString()))}).next(()=>n.removeTargetData(t,e))}vs(){this.Cs=new Set}Vs(t){const e=this.persistence.getRemoteDocumentCache().newChangeBuffer();return Ks.forEach(this.xs,n=>{const r=Pt.fromPath(n);return this.ks(t,r).next(t=>{t||e.removeEntry(r)})}).next(()=>(this.Cs=null,e.apply(t)))}updateLimboDocument(t,e){return this.ks(t,e).next(t=>{t?this.xs.delete(e.toString()):this.xs.add(e.toString())})}bs(t){return 0}ks(t,e){return Ks.or([()=>Ks.resolve(this.Ds.containsKey(e)),()=>this.persistence.getTargetCache().containsKey(t,e),()=>this.persistence.Ss(t,e)])}}function xr(t,e){return`firestore_clients_${t}_${e}`}function kr(t,e,n){let r=`firestore_mutations_${t}_${n}`;return e.isAuthenticated()&&(r+=`_${e.uid}`),r}function $r(t,e){return`firestore_targets_${t}_${e}`}class Or{constructor(t,e,n,r){this.user=t,this.batchId=e,this.state=n,this.error=r}static $s(t,e,n){const r=JSON.parse(n);let s,i="object"==typeof r&&-1!==["pending","acknowledged","rejected"].indexOf(r.state)&&(void 0===r.error||"object"==typeof r.error);return i&&r.error&&((i="string"==typeof r.error.message&&"string"==typeof r.error.code)&&(s=new K(r.error.code,r.error.message))),i?new Or(t,e,r.state,s):($("SharedClientState",`Failed to parse mutation state for ID '${e}': ${n}`),null)}Os(){const t={state:this.state,updateTimeMs:Date.now()};return this.error&&(t.error={code:this.error.code,message:this.error.message}),JSON.stringify(t)}}class Fr{constructor(t,e,n){this.targetId=t,this.state=e,this.error=n}static $s(t,e){const n=JSON.parse(e);let r,s="object"==typeof n&&-1!==["not-current","current","rejected"].indexOf(n.state)&&(void 0===n.error||"object"==typeof n.error);return s&&n.error&&((s="string"==typeof n.error.message&&"string"==typeof n.error.code)&&(r=new K(n.error.code,n.error.message))),s?new Fr(t,n.state,r):($("SharedClientState",`Failed to parse target state for ID '${t}': ${e}`),null)}Os(){const t={state:this.state,updateTimeMs:Date.now()};return this.error&&(t.error={code:this.error.code,message:this.error.message}),JSON.stringify(t)}}class Mr{constructor(t,e){this.clientId=t,this.activeTargetIds=e}static $s(t,e){const n=JSON.parse(e);let r="object"==typeof n&&n.activeTargetIds instanceof Array,s=vn();for(let t=0;r&&t<n.activeTargetIds.length;++t)r=Rt(n.activeTargetIds[t]),s=s.add(n.activeTargetIds[t]);return r?new Mr(t,s):($("SharedClientState",`Failed to parse client data for instance '${t}': ${e}`),null)}}class Lr{constructor(t,e){this.clientId=t,this.onlineState=e}static $s(t){const e=JSON.parse(t);return"object"==typeof e&&-1!==["Unknown","Online","Offline"].indexOf(e.onlineState)&&"string"==typeof e.clientId?new Lr(e.clientId,e.onlineState):($("SharedClientState",`Failed to parse online state: ${t}`),null)}}class Br{constructor(){this.activeTargetIds=vn()}Fs(t){this.activeTargetIds=this.activeTargetIds.add(t)}Ms(t){this.activeTargetIds=this.activeTargetIds.delete(t)}Os(){const t={activeTargetIds:this.activeTargetIds.toArray(),updateTimeMs:Date.now()};return JSON.stringify(t)}}class Ur{constructor(t,e,n,r,s){this.window=t,this.Oe=e,this.persistenceKey=n,this.Ls=r,this.syncEngine=null,this.onlineStateHandler=null,this.sequenceNumberHandler=null,this.Bs=this.Us.bind(this),this.qs=new dn(tt),this.started=!1,this.Ks=[];const i=n.replace(/[.*+?^${}()|[\]\\]/g,"\\$&");this.storage=this.window.localStorage,this.currentUser=s,this.js=xr(this.persistenceKey,this.Ls),this.Qs=function(t){return`firestore_sequence_number_${t}`}(this.persistenceKey),this.qs=this.qs.insert(this.Ls,new Br),this.Ws=new RegExp(`^firestore_clients_${i}_([^_]*)$`),this.Gs=new RegExp(`^firestore_mutations_${i}_(\\d+)(?:_(.*))?$`),this.zs=new RegExp(`^firestore_targets_${i}_(\\d+)$`),this.Hs=function(t){return`firestore_online_state_${t}`}(this.persistenceKey),this.Js=function(t){return`firestore_bundle_loaded_${t}`}(this.persistenceKey),this.window.addEventListener("storage",this.Bs)}static Pt(t){return!(!t||!t.localStorage)}async start(){const t=await this.syncEngine.pn();for(const e of t){if(e===this.Ls)continue;const t=this.getItem(xr(this.persistenceKey,e));if(t){const n=Mr.$s(e,t);n&&(this.qs=this.qs.insert(n.clientId,n))}}this.Ys();const e=this.storage.getItem(this.Hs);if(e){const t=this.Xs(e);t&&this.Zs(t)}for(const t of this.Ks)this.Us(t);this.Ks=[],this.window.addEventListener("pagehide",()=>this.shutdown()),this.started=!0}writeSequenceNumber(t){this.setItem(this.Qs,JSON.stringify(t))}getAllActiveQueryTargets(){return this.ti(this.qs)}isActiveQueryTarget(t){let e=!1;return this.qs.forEach((n,r)=>{r.activeTargetIds.has(t)&&(e=!0)}),e}addPendingMutation(t){this.ei(t,"pending")}updateMutationState(t,e,n){this.ei(t,e,n),this.ni(t)}addLocalQueryTarget(t){let e="not-current";if(this.isActiveQueryTarget(t)){const n=this.storage.getItem($r(this.persistenceKey,t));if(n){const r=Fr.$s(t,n);r&&(e=r.state)}}return this.si.Fs(t),this.Ys(),e}removeLocalQueryTarget(t){this.si.Ms(t),this.Ys()}isLocalQueryTarget(t){return this.si.activeTargetIds.has(t)}clearQueryState(t){this.removeItem($r(this.persistenceKey,t))}updateQueryState(t,e,n){this.ii(t,e,n)}handleUserChange(t,e,n){e.forEach(t=>{this.ni(t)}),this.currentUser=t,n.forEach(t=>{this.addPendingMutation(t)})}setOnlineState(t){this.ri(t)}notifyBundleLoaded(){this.oi()}shutdown(){this.started&&(this.window.removeEventListener("storage",this.Bs),this.removeItem(this.js),this.started=!1)}getItem(t){const e=this.storage.getItem(t);return k("SharedClientState","READ",t,e),e}setItem(t,e){k("SharedClientState","SET",t,e),this.storage.setItem(t,e)}removeItem(t){k("SharedClientState","REMOVE",t),this.storage.removeItem(t)}Us(t){const e=t;if(e.storageArea===this.storage){if(k("SharedClientState","EVENT",e.key,e.newValue),e.key===this.js)return void $("Received WebStorage notification for local change. Another client might have garbage-collected our state");this.Oe.enqueueRetryable(async()=>{if(this.started){if(null!==e.key)if(this.Ws.test(e.key)){if(null==e.newValue){const t=this.ai(e.key);return this.ci(t,null)}{const t=this.ui(e.key,e.newValue);if(t)return this.ci(t.clientId,t)}}else if(this.Gs.test(e.key)){if(null!==e.newValue){const t=this.hi(e.key,e.newValue);if(t)return this.li(t)}}else if(this.zs.test(e.key)){if(null!==e.newValue){const t=this.fi(e.key,e.newValue);if(t)return this.di(t)}}else if(e.key===this.Hs){if(null!==e.newValue){const t=this.Xs(e.newValue);if(t)return this.Zs(t)}}else if(e.key===this.Qs){const t=function(t){let e=Y.T;if(null!=t)try{const n=JSON.parse(t);L("number"==typeof n),e=n}catch(t){$("SharedClientState","Failed to read sequence number from WebStorage",t)}return e}(e.newValue);t!==Y.T&&this.sequenceNumberHandler(t)}else if(e.key===this.Js)return this.syncEngine.wi()}else this.Ks.push(e)})}}get si(){return this.qs.get(this.Ls)}Ys(){this.setItem(this.js,this.si.Os())}ei(t,e,n){const r=new Or(this.currentUser,t,e,n),s=kr(this.persistenceKey,this.currentUser,t);this.setItem(s,r.Os())}ni(t){const e=kr(this.persistenceKey,this.currentUser,t);this.removeItem(e)}ri(t){const e={clientId:this.Ls,onlineState:t};this.storage.setItem(this.Hs,JSON.stringify(e))}ii(t,e,n){const r=$r(this.persistenceKey,t),s=new Fr(t,e,n);this.setItem(r,s.Os())}oi(){this.setItem(this.Js,"value-not-used")}ai(t){const e=this.Ws.exec(t);return e?e[1]:null}ui(t,e){const n=this.ai(t);return Mr.$s(n,e)}hi(t,e){const n=this.Gs.exec(t),r=Number(n[1]),s=void 0!==n[2]?n[2]:null;return Or.$s(new S(s),r,e)}fi(t,e){const n=this.zs.exec(t),r=Number(n[1]);return Fr.$s(r,e)}Xs(t){return Lr.$s(t)}async li(t){if(t.user.uid===this.currentUser.uid)return this.syncEngine._i(t.batchId,t.state,t.error);k("SharedClientState",`Ignoring mutation for non-active user ${t.user.uid}`)}di(t){return this.syncEngine.mi(t.targetId,t.state,t.error)}ci(t,e){const n=e?this.qs.insert(t,e):this.qs.remove(t),r=this.ti(this.qs),s=this.ti(n),i=[],o=[];return s.forEach(t=>{r.has(t)||i.push(t)}),r.forEach(t=>{s.has(t)||o.push(t)}),this.syncEngine.gi(i,o).then(()=>{this.qs=n})}Zs(t){this.qs.get(t.clientId)&&this.onlineStateHandler(t.onlineState)}ti(t){let e=vn();return t.forEach((t,n)=>{e=e.unionWith(n.activeTargetIds)}),e}}class qr{constructor(){this.yi=new Br,this.pi={},this.onlineStateHandler=null,this.sequenceNumberHandler=null}addPendingMutation(t){}updateMutationState(t,e,n){}addLocalQueryTarget(t){return this.yi.Fs(t),this.pi[t]||"not-current"}updateQueryState(t,e,n){this.pi[t]=e}removeLocalQueryTarget(t){this.yi.Ms(t)}isLocalQueryTarget(t){return this.yi.activeTargetIds.has(t)}clearQueryState(t){delete this.pi[t]}getAllActiveQueryTargets(){return this.yi.activeTargetIds}isActiveQueryTarget(t){return this.yi.activeTargetIds.has(t)}start(){return this.yi=new Br,Promise.resolve()}handleUserChange(t,e,n){}setOnlineState(t){}shutdown(){}writeSequenceNumber(t){}notifyBundleLoaded(){}}class Kr{Ei(t){}shutdown(){}}class jr{constructor(){this.Ti=(()=>this.Ii()),this.Ai=(()=>this.Ri()),this.Pi=[],this.bi()}Ei(t){this.Pi.push(t)}shutdown(){window.removeEventListener("online",this.Ti),window.removeEventListener("offline",this.Ai)}bi(){window.addEventListener("online",this.Ti),window.addEventListener("offline",this.Ai)}Ii(){k("ConnectivityMonitor","Network connectivity changed: AVAILABLE");for(const t of this.Pi)t(0)}Ri(){k("ConnectivityMonitor","Network connectivity changed: UNAVAILABLE");for(const t of this.Pi)t(1)}static Pt(){return"undefined"!=typeof window&&void 0!==window.addEventListener&&void 0!==window.removeEventListener}}const Qr={BatchGetDocuments:"batchGet",Commit:"commit",RunQuery:"runQuery"};class Wr{constructor(t){this.vi=t.vi,this.Vi=t.Vi}Si(t){this.Di=t}Ci(t){this.Ni=t}onMessage(t){this.xi=t}close(){this.Vi()}send(t){this.vi(t)}ki(){this.Di()}$i(t){this.Ni(t)}Oi(t){this.xi(t)}}class Gr extends class{constructor(t){this.databaseInfo=t,this.databaseId=t.databaseId;const e=t.ssl?"https":"http";this.Fi=e+"://"+t.host,this.Mi="projects/"+this.databaseId.projectId+"/databases/"+this.databaseId.database+"/documents"}Li(t,e,n,r){const s=this.Bi(t,e);k("RestConnection","Sending: ",s,n);const i={};return this.Ui(i,r),this.qi(t,s,i,n).then(t=>(k("RestConnection","Received: ",t),t),e=>{throw O("RestConnection",`${t} failed with error: `,e,"url: ",s,"request:",n),e})}Ki(t,e,n,r){return this.Li(t,e,n,r)}Ui(t,e){if(t["X-Goog-Api-Client"]="gl-js/ fire/"+D,t["Content-Type"]="text/plain",this.databaseInfo.appId&&(t["X-Firebase-GMPID"]=this.databaseInfo.appId),e)for(const n in e.authHeaders)e.authHeaders.hasOwnProperty(n)&&(t[n]=e.authHeaders[n])}Bi(t,e){const n=Qr[t];return`${this.Fi}/v1/${e}:${n}`}}{constructor(t){super(t),this.forceLongPolling=t.forceLongPolling,this.autoDetectLongPolling=t.autoDetectLongPolling,this.useFetchStreams=t.useFetchStreams}qi(t,e,n,r){return new Promise((s,i)=>{const o=new XhrIo;o.listenOnce(EventType.COMPLETE,()=>{try{switch(o.getLastErrorCode()){case ErrorCode.NO_ERROR:const e=o.getResponseJson();k("Connection","XHR received:",JSON.stringify(e)),s(e);break;case ErrorCode.TIMEOUT:k("Connection",'RPC "'+t+'" timed out'),i(new K(q.DEADLINE_EXCEEDED,"Request time out"));break;case ErrorCode.HTTP_ERROR:const n=o.getStatus();if(k("Connection",'RPC "'+t+'" failed with status:',n,"response text:",o.getResponseText()),n>0){const t=o.getResponseJson().error;if(t&&t.status&&t.message){const e=function(t){const e=t.toLowerCase().replace(/_/g,"-");return Object.values(q).indexOf(e)>=0?e:q.UNKNOWN}(t.status);i(new K(e,t.message))}else i(new K(q.UNKNOWN,"Server responded with status "+o.getStatus()))}else i(new K(q.UNAVAILABLE,"Connection failed."));break;default:M()}}finally{k("Connection",'RPC "'+t+'" completed.')}});const a=JSON.stringify(r);o.send(e,"POST",a,n,15)})}ji(t,e){const n=[this.Fi,"/","google.firestore.v1.Firestore","/",t,"/channel"],r=createWebChannelTransport(),s=getStatEventTarget(),i={httpSessionIdParam:"gsessionid",initMessageHeaders:{},messageUrlParams:{database:`projects/${this.databaseId.projectId}/databases/${this.databaseId.database}`},sendRawJson:!0,supportsCrossDomainXhr:!0,internalChannelParams:{forwardChannelRequestTimeoutMs:6e5},forceLongPolling:this.forceLongPolling,detectBufferingProxy:this.autoDetectLongPolling};this.useFetchStreams&&(i.xmlHttpFactory=new FetchXmlHttpFactory({})),this.Ui(i.initMessageHeaders,e),isMobileCordova()||isReactNative()||isElectron()||isIE()||isUWP()||isBrowserExtension()||(i.httpHeadersOverwriteParam="$httpHeaders");const o=n.join("");k("Connection","Creating WebChannel: "+o,i);const a=r.createWebChannel(o,i);let c=!1,u=!1;const h=new Wr({vi:t=>{u?k("Connection","Not sending because WebChannel is closed:",t):(c||(k("Connection","Opening WebChannel transport."),a.open(),c=!0),k("Connection","WebChannel sending:",t),a.send(t))},Vi:()=>a.close()}),l=(t,e,n)=>{t.listen(e,t=>{try{n(t)}catch(t){setTimeout(()=>{throw t},0)}})};return l(a,WebChannel.EventType.OPEN,()=>{u||k("Connection","WebChannel transport opened.")}),l(a,WebChannel.EventType.CLOSE,()=>{u||(u=!0,k("Connection","WebChannel transport closed"),h.$i())}),l(a,WebChannel.EventType.ERROR,t=>{u||(u=!0,O("Connection","WebChannel transport errored:",t),h.$i(new K(q.UNAVAILABLE,"The operation could not be completed")))}),l(a,WebChannel.EventType.MESSAGE,t=>{var e;if(!u){const n=t.data[0];L(!!n);const r=n,s=r.error||(null===(e=r[0])||void 0===e?void 0:e.error);if(s){k("Connection","WebChannel received error:",s);const t=s.status;let e=function(t){const e=un[t];if(void 0!==e)return fn(e)}(t),n=s.message;void 0===e&&(e=q.INTERNAL,n="Unknown error status: "+t+" with message "+s.message),u=!0,h.$i(new K(e,n)),a.close()}else k("Connection","WebChannel received:",n),h.Oi(n)}}),l(s,Event.STAT_EVENT,t=>{t.stat===Stat.PROXY?k("Connection","Detected buffering proxy"):t.stat===Stat.NOPROXY&&k("Connection","Detected no buffering proxy")}),setTimeout(()=>{h.ki()},0),h}}function zr(){return"undefined"!=typeof window?window:null}function Hr(){return"undefined"!=typeof document?document:null}function Jr(t){return new Ln(t,!0)}class Yr{constructor(t,e,n=1e3,r=1.5,s=6e4){this.Oe=t,this.timerId=e,this.Qi=n,this.Wi=r,this.Gi=s,this.zi=0,this.Hi=null,this.Ji=Date.now(),this.reset()}reset(){this.zi=0}Yi(){this.zi=this.Gi}Xi(t){this.cancel();const e=Math.floor(this.zi+this.Zi()),n=Math.max(0,Date.now()-this.Ji),r=Math.max(0,e-n);r>0&&k("ExponentialBackoff",`Backing off for ${r} ms (base delay: ${this.zi} ms, delay with jitter: ${e} ms, last attempt: ${n} ms ago)`),this.Hi=this.Oe.enqueueAfterDelay(this.timerId,r,()=>(this.Ji=Date.now(),t())),this.zi*=this.Wi,this.zi<this.Qi&&(this.zi=this.Qi),this.zi>this.Gi&&(this.zi=this.Gi)}tr(){null!==this.Hi&&(this.Hi.skipDelay(),this.Hi=null)}cancel(){null!==this.Hi&&(this.Hi.cancel(),this.Hi=null)}Zi(){return(Math.random()-.5)*this.zi}}class Xr{constructor(t,e,n,r,s,i){this.Oe=t,this.er=n,this.nr=r,this.credentialsProvider=s,this.listener=i,this.state=0,this.sr=0,this.ir=null,this.stream=null,this.rr=new Yr(t,e)}ar(){return 1===this.state||2===this.state||4===this.state}cr(){return 2===this.state}start(){3!==this.state?this.auth():this.ur()}async stop(){this.ar()&&await this.close(0)}hr(){this.state=0,this.rr.reset()}lr(){this.cr()&&null===this.ir&&(this.ir=this.Oe.enqueueAfterDelay(this.er,6e4,()=>this.dr()))}wr(t){this._r(),this.stream.send(t)}async dr(){if(this.cr())return this.close(0)}_r(){this.ir&&(this.ir.cancel(),this.ir=null)}async close(t,e){this._r(),this.rr.cancel(),this.sr++,3!==t?this.rr.reset():e&&e.code===q.RESOURCE_EXHAUSTED?($(e.toString()),$("Using maximum backoff delay to prevent overloading the backend."),this.rr.Yi()):e&&e.code===q.UNAUTHENTICATED&&this.credentialsProvider.invalidateToken(),null!==this.stream&&(this.mr(),this.stream.close(),this.stream=null),this.state=t,await this.listener.Ci(e)}mr(){}auth(){this.state=1;const t=this.gr(this.sr),e=this.sr;this.credentialsProvider.getToken().then(t=>{this.sr===e&&this.yr(t)},e=>{t(()=>{const t=new K(q.UNKNOWN,"Fetching auth token failed: "+e.message);return this.pr(t)})})}yr(t){const e=this.gr(this.sr);this.stream=this.Er(t),this.stream.Si(()=>{e(()=>(this.state=2,this.listener.Si()))}),this.stream.Ci(t=>{e(()=>this.pr(t))}),this.stream.onMessage(t=>{e(()=>this.onMessage(t))})}ur(){this.state=4,this.rr.Xi(async()=>{this.state=0,this.start()})}pr(t){return k("PersistentStream",`close with error: ${t}`),this.stream=null,this.close(3,t)}gr(t){return e=>{this.Oe.enqueueAndForget(()=>this.sr===t?e():(k("PersistentStream","stream callback skipped by getCloseGuardedDispatcher."),Promise.resolve()))}}}class Zr extends Xr{constructor(t,e,n,r,s){super(t,"listen_stream_connection_backoff","listen_stream_idle",e,n,s),this.N=r}Er(t){return this.nr.ji("Listen",t)}onMessage(t){this.rr.reset();const e=es(this.N,t),n=function(t){if(!("targetChange"in t))return it.min();const e=t.targetChange;return e.targetIds&&e.targetIds.length?it.min():e.readTime?Kn(e.readTime):it.min()}(t);return this.listener.Tr(e,n)}Ir(t){const e={};e.database=Jn(this.N),e.addTarget=function(t,e){let n;const r=e.target;return(n=zt(r)?{documents:rs(t,r)}:{query:os(t,r)}).targetId=e.targetId,e.resumeToken.approximateByteSize()>0?n.resumeToken=Un(t,e.resumeToken):e.snapshotVersion.compareTo(it.min())>0&&(n.readTime=Bn(t,e.snapshotVersion.toTimestamp())),n}(this.N,t);const n=cs(this.N,t);n&&(e.labels=n),this.wr(e)}Ar(t){const e={};e.database=Jn(this.N),e.removeTarget=t,this.wr(e)}}class to extends Xr{constructor(t,e,n,r,s){super(t,"write_stream_connection_backoff","write_stream_idle",e,n,s),this.N=r,this.Rr=!1}get Pr(){return this.Rr}start(){this.Rr=!1,this.lastStreamToken=void 0,super.start()}mr(){this.Rr&&this.br([])}Er(t){return this.nr.ji("Write",t)}onMessage(t){if(L(!!t.streamToken),this.lastStreamToken=t.streamToken,this.Rr){this.rr.reset();const e=is(t.writeResults,t.commitTime),n=Kn(t.commitTime);return this.listener.vr(n,e)}return L(!t.writeResults||0===t.writeResults.length),this.Rr=!0,this.listener.Vr()}Sr(){const t={};t.database=Jn(this.N),this.wr(t)}br(t){const e={streamToken:this.lastStreamToken,writes:t.map(t=>ns(this.N,t))};this.wr(e)}}class eo extends class{}{constructor(t,e,n){super(),this.credentials=t,this.nr=e,this.N=n,this.Dr=!1}Cr(){if(this.Dr)throw new K(q.FAILED_PRECONDITION,"The client has already been terminated.")}Li(t,e,n){return this.Cr(),this.credentials.getToken().then(r=>this.nr.Li(t,e,n,r)).catch(t=>{throw"FirebaseError"===t.name?(t.code===q.UNAUTHENTICATED&&this.credentials.invalidateToken(),t):new K(q.UNKNOWN,t.toString())})}Ki(t,e,n){return this.Cr(),this.credentials.getToken().then(r=>this.nr.Ki(t,e,n,r)).catch(t=>{throw"FirebaseError"===t.name?(t.code===q.UNAUTHENTICATED&&this.credentials.invalidateToken(),t):new K(q.UNKNOWN,t.toString())})}terminate(){this.Dr=!0}}class no{constructor(t,e){this.asyncQueue=t,this.onlineStateHandler=e,this.state="Unknown",this.Nr=0,this.kr=null,this.$r=!0}Or(){0===this.Nr&&(this.Fr("Unknown"),this.kr=this.asyncQueue.enqueueAfterDelay("online_state_timeout",1e4,()=>(this.kr=null,this.Mr("Backend didn't respond within 10 seconds."),this.Fr("Offline"),Promise.resolve())))}Lr(t){"Online"===this.state?this.Fr("Unknown"):(this.Nr++,this.Nr>=1&&(this.Br(),this.Mr(`Connection failed 1 times. Most recent error: ${t.toString()}`),this.Fr("Offline")))}set(t){this.Br(),this.Nr=0,"Online"===t&&(this.$r=!1),this.Fr(t)}Fr(t){t!==this.state&&(this.state=t,this.onlineStateHandler(t))}Mr(t){const e=`Could not reach Cloud Firestore backend. ${t}\nThis typically indicates that your device does not have a healthy Internet connection at the moment. The client will operate in offline mode until it is able to successfully connect to the backend.`;this.$r?($(e),this.$r=!1):k("OnlineStateTracker",e)}Br(){null!==this.kr&&(this.kr.cancel(),this.kr=null)}}class so{constructor(t,e,n,r,s){this.localStore=t,this.datastore=e,this.asyncQueue=n,this.remoteSyncer={},this.Ur=[],this.qr=new Map,this.Kr=new Set,this.jr=[],this.Qr=s,this.Qr.Ei(t=>{n.enqueueAndForget(async()=>{fo(this)&&(k("RemoteStore","Restarting streams for network reachability change."),await async function(t){const e=U(t);e.Kr.add(4),await ro(e),e.Wr.set("Unknown"),e.Kr.delete(4),await io(e)}(this))})}),this.Wr=new no(n,r)}}async function io(t){if(fo(t))for(const e of t.jr)await e(!0)}async function ro(t){for(const e of t.jr)await e(!1)}function oo(t,e){const n=U(t);n.qr.has(e.targetId)||(n.qr.set(e.targetId,e),lo(n)?ho(n):Do(n).cr()&&co(n,e))}function ao(t,e){const n=U(t),r=Do(n);n.qr.delete(e),r.cr()&&uo(n,e),0===n.qr.size&&(r.cr()?r.lr():fo(n)&&n.Wr.set("Unknown"))}function co(t,e){t.Gr.Y(e.targetId),Do(t).Ir(e)}function uo(t,e){t.Gr.Y(e),Do(t).Ar(e)}function ho(t){t.Gr=new kn({getRemoteKeysForTarget:e=>t.remoteSyncer.getRemoteKeysForTarget(e),Et:e=>t.qr.get(e)||null}),Do(t).start(),t.Wr.Or()}function lo(t){return fo(t)&&!Do(t).ar()&&t.qr.size>0}function fo(t){return 0===U(t).Kr.size}function wo(t){t.Gr=void 0}async function _o(t){t.qr.forEach((e,n)=>{co(t,e)})}async function mo(t,e){wo(t),lo(t)?(t.Wr.Lr(e),ho(t)):t.Wr.set("Unknown")}async function go(t,e,n){if(t.Wr.set("Online"),e instanceof Nn&&2===e.state&&e.cause)try{await async function(t,e){const n=e.cause;for(const r of e.targetIds)t.qr.has(r)&&(await t.remoteSyncer.rejectListen(r,n),t.qr.delete(r),t.Gr.removeTarget(r))}(t,e)}catch(n){k("RemoteStore","Failed to remove targets %s: %s ",e.targetIds.join(","),n),await yo(t,n)}else if(e instanceof Dn?t.Gr.rt(e):e instanceof Cn?t.Gr.ft(e):t.Gr.ct(e),!n.isEqual(it.min()))try{const r=await lr(t.localStore);n.compareTo(r)>=0&&await function(t,e){const n=t.Gr._t(e);return n.targetChanges.forEach((n,r)=>{if(n.resumeToken.approximateByteSize()>0){const s=t.qr.get(r);s&&t.qr.set(r,s.withResumeToken(n.resumeToken,e))}}),n.targetMismatches.forEach(e=>{const n=t.qr.get(e);if(!n)return;t.qr.set(e,n.withResumeToken(wt.EMPTY_BYTE_STRING,n.snapshotVersion)),uo(t,e);const r=new si(n.target,e,1,n.sequenceNumber);co(t,r)}),t.remoteSyncer.applyRemoteEvent(n)}(t,n)}catch(e){k("RemoteStore","Failed to raise snapshot:",e),await yo(t,e)}}async function yo(t,e,n){if(!zs(e))throw e;t.Kr.add(1),await ro(t),t.Wr.set("Offline"),n||(n=(()=>lr(t.localStore))),t.asyncQueue.enqueueRetryable(async()=>{k("RemoteStore","Retrying IndexedDB access"),await n(),t.Kr.delete(1),await io(t)})}function po(t,e){return e().catch(n=>yo(t,n,e))}async function Eo(t){const e=U(t),n=Co(e);let r=e.Ur.length>0?e.Ur[e.Ur.length-1].batchId:-1;for(;To(e);)try{const s=await wr(e.localStore,r);if(null===s){0===e.Ur.length&&n.lr();break}r=s.batchId,Io(e,s)}catch(t){await yo(e,t)}Ao(e)&&Ro(e)}function To(t){return fo(t)&&t.Ur.length<10}function Io(t,e){t.Ur.push(e);const n=Co(t);n.cr()&&n.Pr&&n.br(e.mutations)}function Ao(t){return fo(t)&&!Co(t).ar()&&t.Ur.length>0}function Ro(t){Co(t).start()}async function Po(t){Co(t).Sr()}async function bo(t){const e=Co(t);for(const n of t.Ur)e.br(n.mutations)}async function vo(t,e,n){const r=t.Ur.shift(),s=ni.from(r,e,n);await po(t,()=>t.remoteSyncer.applySuccessfulWrite(s)),await Eo(t)}async function Vo(t,e){e&&Co(t).Pr&&await async function(t,e){if(ln(n=e.code)&&n!==q.ABORTED){const n=t.Ur.shift();Co(t).hr(),await po(t,()=>t.remoteSyncer.rejectFailedWrite(n.batchId,e)),await Eo(t)}var n}(t,e),Ao(t)&&Ro(t)}async function So(t,e){const n=U(t);e?(n.Kr.delete(2),await io(n)):e||(n.Kr.add(2),await ro(n),n.Wr.set("Unknown"))}function Do(t){return t.zr||(t.zr=function(t,e,n){const r=U(t);return r.Cr(),new Zr(e,r.nr,r.credentials,r.N,n)}(t.datastore,t.asyncQueue,{Si:_o.bind(null,t),Ci:mo.bind(null,t),Tr:go.bind(null,t)}),t.jr.push(async e=>{e?(t.zr.hr(),lo(t)?ho(t):t.Wr.set("Unknown")):(await t.zr.stop(),wo(t))})),t.zr}function Co(t){return t.Hr||(t.Hr=function(t,e,n){const r=U(t);return r.Cr(),new to(e,r.nr,r.credentials,r.N,n)}(t.datastore,t.asyncQueue,{Si:Po.bind(null,t),Ci:Vo.bind(null,t),Vr:bo.bind(null,t),vr:vo.bind(null,t)}),t.jr.push(async e=>{e?(t.Hr.hr(),await Eo(t)):(await t.Hr.stop(),t.Ur.length>0&&(k("RemoteStore",`Stopping write stream with ${t.Ur.length} pending writes`),t.Ur=[]))})),t.Hr}class No{constructor(t,e,n,r,s){this.asyncQueue=t,this.timerId=e,this.targetTimeMs=n,this.op=r,this.removalCallback=s,this.deferred=new j,this.then=this.deferred.promise.then.bind(this.deferred.promise),this.deferred.promise.catch(t=>{})}static createAndSchedule(t,e,n,r,s){const i=Date.now()+n,o=new No(t,e,i,r,s);return o.start(n),o}start(t){this.timerHandle=setTimeout(()=>this.handleDelayElapsed(),t)}skipDelay(){return this.handleDelayElapsed()}cancel(t){null!==this.timerHandle&&(this.clearTimeout(),this.deferred.reject(new K(q.CANCELLED,"Operation cancelled"+(t?": "+t:""))))}handleDelayElapsed(){this.asyncQueue.enqueueAndForget(()=>null!==this.timerHandle?(this.clearTimeout(),this.op().then(t=>this.deferred.resolve(t))):Promise.resolve())}clearTimeout(){null!==this.timerHandle&&(this.removalCallback(this),clearTimeout(this.timerHandle),this.timerHandle=null)}}function xo(t,e){if($("AsyncQueue",`${e}: ${t}`),zs(t))return new K(q.UNAVAILABLE,`${e}: ${t}`);throw t}class ko{constructor(t){this.comparator=t?(e,n)=>t(e,n)||Pt.comparator(e.key,n.key):(t,e)=>Pt.comparator(t.key,e.key),this.keyedMap=Tn(),this.sortedSet=new dn(this.comparator)}static emptySet(t){return new ko(t.comparator)}has(t){return null!=this.keyedMap.get(t)}get(t){return this.keyedMap.get(t)}first(){return this.sortedSet.minKey()}last(){return this.sortedSet.maxKey()}isEmpty(){return this.sortedSet.isEmpty()}indexOf(t){const e=this.keyedMap.get(t);return e?this.sortedSet.indexOf(e):-1}get size(){return this.sortedSet.size}forEach(t){this.sortedSet.inorderTraversal((e,n)=>(t(e),!1))}add(t){const e=this.delete(t.key);return e.copy(e.keyedMap.insert(t.key,t),e.sortedSet.insert(t,null))}delete(t){const e=this.get(t);return e?this.copy(this.keyedMap.remove(t),this.sortedSet.remove(e)):this}isEqual(t){if(!(t instanceof ko))return!1;if(this.size!==t.size)return!1;const e=this.sortedSet.getIterator(),n=t.sortedSet.getIterator();for(;e.hasNext();){const t=e.getNext().key,r=n.getNext().key;if(!t.isEqual(r))return!1}return!0}toString(){const t=[];return this.forEach(e=>{t.push(e.toString())}),0===t.length?"DocumentSet ()":"DocumentSet (\n  "+t.join("  \n")+"\n)"}copy(t,e){const n=new ko;return n.comparator=this.comparator,n.keyedMap=t,n.sortedSet=e,n}}class $o{constructor(){this.Jr=new dn(Pt.comparator)}track(t){const e=t.doc.key,n=this.Jr.get(e);n?0!==t.type&&3===n.type?this.Jr=this.Jr.insert(e,t):3===t.type&&1!==n.type?this.Jr=this.Jr.insert(e,{type:n.type,doc:t.doc}):2===t.type&&2===n.type?this.Jr=this.Jr.insert(e,{type:2,doc:t.doc}):2===t.type&&0===n.type?this.Jr=this.Jr.insert(e,{type:0,doc:t.doc}):1===t.type&&0===n.type?this.Jr=this.Jr.remove(e):1===t.type&&2===n.type?this.Jr=this.Jr.insert(e,{type:1,doc:n.doc}):0===t.type&&1===n.type?this.Jr=this.Jr.insert(e,{type:2,doc:t.doc}):M():this.Jr=this.Jr.insert(e,t)}Yr(){const t=[];return this.Jr.inorderTraversal((e,n)=>{t.push(n)}),t}}class Oo{constructor(t,e,n,r,s,i,o,a){this.query=t,this.docs=e,this.oldDocs=n,this.docChanges=r,this.mutatedKeys=s,this.fromCache=i,this.syncStateChanged=o,this.excludesMetadataChanges=a}static fromInitialDocuments(t,e,n,r){const s=[];return e.forEach(t=>{s.push({type:0,doc:t})}),new Oo(t,e,ko.emptySet(e),s,n,r,!0,!1)}get hasPendingWrites(){return!this.mutatedKeys.isEmpty()}isEqual(t){if(!(this.fromCache===t.fromCache&&this.syncStateChanged===t.syncStateChanged&&this.mutatedKeys.isEqual(t.mutatedKeys)&&Ie(this.query,t.query)&&this.docs.isEqual(t.docs)&&this.oldDocs.isEqual(t.oldDocs)))return!1;const e=this.docChanges,n=t.docChanges;if(e.length!==n.length)return!1;for(let t=0;t<e.length;t++)if(e[t].type!==n[t].type||!e[t].doc.isEqual(n[t].doc))return!1;return!0}}class Fo{constructor(){this.Xr=void 0,this.listeners=[]}}class Mo{constructor(){this.queries=new Ki(t=>Ae(t),Ie),this.onlineState="Unknown",this.Zr=new Set}}async function Lo(t,e){const n=U(t),r=e.query;let s=!1,i=n.queries.get(r);if(i||(s=!0,i=new Fo),s)try{i.Xr=await n.onListen(r)}catch(t){const n=xo(t,`Initialization of query '${Re(e.query)}' failed`);return void e.onError(n)}n.queries.set(r,i),i.listeners.push(e),e.eo(n.onlineState),i.Xr&&e.no(i.Xr)&&Ko(n)}async function Bo(t,e){const n=U(t),r=e.query;let s=!1;const i=n.queries.get(r);if(i){const t=i.listeners.indexOf(e);t>=0&&(i.listeners.splice(t,1),s=0===i.listeners.length)}if(s)return n.queries.delete(r),n.onUnlisten(r)}function Uo(t,e){const n=U(t);let r=!1;for(const t of e){const e=t.query,s=n.queries.get(e);if(s){for(const e of s.listeners)e.no(t)&&(r=!0);s.Xr=t}}r&&Ko(n)}function qo(t,e,n){const r=U(t),s=r.queries.get(e);if(s)for(const t of s.listeners)t.onError(n);r.queries.delete(e)}function Ko(t){t.Zr.forEach(t=>{t.next()})}class jo{constructor(t,e,n){this.query=t,this.so=e,this.io=!1,this.ro=null,this.onlineState="Unknown",this.options=n||{}}no(t){if(!this.options.includeMetadataChanges){const e=[];for(const n of t.docChanges)3!==n.type&&e.push(n);t=new Oo(t.query,t.docs,t.oldDocs,e,t.mutatedKeys,t.fromCache,t.syncStateChanged,!0)}let e=!1;return this.io?this.oo(t)&&(this.so.next(t),e=!0):this.ao(t,this.onlineState)&&(this.co(t),e=!0),this.ro=t,e}onError(t){this.so.error(t)}eo(t){this.onlineState=t;let e=!1;return this.ro&&!this.io&&this.ao(this.ro,t)&&(this.co(this.ro),e=!0),e}ao(t,e){if(!t.fromCache)return!0;const n="Offline"!==e;return!(this.options.uo&&n||t.docs.isEmpty()&&"Offline"!==e)}oo(t){if(t.docChanges.length>0)return!0;const e=this.ro&&this.ro.hasPendingWrites!==t.hasPendingWrites;return!(!t.syncStateChanged&&!e)&&!0===this.options.includeMetadataChanges}co(t){t=Oo.fromInitialDocuments(t.query,t.docs,t.mutatedKeys,t.fromCache),this.io=!0,this.so.next(t)}}class Qo{constructor(t,e){this.payload=t,this.byteLength=e}ho(){return"metadata"in this.payload}}class Wo{constructor(t){this.N=t}zn(t){return Gn(this.N,t)}Hn(t){return t.metadata.exists?Zn(this.N,t.document,!1):qt.newNoDocument(this.zn(t.metadata.name),this.Jn(t.metadata.readTime))}Jn(t){return Kn(t)}}class Go{constructor(t,e,n){this.lo=t,this.localStore=e,this.N=n,this.queries=[],this.documents=[],this.progress=zo(t)}fo(t){this.progress.bytesLoaded+=t.byteLength;let e=this.progress.documentsLoaded;return t.payload.namedQuery?this.queries.push(t.payload.namedQuery):t.payload.documentMetadata?(this.documents.push({metadata:t.payload.documentMetadata}),t.payload.documentMetadata.exists||++e):t.payload.document&&(this.documents[this.documents.length-1].document=t.payload.document,++e),e!==this.progress.documentsLoaded?(this.progress.documentsLoaded=e,Object.assign({},this.progress)):null}wo(t){const e=new Map,n=new Wo(this.N);for(const r of t)if(r.metadata.queries){const t=n.zn(r.metadata.name);for(const n of r.metadata.queries){const r=(e.get(n)||Pn()).add(t);e.set(n,r)}}return e}async complete(){const t=await Tr(this.localStore,new Wo(this.N),this.documents,this.lo.id),e=this.wo(this.documents);for(const t of this.queries)await Ir(this.localStore,t,e.get(t.name));return this.progress.taskState="Success",new sr(Object.assign({},this.progress),t)}}function zo(t){return{taskState:"Running",documentsLoaded:0,bytesLoaded:0,totalDocuments:t.totalDocuments,totalBytes:t.totalBytes}}class Ho{constructor(t){this.key=t}}class Jo{constructor(t){this.key=t}}class Yo{constructor(t,e){this.query=t,this._o=e,this.mo=null,this.current=!1,this.yo=Pn(),this.mutatedKeys=Pn(),this.po=be(t),this.Eo=new ko(this.po)}get To(){return this._o}Io(t,e){const n=e?e.Ao:new $o,r=e?e.Eo:this.Eo;let s=e?e.mutatedKeys:this.mutatedKeys,i=r,o=!1;const a=we(this.query)&&r.size===this.query.limit?r.last():null,c=_e(this.query)&&r.size===this.query.limit?r.first():null;if(t.inorderTraversal((t,e)=>{const u=r.get(t),h=Pe(this.query,e)?e:null,l=!!u&&this.mutatedKeys.has(u.key),d=!!h&&(h.hasLocalMutations||this.mutatedKeys.has(h.key)&&h.hasCommittedMutations);let f=!1;u&&h?u.data.isEqual(h.data)?l!==d&&(n.track({type:3,doc:h}),f=!0):this.Ro(u,h)||(n.track({type:2,doc:h}),f=!0,(a&&this.po(h,a)>0||c&&this.po(h,c)<0)&&(o=!0)):!u&&h?(n.track({type:0,doc:h}),f=!0):u&&!h&&(n.track({type:1,doc:u}),f=!0,(a||c)&&(o=!0)),f&&(h?(i=i.add(h),s=d?s.add(t):s.delete(t)):(i=i.delete(t),s=s.delete(t)))}),we(this.query)||_e(this.query))for(;i.size>this.query.limit;){const t=we(this.query)?i.last():i.first();i=i.delete(t.key),s=s.delete(t.key),n.track({type:1,doc:t})}return{Eo:i,Ao:n,Ln:o,mutatedKeys:s}}Ro(t,e){return t.hasLocalMutations&&e.hasCommittedMutations&&!e.hasLocalMutations}applyChanges(t,e,n){const r=this.Eo;this.Eo=t.Eo,this.mutatedKeys=t.mutatedKeys;const s=t.Ao.Yr();s.sort((t,e)=>(function(t,e){const n=t=>{switch(t){case 0:return 1;case 2:case 3:return 2;case 1:return 0;default:return M()}};return n(t)-n(e)})(t.type,e.type)||this.po(t.doc,e.doc)),this.Po(n);const i=e?this.bo():[],o=0===this.yo.size&&this.current?1:0,a=o!==this.mo;return this.mo=o,0!==s.length||a?{snapshot:new Oo(this.query,t.Eo,r,s,t.mutatedKeys,0===o,a,!1),vo:i}:{vo:i}}eo(t){return this.current&&"Offline"===t?(this.current=!1,this.applyChanges({Eo:this.Eo,Ao:new $o,mutatedKeys:this.mutatedKeys,Ln:!1},!1)):{vo:[]}}Vo(t){return!this._o.has(t)&&!!this.Eo.has(t)&&!this.Eo.get(t).hasLocalMutations}Po(t){t&&(t.addedDocuments.forEach(t=>this._o=this._o.add(t)),t.modifiedDocuments.forEach(t=>{}),t.removedDocuments.forEach(t=>this._o=this._o.delete(t)),this.current=t.current)}bo(){if(!this.current)return[];const t=this.yo;this.yo=Pn(),this.Eo.forEach(t=>{this.Vo(t.key)&&(this.yo=this.yo.add(t.key))});const e=[];return t.forEach(t=>{this.yo.has(t)||e.push(new Jo(t))}),this.yo.forEach(n=>{t.has(n)||e.push(new Ho(n))}),e}So(t){this._o=t.Gn,this.yo=Pn();const e=this.Io(t.documents);return this.applyChanges(e,!0)}Do(){return Oo.fromInitialDocuments(this.query,this.Eo,this.mutatedKeys,0===this.mo)}}class Xo{constructor(t,e,n){this.query=t,this.targetId=e,this.view=n}}class Zo{constructor(t){this.key=t,this.Co=!1}}class ta{constructor(t,e,n,r,s,i){this.localStore=t,this.remoteStore=e,this.eventManager=n,this.sharedClientState=r,this.currentUser=s,this.maxConcurrentLimboResolutions=i,this.No={},this.xo=new Ki(t=>Ae(t),Ie),this.ko=new Map,this.$o=new Set,this.Oo=new dn(Pt.comparator),this.Fo=new Map,this.Mo=new Rr,this.Lo={},this.Bo=new Map,this.Uo=Ci.ie(),this.onlineState="Unknown",this.qo=void 0}get isPrimaryClient(){return!0===this.qo}}async function ea(t,e){const n=Da(t);let r,s;const i=n.xo.get(e);if(i)r=i.targetId,n.sharedClientState.addLocalQueryTarget(r),s=i.view.Do();else{const t=await _r(n.localStore,Ee(e)),i=n.sharedClientState.addLocalQueryTarget(t.targetId);r=t.targetId,s=await na(n,e,r,"current"===i),n.isPrimaryClient&&oo(n.remoteStore,t)}return s}async function na(t,e,n,r){t.Ko=((e,n,r)=>(async function(t,e,n,r){let s=e.view.Io(n);s.Ln&&(s=await gr(t.localStore,e.query,!1).then(({documents:t})=>e.view.Io(t,s)));const i=r&&r.targetChanges.get(e.targetId),o=e.view.applyChanges(s,t.isPrimaryClient,i);return _a(t,e.targetId,o.vo),o.snapshot})(t,e,n,r));const s=await gr(t.localStore,e,!0),i=new Yo(e,s.Gn),o=i.Io(s.documents),a=Sn.createSynthesizedTargetChangeForCurrentChange(n,r&&"Offline"!==t.onlineState),c=i.applyChanges(o,t.isPrimaryClient,a);_a(t,n,c.vo);const u=new Xo(e,n,i);return t.xo.set(e,u),t.ko.has(n)?t.ko.get(n).push(e):t.ko.set(n,[e]),c.snapshot}async function sa(t,e){const n=U(t),r=n.xo.get(e),s=n.ko.get(r.targetId);if(s.length>1)return n.ko.set(r.targetId,s.filter(t=>!Ie(t,e))),void n.xo.delete(e);n.isPrimaryClient?(n.sharedClientState.removeLocalQueryTarget(r.targetId),n.sharedClientState.isActiveQueryTarget(r.targetId)||await mr(n.localStore,r.targetId,!1).then(()=>{n.sharedClientState.clearQueryState(r.targetId),ao(n.remoteStore,r.targetId),da(n,r.targetId)}).catch(Oi)):(da(n,r.targetId),await mr(n.localStore,r.targetId,!0))}async function ia(t,e,n){const r=Ca(t);try{const s=await function(t,e){const n=U(t),r=st.now(),s=e.reduce((t,e)=>t.add(e.key),Pn());let i;return n.persistence.runTransaction("Locally write mutations","readwrite",t=>n.Qn.bn(t,s).next(s=>{i=s;const o=[];for(const t of e){const e=Ye(t,i.get(t.key));null!=e&&o.push(new en(t.key,e,Ut(e.value.mapValue),We.exists(!0)))}return n.In.addMutationBatch(t,r,o,e)})).then(t=>(t.applyToLocalDocumentSet(i),{batchId:t.batchId,changes:i}))}(r.localStore,e);r.sharedClientState.addPendingMutation(s.batchId),function(t,e,n){let r=t.Lo[t.currentUser.toKey()];r||(r=new dn(tt)),r=r.insert(e,n),t.Lo[t.currentUser.toKey()]=r}(r,s.batchId,n),await ya(r,s.changes),await Eo(r.remoteStore)}catch(t){const e=xo(t,"Failed to persist write");n.reject(e)}}async function ra(t,e){const n=U(t);try{const r=await fr(n.localStore,e);e.targetChanges.forEach((t,e)=>{const r=n.Fo.get(e);r&&(L(t.addedDocuments.size+t.modifiedDocuments.size+t.removedDocuments.size<=1),t.addedDocuments.size>0?r.Co=!0:t.modifiedDocuments.size>0?L(r.Co):t.removedDocuments.size>0&&(L(r.Co),r.Co=!1))}),await ya(n,r,e)}catch(t){await Oi(t)}}function oa(t,e,n){const r=U(t);if(r.isPrimaryClient&&0===n||!r.isPrimaryClient&&1===n){const t=[];r.xo.forEach((n,r)=>{const s=r.view.eo(e);s.snapshot&&t.push(s.snapshot)}),function(t,e){const n=U(t);n.onlineState=e;let r=!1;n.queries.forEach((t,n)=>{for(const t of n.listeners)t.eo(e)&&(r=!0)}),r&&Ko(n)}(r.eventManager,e),t.length&&r.No.Tr(t),r.onlineState=e,r.isPrimaryClient&&r.sharedClientState.setOnlineState(e)}}async function aa(t,e,n){const r=U(t);r.sharedClientState.updateQueryState(e,"rejected",n);const s=r.Fo.get(e),i=s&&s.key;if(i){let t=new dn(Pt.comparator);t=t.insert(i,qt.newNoDocument(i,it.min()));const n=Pn().add(i),s=new Vn(it.min(),new Map,new mn(tt),t,n);await ra(r,s),r.Oo=r.Oo.remove(i),r.Fo.delete(e),ga(r)}else await mr(r.localStore,e,!1).then(()=>da(r,e,n)).catch(Oi)}async function ca(t,e){const n=U(t),r=e.batch.batchId;try{const s=await hr(n.localStore,e);fa(n,r,null),la(n,r),n.sharedClientState.updateMutationState(r,"acknowledged"),await ya(n,s)}catch(t){await Oi(t)}}async function ua(t,e,n){const r=U(t);try{const t=await function(t,e){const n=U(t);return n.persistence.runTransaction("Reject batch","readwrite-primary",t=>{let r;return n.In.lookupMutationBatch(t,e).next(e=>(L(null!==e),r=e.keys(),n.In.removeMutationBatch(t,e))).next(()=>n.In.performConsistencyCheck(t)).next(()=>n.Qn.bn(t,r))})}(r.localStore,e);fa(r,e,n),la(r,e),r.sharedClientState.updateMutationState(e,"rejected",n),await ya(r,t)}catch(n){await Oi(n)}}async function ha(t,e){const n=U(t);fo(n.remoteStore)||k("SyncEngine","The network is disabled. The task returned by 'awaitPendingWrites()' will not complete until the network is enabled.");try{const r=await function(t){const e=U(n.localStore);return e.persistence.runTransaction("Get highest unacknowledged batch id","readonly",t=>e.In.getHighestUnacknowledgedBatchId(t))}();if(-1===r)return void e.resolve();const s=n.Bo.get(r)||[];s.push(e),n.Bo.set(r,s)}catch(t){const n=xo(t,"Initialization of waitForPendingWrites() operation failed");e.reject(n)}}function la(t,e){(t.Bo.get(e)||[]).forEach(t=>{t.resolve()}),t.Bo.delete(e)}function fa(t,e,n){const r=U(t);let s=r.Lo[r.currentUser.toKey()];if(s){const t=s.get(e);t&&(n?t.reject(n):t.resolve(),s=s.remove(e)),r.Lo[r.currentUser.toKey()]=s}}function da(t,e,n=null){t.sharedClientState.removeLocalQueryTarget(e);for(const r of t.ko.get(e))t.xo.delete(r),n&&t.No.jo(r,n);t.ko.delete(e),t.isPrimaryClient&&t.Mo.cs(e).forEach(e=>{t.Mo.containsKey(e)||wa(t,e)})}function wa(t,e){t.$o.delete(e.path.canonicalString());const n=t.Oo.get(e);null!==n&&(ao(t.remoteStore,n),t.Oo=t.Oo.remove(e),t.Fo.delete(n),ga(t))}function _a(t,e,n){for(const r of n)r instanceof Ho?(t.Mo.addReference(r.key,e),ma(t,r)):r instanceof Jo?(k("SyncEngine","Document no longer in limbo: "+r.key),t.Mo.removeReference(r.key,e),t.Mo.containsKey(r.key)||wa(t,r.key)):M()}function ma(t,e){const n=e.key,r=n.path.canonicalString();t.Oo.get(n)||t.$o.has(r)||(k("SyncEngine","New document in limbo: "+n),t.$o.add(r),ga(t))}function ga(t){for(;t.$o.size>0&&t.Oo.size<t.maxConcurrentLimboResolutions;){const e=t.$o.values().next().value;t.$o.delete(e);const n=new Pt(ut.fromString(e)),r=t.Uo.next();t.Fo.set(r,new Zo(n)),t.Oo=t.Oo.insert(n,r),oo(t.remoteStore,new si(Ee(de(n.path)),r,2,Y.T))}}async function ya(t,e,n){const r=U(t),s=[],i=[],o=[];r.xo.isEmpty()||(r.xo.forEach((t,a)=>{o.push(r.Ko(a,e,n).then(t=>{if(t){r.isPrimaryClient&&r.sharedClientState.updateQueryState(a.targetId,t.fromCache?"not-current":"current"),s.push(t);const e=rr.kn(a.targetId,t);i.push(e)}}))}),await Promise.all(o),r.No.Tr(s),await async function(t,e){const n=U(t);try{await n.persistence.runTransaction("notifyLocalViewChanges","readwrite",t=>Ks.forEach(e,e=>Ks.forEach(e.Nn,r=>n.persistence.referenceDelegate.addReference(t,e.targetId,r)).next(()=>Ks.forEach(e.xn,r=>n.persistence.referenceDelegate.removeReference(t,e.targetId,r)))))}catch(t){if(!zs(t))throw t;k("LocalStore","Failed to update sequence numbers: "+t)}for(const t of e){const e=t.targetId;if(!t.fromCache){const t=n.Un.get(e),r=t.snapshotVersion,s=t.withLastLimboFreeSnapshotVersion(r);n.Un=n.Un.insert(e,s)}}}(r.localStore,i))}async function pa(t,e){const n=U(t);if(!n.currentUser.isEqual(e)){k("SyncEngine","User change. New user:",e.toKey());const t=await ur(n.localStore,e);n.currentUser=e,function(t,e){t.Bo.forEach(t=>{t.forEach(t=>{t.reject(new K(q.CANCELLED,"'waitForPendingWrites' promise is rejected due to a user change."))})}),t.Bo.clear()}(n),n.sharedClientState.handleUserChange(e,t.removedBatchIds,t.addedBatchIds),await ya(n,t.Wn)}}function Ea(t,e){const n=U(t),r=n.Fo.get(e);if(r&&r.Co)return Pn().add(r.key);{let t=Pn();const r=n.ko.get(e);if(!r)return t;for(const e of r){const r=n.xo.get(e);t=t.unionWith(r.view.To)}return t}}async function Ta(t,e){const n=U(t),r=await gr(n.localStore,e.query,!0),s=e.view.So(r);return n.isPrimaryClient&&_a(n,e.targetId,s.vo),s}async function Ia(t){const e=U(t);return pr(e.localStore).then(t=>ya(e,t))}async function Aa(t,e,n,r){const s=U(t),i=await function(t,e){const n=U(t),r=U(n.In);return n.persistence.runTransaction("Lookup mutation documents","readonly",t=>r.Xt(t,e).next(e=>e?n.Qn.bn(t,e):Ks.resolve(null)))}(s.localStore,e);null!==i?("pending"===n?await Eo(s.remoteStore):"acknowledged"===n||"rejected"===n?(fa(s,e,r||null),la(s,e),function(t,e){U(U(t).In).te(e)}(s.localStore,e)):M(),await ya(s,i)):k("SyncEngine","Cannot apply mutation batch with id: "+e)}async function Ra(t,e){const n=U(t);if(Da(n),Ca(n),!0===e&&!0!==n.qo){const t=n.sharedClientState.getAllActiveQueryTargets(),e=await Pa(n,t.toArray());n.qo=!0,await So(n.remoteStore,!0);for(const t of e)oo(n.remoteStore,t)}else if(!1===e&&!1!==n.qo){const t=[];let e=Promise.resolve();n.ko.forEach((r,s)=>{n.sharedClientState.isLocalQueryTarget(s)?t.push(s):e=e.then(()=>(da(n,s),mr(n.localStore,s,!0))),ao(n.remoteStore,s)}),await e,await Pa(n,t),function(t){const e=U(n);e.Fo.forEach((t,n)=>{ao(e.remoteStore,n)}),e.Mo.us(),e.Fo=new Map,e.Oo=new dn(Pt.comparator)}(),n.qo=!1,await So(n.remoteStore,!1)}}async function Pa(t,e,n){const r=U(t),s=[],i=[];for(const t of e){let e;const n=r.ko.get(t);if(n&&0!==n.length){e=await _r(r.localStore,Ee(n[0]));for(const t of n){const e=r.xo.get(t),n=await Ta(r,e);n.snapshot&&i.push(n.snapshot)}}else{const n=await yr(r.localStore,t);e=await _r(r.localStore,n),await na(r,ba(n),t,!1)}s.push(e)}return r.No.Tr(i),s}function ba(t){return fe(t.path,t.collectionGroup,t.orderBy,t.filters,t.limit,"F",t.startAt,t.endAt)}function va(t){const e=U(t);return U(U(e.localStore).persistence).pn()}async function Va(t,e,n,r){const s=U(t);if(s.qo)k("SyncEngine","Ignoring unexpected query state notification.");else if(s.ko.has(e))switch(n){case"current":case"not-current":{const t=await pr(s.localStore),r=Vn.createSynthesizedRemoteEventForCurrentChange(e,"current"===n);await ya(s,t,r);break}case"rejected":await mr(s.localStore,e,!0),da(s,e,r);break;default:M()}}async function Sa(t,e,n){const r=Da(t);if(r.qo){for(const t of e){if(r.ko.has(t)){k("SyncEngine","Adding an already active target "+t);continue}const e=await yr(r.localStore,t),n=await _r(r.localStore,e);await na(r,ba(e),n.targetId,!1),oo(r.remoteStore,n)}for(const t of n)r.ko.has(t)&&await mr(r.localStore,t,!1).then(()=>{ao(r.remoteStore,t),da(r,t)}).catch(Oi)}}function Da(t){const e=U(t);return e.remoteStore.remoteSyncer.applyRemoteEvent=ra.bind(null,e),e.remoteStore.remoteSyncer.getRemoteKeysForTarget=Ea.bind(null,e),e.remoteStore.remoteSyncer.rejectListen=aa.bind(null,e),e.No.Tr=Uo.bind(null,e.eventManager),e.No.jo=qo.bind(null,e.eventManager),e}function Ca(t){const e=U(t);return e.remoteStore.remoteSyncer.applySuccessfulWrite=ca.bind(null,e),e.remoteStore.remoteSyncer.rejectFailedWrite=ua.bind(null,e),e}function Na(t,e,n){const r=U(t);(async function(t,e,n){try{const r=await e.getMetadata();if(await function(t,e){const n=U(t),r=Kn(e.createTime);return n.persistence.runTransaction("hasNewerBundle","readonly",t=>n.Je.getBundleMetadata(t,e.id)).then(t=>!!t&&t.createTime.compareTo(r)>=0)}(t.localStore,r))return await e.close(),void n._completeWith(function(t){return{taskState:"Success",documentsLoaded:t.totalDocuments,bytesLoaded:t.totalBytes,totalDocuments:t.totalDocuments,totalBytes:t.totalBytes}}(r));n._updateProgress(zo(r));const s=new Go(r,t.localStore,e.N);let i=await e.Qo();for(;i;){const t=await s.fo(i);t&&n._updateProgress(t),i=await e.Qo()}const o=await s.complete();await ya(t,o.Tn,void 0),await function(t,e){const n=U(t);return n.persistence.runTransaction("Save bundle","readwrite",t=>n.Je.saveBundleMetadata(t,e))}(t.localStore,r),n._completeWith(o.progress)}catch(t){O("SyncEngine",`Loading bundle failed with ${t}`),n._failWith(t)}})(r,e,n).then(()=>{r.sharedClientState.notifyBundleLoaded()})}class xa{constructor(){this.synchronizeTabs=!1}async initialize(t){this.N=Jr(t.databaseInfo.databaseId),this.sharedClientState=this.Wo(t),this.persistence=this.Go(t),await this.persistence.start(),this.gcScheduler=this.zo(t),this.localStore=this.Ho(t)}zo(t){return null}Ho(t){return cr(this.persistence,new or,t.initialUser,this.N)}Go(t){return new Dr(Nr.Ns,this.N)}Wo(t){return new qr}async terminate(){this.gcScheduler&&this.gcScheduler.stop(),await this.sharedClientState.shutdown(),await this.persistence.shutdown()}}class ka extends xa{constructor(t,e,n){super(),this.Jo=t,this.cacheSizeBytes=e,this.forceOwnership=n,this.synchronizeTabs=!1}async initialize(t){await super.initialize(t),await Er(this.localStore),await this.Jo.initialize(this,t),await Ca(this.Jo.syncEngine),await Eo(this.Jo.remoteStore),await this.persistence.nn(()=>(this.gcScheduler&&!this.gcScheduler.started&&this.gcScheduler.start(this.localStore),Promise.resolve()))}Ho(t){return cr(this.persistence,new or,t.initialUser,this.N)}zo(t){const e=this.persistence.referenceDelegate.garbageCollector;return new Li(e,t.asyncQueue)}Go(t){const e=nr(t.databaseInfo.databaseId,t.databaseInfo.persistenceKey),n=void 0!==this.cacheSizeBytes?Ai.withCacheSize(this.cacheSizeBytes):Ai.DEFAULT;return new Zi(this.synchronizeTabs,e,t.clientId,n,t.asyncQueue,zr(),Hr(),this.N,this.sharedClientState,!!this.forceOwnership)}Wo(t){return new qr}}class $a extends ka{constructor(t,e){super(t,e,!1),this.Jo=t,this.cacheSizeBytes=e,this.synchronizeTabs=!0}async initialize(t){await super.initialize(t);const e=this.Jo.syncEngine;this.sharedClientState instanceof Ur&&(this.sharedClientState.syncEngine={_i:Aa.bind(null,e),mi:Va.bind(null,e),gi:Sa.bind(null,e),pn:va.bind(null,e),wi:Ia.bind(null,e)},await this.sharedClientState.start()),await this.persistence.nn(async t=>{await Ra(this.Jo.syncEngine,t),this.gcScheduler&&(t&&!this.gcScheduler.started?this.gcScheduler.start(this.localStore):t||this.gcScheduler.stop())})}Wo(t){const e=zr();if(!Ur.Pt(e))throw new K(q.UNIMPLEMENTED,"IndexedDB persistence is only available on platforms that support LocalStorage.");const n=nr(t.databaseInfo.databaseId,t.databaseInfo.persistenceKey);return new Ur(e,t.asyncQueue,n,t.clientId,t.initialUser)}}class Oa{async initialize(t,e){this.localStore||(this.localStore=t.localStore,this.sharedClientState=t.sharedClientState,this.datastore=this.createDatastore(e),this.remoteStore=this.createRemoteStore(e),this.eventManager=this.createEventManager(e),this.syncEngine=this.createSyncEngine(e,!t.synchronizeTabs),this.sharedClientState.onlineStateHandler=(t=>oa(this.syncEngine,t,1)),this.remoteStore.remoteSyncer.handleCredentialChange=pa.bind(null,this.syncEngine),await So(this.remoteStore,this.syncEngine.isPrimaryClient))}createEventManager(t){return new Mo}createDatastore(t){const e=Jr(t.databaseInfo.databaseId),n=(r=t.databaseInfo,new Gr(r));var r;return function(t,e,n){return new eo(t,e,n)}(t.credentials,n,e)}createRemoteStore(t){return e=this.localStore,n=this.datastore,r=t.asyncQueue,s=(t=>oa(this.syncEngine,t,0)),i=jr.Pt()?new jr:new Kr,new so(e,n,r,s,i);var e,n,r,s,i}createSyncEngine(t,e){return function(t,e,n,r,s,i,o){const a=new ta(t,e,n,r,s,i);return o&&(a.qo=!0),a}(this.localStore,this.remoteStore,this.eventManager,this.sharedClientState,t.initialUser,t.maxConcurrentLimboResolutions,e)}terminate(){return async function(t){const e=U(t);k("RemoteStore","RemoteStore shutting down."),e.Kr.add(5),await ro(e),e.Qr.shutdown(),e.Wr.set("Unknown")}(this.remoteStore)}}function Fa(t,e=10240){let n=0;return{async read(){if(n<t.byteLength){const r={value:t.slice(n,n+e),done:!1};return n+=e,r}return{done:!0}},async cancel(){},releaseLock(){},closed:Promise.reject("unimplemented")}}class Ma{constructor(t){this.observer=t,this.muted=!1}next(t){this.observer.next&&this.Yo(this.observer.next,t)}error(t){this.observer.error?this.Yo(this.observer.error,t):console.error("Uncaught Error in snapshot listener:",t)}Xo(){this.muted=!0}Yo(t,e){this.muted||setTimeout(()=>{this.muted||t(e)},0)}}class La{constructor(t,e){this.Zo=t,this.N=e,this.metadata=new j,this.buffer=new Uint8Array,this.ta=new TextDecoder("utf-8"),this.ea().then(t=>{t&&t.ho()?this.metadata.resolve(t.payload.metadata):this.metadata.reject(new Error(`The first element of the bundle is not a metadata, it is\n             ${JSON.stringify(null==t?void 0:t.payload)}`))},t=>this.metadata.reject(t))}close(){return this.Zo.cancel()}async getMetadata(){return this.metadata.promise}async Qo(){return await this.getMetadata(),this.ea()}async ea(){const t=await this.na();if(null===t)return null;const e=this.ta.decode(t),n=Number(e);isNaN(n)&&this.sa(`length string (${e}) is not valid number`);const r=await this.ia(n);return new Qo(JSON.parse(r),t.length+n)}ra(){return this.buffer.findIndex(t=>t==="{".charCodeAt(0))}async na(){for(;this.ra()<0&&!await this.oa(););if(0===this.buffer.length)return null;const t=this.ra();t<0&&this.sa("Reached the end of bundle when a length string is expected.");const e=this.buffer.slice(0,t);return this.buffer=this.buffer.slice(t),e}async ia(t){for(;this.buffer.length<t;)await this.oa()&&this.sa("Reached the end of bundle when more is expected.");const e=this.ta.decode(this.buffer.slice(0,t));return this.buffer=this.buffer.slice(t),e}sa(t){throw this.Zo.cancel(),new Error(`Invalid bundle format: ${t}`)}async oa(){const t=await this.Zo.read();if(!t.done){const e=new Uint8Array(this.buffer.length+t.value.length);e.set(this.buffer),e.set(t.value,this.buffer.length),this.buffer=e}return t.done}}class Ba{constructor(t){this.datastore=t,this.readVersions=new Map,this.mutations=[],this.committed=!1,this.lastWriteError=null,this.writtenDocs=new Set}async lookup(t){if(this.ensureCommitNotCalled(),this.mutations.length>0)throw new K(q.INVALID_ARGUMENT,"Firestore transactions require all reads to be executed before all writes.");const e=await async function(t,e){const n=U(t),r=Jn(n.N)+"/documents",s={documents:e.map(t=>Wn(n.N,t))},i=await n.Ki("BatchGetDocuments",r,s),o=new Map;i.forEach(t=>{const e=ts(n.N,t);o.set(e.key.toString(),e)});const a=[];return e.forEach(t=>{const e=o.get(t.toString());L(!!e),a.push(e)}),a}(this.datastore,t);return e.forEach(t=>this.recordVersion(t)),e}set(t,e){this.write(e.toMutation(t,this.precondition(t))),this.writtenDocs.add(t.toString())}update(t,e){try{this.write(e.toMutation(t,this.preconditionForUpdate(t)))}catch(t){this.lastWriteError=t}this.writtenDocs.add(t.toString())}delete(t){this.write(new on(t,this.precondition(t))),this.writtenDocs.add(t.toString())}async commit(){if(this.ensureCommitNotCalled(),this.lastWriteError)throw this.lastWriteError;const t=this.readVersions;this.mutations.forEach(e=>{t.delete(e.key.toString())}),t.forEach((t,e)=>{const n=Pt.fromPath(e);this.mutations.push(new an(n,this.precondition(n)))}),await async function(t,e){const n=U(t),r=Jn(n.N)+"/documents",s={writes:e.map(t=>ns(n.N,t))};await n.Li("Commit",r,s)}(this.datastore,this.mutations),this.committed=!0}recordVersion(t){let e;if(t.isFoundDocument())e=t.version;else{if(!t.isNoDocument())throw M();e=it.min()}const n=this.readVersions.get(t.key.toString());if(n){if(!e.isEqual(n))throw new K(q.ABORTED,"Document version changed between two reads.")}else this.readVersions.set(t.key.toString(),e)}precondition(t){const e=this.readVersions.get(t.toString());return!this.writtenDocs.has(t.toString())&&e?We.updateTime(e):We.none()}preconditionForUpdate(t){const e=this.readVersions.get(t.toString());if(!this.writtenDocs.has(t.toString())&&e){if(e.isEqual(it.min()))throw new K(q.INVALID_ARGUMENT,"Can't update a document that doesn't exist.");return We.updateTime(e)}return We.exists(!0)}write(t){this.ensureCommitNotCalled(),this.mutations.push(t)}ensureCommitNotCalled(){}}class Ua{constructor(t,e,n,r){this.asyncQueue=t,this.datastore=e,this.updateFunction=n,this.deferred=r,this.aa=5,this.rr=new Yr(this.asyncQueue,"transaction_retry")}run(){this.aa-=1,this.ca()}ca(){this.rr.Xi(async()=>{const t=new Ba(this.datastore),e=this.ua(t);e&&e.then(e=>{this.asyncQueue.enqueueAndForget(()=>t.commit().then(()=>{this.deferred.resolve(e)}).catch(t=>{this.ha(t)}))}).catch(t=>{this.ha(t)})})}ua(t){try{const e=this.updateFunction(t);return!It(e)&&e.catch&&e.then?e:(this.deferred.reject(Error("Transaction callback must return a Promise")),null)}catch(t){return this.deferred.reject(t),null}}ha(t){this.aa>0&&this.la(t)?(this.aa-=1,this.asyncQueue.enqueueAndForget(()=>(this.ca(),Promise.resolve()))):this.deferred.reject(t)}la(t){if("FirebaseError"===t.name){const e=t.code;return"aborted"===e||"failed-precondition"===e||!ln(e)}return!1}}class qa{constructor(t,e,n){this.credentials=t,this.asyncQueue=e,this.databaseInfo=n,this.user=S.UNAUTHENTICATED,this.clientId=Z.I(),this.credentialListener=(()=>Promise.resolve()),this.credentials.start(e,async t=>{k("FirestoreClient","Received user=",t.uid),await this.credentialListener(t),this.user=t})}async getConfiguration(){return{asyncQueue:this.asyncQueue,databaseInfo:this.databaseInfo,clientId:this.clientId,credentials:this.credentials,initialUser:this.user,maxConcurrentLimboResolutions:100}}setCredentialChangeListener(t){this.credentialListener=t}verifyNotTerminated(){if(this.asyncQueue.isShuttingDown)throw new K(q.FAILED_PRECONDITION,"The client has already been terminated.")}terminate(){this.asyncQueue.enterRestrictedMode();const t=new j;return this.asyncQueue.enqueueAndForgetEvenWhileRestricted(async()=>{try{this.onlineComponents&&await this.onlineComponents.terminate(),this.offlineComponents&&await this.offlineComponents.terminate(),this.credentials.shutdown(),t.resolve()}catch(e){const n=xo(e,"Failed to shutdown persistence");t.reject(n)}}),t.promise}}async function Ka(t,e){t.asyncQueue.verifyOperationInProgress(),k("FirestoreClient","Initializing OfflineComponentProvider");const n=await t.getConfiguration();await e.initialize(n);let r=n.initialUser;t.setCredentialChangeListener(async t=>{r.isEqual(t)||(await ur(e.localStore,t),r=t)}),e.persistence.setDatabaseDeletedListener(()=>t.terminate()),t.offlineComponents=e}async function ja(t,e){t.asyncQueue.verifyOperationInProgress();const n=await Qa(t);k("FirestoreClient","Initializing OnlineComponentProvider");const r=await t.getConfiguration();await e.initialize(n,r),t.setCredentialChangeListener(t=>(async function(t,e){const n=U(t);n.asyncQueue.verifyOperationInProgress(),k("RemoteStore","RemoteStore received new credentials");const r=fo(n);n.Kr.add(3),await ro(n),r&&n.Wr.set("Unknown"),await n.remoteSyncer.handleCredentialChange(e),n.Kr.delete(3),await io(n)})(e.remoteStore,t)),t.onlineComponents=e}async function Qa(t){return t.offlineComponents||(k("FirestoreClient","Using default OfflineComponentProvider"),await Ka(t,new xa)),t.offlineComponents}async function Wa(t){return t.onlineComponents||(k("FirestoreClient","Using default OnlineComponentProvider"),await ja(t,new Oa)),t.onlineComponents}function Ga(t){return Qa(t).then(t=>t.persistence)}function za(t){return Qa(t).then(t=>t.localStore)}function Ha(t){return Wa(t).then(t=>t.remoteStore)}function Ja(t){return Wa(t).then(t=>t.syncEngine)}async function Ya(t){const e=await Wa(t),n=e.eventManager;return n.onListen=ea.bind(null,e.syncEngine),n.onUnlisten=sa.bind(null,e.syncEngine),n}function Xa(t){return t.asyncQueue.enqueue(async()=>{const e=await Ga(t),n=await Ha(t);return e.setNetworkEnabled(!0),function(t){const e=U(n);return e.Kr.delete(0),io(e)}()})}function Za(t){return t.asyncQueue.enqueue(async()=>{const e=await Ga(t),n=await Ha(t);return e.setNetworkEnabled(!1),async function(t){const e=U(n);e.Kr.add(0),await ro(e),e.Wr.set("Offline")}()})}function tc(t,e){const n=new j;return t.asyncQueue.enqueueAndForget(async()=>(async function(t,e,n){try{const r=await function(t,e){const n=U(t);return n.persistence.runTransaction("read document","readonly",t=>n.Qn.An(t,e))}(t,e);r.isFoundDocument()?n.resolve(r):r.isNoDocument()?n.resolve(null):n.reject(new K(q.UNAVAILABLE,"Failed to get document from cache. (However, this document may exist on the server. Run again without setting 'source' in the GetOptions to attempt to retrieve the document from the server.)"))}catch(t){const r=xo(t,`Failed to get document '${e} from cache`);n.reject(r)}})(await za(t),e,n)),n.promise}function ec(t,e,n={}){const r=new j;return t.asyncQueue.enqueueAndForget(async()=>(function(t,e,n,r,s){const i=new Ma({next:i=>{e.enqueueAndForget(()=>Bo(t,o));const a=i.docs.has(n);!a&&i.fromCache?s.reject(new K(q.UNAVAILABLE,"Failed to get document because the client is offline.")):a&&i.fromCache&&r&&"server"===r.source?s.reject(new K(q.UNAVAILABLE,'Failed to get document from server. (However, this document does exist in the local cache. Run again without setting source to "server" to retrieve the cached document.)')):s.resolve(i)},error:t=>s.reject(t)}),o=new jo(de(n.path),i,{includeMetadataChanges:!0,uo:!0});return Lo(t,o)})(await Ya(t),t.asyncQueue,e,n,r)),r.promise}function nc(t,e){const n=new j;return t.asyncQueue.enqueueAndForget(async()=>(async function(t,e,n){try{const r=await gr(t,e,!0),s=new Yo(e,r.Gn),i=s.Io(r.documents),o=s.applyChanges(i,!1);n.resolve(o.snapshot)}catch(t){const r=xo(t,`Failed to execute query '${e} against cache`);n.reject(r)}})(await za(t),e,n)),n.promise}function sc(t,e,n={}){const r=new j;return t.asyncQueue.enqueueAndForget(async()=>(function(t,e,n,r,s){const i=new Ma({next:n=>{e.enqueueAndForget(()=>Bo(t,o)),n.fromCache&&"server"===r.source?s.reject(new K(q.UNAVAILABLE,'Failed to get documents from server. (However, these documents may exist in the local cache. Run again without setting source to "server" to retrieve the cached documents.)')):s.resolve(n)},error:t=>s.reject(t)}),o=new jo(n,i,{includeMetadataChanges:!0,uo:!0});return Lo(t,o)})(await Ya(t),t.asyncQueue,e,n,r)),r.promise}function ic(t,e){const n=new Ma(e);return t.asyncQueue.enqueueAndForget(async()=>(function(t,e){U(t).Zr.add(e),e.next()})(await Ya(t),n)),()=>{n.Xo(),t.asyncQueue.enqueueAndForget(async()=>(function(t,e){U(t).Zr.delete(e)})(await Ya(t),n))}}function rc(t,e){const n=new j;return t.asyncQueue.enqueueAndForget(async()=>{const r=await function(t){return Wa(t).then(t=>t.datastore)}(t);new Ua(t.asyncQueue,r,e,n).run()}),n.promise}function oc(t,e,n,r){const s=function(t,e){let n;return function(t,e){return new La(t,e)}(function(t,e){if(t instanceof Uint8Array)return Fa(t,e);if(t instanceof ArrayBuffer)return Fa(new Uint8Array(t),e);if(t instanceof ReadableStream)return t.getReader();throw new Error("Source of `toByteStreamReader` has to be a ArrayBuffer or ReadableStream")}(n="string"==typeof t?(new TextEncoder).encode(t):t),e)}(n,Jr(e));t.asyncQueue.enqueueAndForget(async()=>{Na(await Ja(t),s,r)})}function ac(t,e){return t.asyncQueue.enqueue(async()=>(function(t,e){const n=U(t);return n.persistence.runTransaction("Get named query","readonly",t=>n.Je.getNamedQuery(t,e))})(await za(t),e))}class cc{constructor(t,e,n,r,s,i,o,a){this.databaseId=t,this.appId=e,this.persistenceKey=n,this.host=r,this.ssl=s,this.forceLongPolling=i,this.autoDetectLongPolling=o,this.useFetchStreams=a}}class uc{constructor(t,e){this.projectId=t,this.database=e||"(default)"}get isDefaultDatabase(){return"(default)"===this.database}isEqual(t){return t instanceof uc&&t.projectId===this.projectId&&t.database===this.database}}const hc=new Map;function lc(t,e,n){if(!n)throw new K(q.INVALID_ARGUMENT,`Function ${t}() cannot be called with an empty ${e}.`)}function fc(t,e,n,r){if(!0===e&&!0===r)throw new K(q.INVALID_ARGUMENT,`${t} and ${n} cannot be used together.`)}function dc(t){if(!Pt.isDocumentKey(t))throw new K(q.INVALID_ARGUMENT,`Invalid document reference. Document references must have an even number of segments, but ${t} has ${t.length}.`)}function wc(t){if(Pt.isDocumentKey(t))throw new K(q.INVALID_ARGUMENT,`Invalid collection reference. Collection references must have an odd number of segments, but ${t} has ${t.length}.`)}function _c(t){if(void 0===t)return"undefined";if(null===t)return"null";if("string"==typeof t)return t.length>20&&(t=`${t.substring(0,20)}...`),JSON.stringify(t);if("number"==typeof t||"boolean"==typeof t)return""+t;if("object"==typeof t){if(t instanceof Array)return"an array";{const e=function(t){if(t.constructor){const e=/function\s+([^\s(]+)\s*\(/.exec(t.constructor.toString());if(e&&e.length>1)return e[1]}return null}(t);return e?`a custom ${e} object`:"an object"}}return"function"==typeof t?"a function":M()}function mc(t,e){if("_delegate"in t&&(t=t._delegate),!(t instanceof e)){if(e.name===t.constructor.name)throw new K(q.INVALID_ARGUMENT,"Type does not match the expected instance. Did you pass a reference from a different Firestore SDK?");{const n=_c(t);throw new K(q.INVALID_ARGUMENT,`Expected type '${e.name}', but it was: ${n}`)}}return t}function gc(t,e){if(e<=0)throw new K(q.INVALID_ARGUMENT,`Function ${t}() requires a positive number, but it was: ${e}.`)}class yc{constructor(t){var e;if(void 0===t.host){if(void 0!==t.ssl)throw new K(q.INVALID_ARGUMENT,"Can't provide ssl option if host option is not set");this.host="firestore.googleapis.com",this.ssl=!0}else this.host=t.host,this.ssl=null===(e=t.ssl)||void 0===e||e;if(this.credentials=t.credentials,this.ignoreUndefinedProperties=!!t.ignoreUndefinedProperties,void 0===t.cacheSizeBytes)this.cacheSizeBytes=41943040;else{if(-1!==t.cacheSizeBytes&&t.cacheSizeBytes<1048576)throw new K(q.INVALID_ARGUMENT,"cacheSizeBytes must be at least 1048576");this.cacheSizeBytes=t.cacheSizeBytes}this.experimentalForceLongPolling=!!t.experimentalForceLongPolling,this.experimentalAutoDetectLongPolling=!!t.experimentalAutoDetectLongPolling,this.useFetchStreams=!!t.useFetchStreams,fc("experimentalForceLongPolling",t.experimentalForceLongPolling,"experimentalAutoDetectLongPolling",t.experimentalAutoDetectLongPolling)}isEqual(t){return this.host===t.host&&this.ssl===t.ssl&&this.credentials===t.credentials&&this.cacheSizeBytes===t.cacheSizeBytes&&this.experimentalForceLongPolling===t.experimentalForceLongPolling&&this.experimentalAutoDetectLongPolling===t.experimentalAutoDetectLongPolling&&this.ignoreUndefinedProperties===t.ignoreUndefinedProperties&&this.useFetchStreams===t.useFetchStreams}}class pc{constructor(t,e){this._credentials=e,this.type="firestore-lite",this._persistenceKey="(lite)",this._settings=new yc({}),this._settingsFrozen=!1,t instanceof uc?this._databaseId=t:(this._app=t,this._databaseId=function(t){if(!Object.prototype.hasOwnProperty.apply(t.options,["projectId"]))throw new K(q.INVALID_ARGUMENT,'"projectId" not provided in firebase.initializeApp.');return new uc(t.options.projectId)}(t))}get app(){if(!this._app)throw new K(q.FAILED_PRECONDITION,"Firestore was not initialized using the Firebase SDK. 'app' is not available");return this._app}get _initialized(){return this._settingsFrozen}get _terminated(){return void 0!==this._terminateTask}_setSettings(t){if(this._settingsFrozen)throw new K(q.FAILED_PRECONDITION,"Firestore has already been started and its settings can no longer be changed. You can only modify settings before calling any other methods on a Firestore object.");this._settings=new yc(t),void 0!==t.credentials&&(this._credentials=function(t){if(!t)return new W;switch(t.type){case"gapi":const e=t.client;return L(!("object"!=typeof e||null===e||!e.auth||!e.auth.getAuthHeaderValueForFirstParty)),new J(e,t.sessionIndex||"0",t.iamToken||null);case"provider":return t.client;default:throw new K(q.INVALID_ARGUMENT,"makeCredentialsProvider failed due to invalid credential type")}}(t.credentials))}_getSettings(){return this._settings}_freezeSettings(){return this._settingsFrozen=!0,this._settings}_delete(){return this._terminateTask||(this._terminateTask=this._terminate()),this._terminateTask}toJSON(){return{app:this._app,databaseId:this._databaseId,settings:this._settings}}_terminate(){return function(t){const e=hc.get(t);e&&(k("ComponentProvider","Removing Datastore"),hc.delete(t),e.terminate())}(this),Promise.resolve()}}function Ec(t,e,n,r={}){var s;const i=(t=mc(t,pc))._getSettings();if("firestore.googleapis.com"!==i.host&&i.host!==e&&O("Host has been set in both settings() and useEmulator(), emulator host will be used"),t._setSettings(Object.assign(Object.assign({},i),{host:`${e}:${n}`,ssl:!1})),r.mockUserToken){let e,n;if("string"==typeof r.mockUserToken)e=r.mockUserToken,n=S.MOCK_USER;else{e=createMockUserToken(r.mockUserToken,null===(s=t._app)||void 0===s?void 0:s.options.projectId);const i=r.mockUserToken.sub||r.mockUserToken.user_id;if(!i)throw new K(q.INVALID_ARGUMENT,"mockUserToken must contain 'sub' or 'user_id' field!");n=new S(i)}t._credentials=new G(new Q(e,n))}}class Tc{constructor(t,e,n){this.converter=e,this._key=n,this.type="document",this.firestore=t}get _path(){return this._key.path}get id(){return this._key.path.lastSegment()}get path(){return this._key.path.canonicalString()}get parent(){return new Ac(this.firestore,this.converter,this._key.path.popLast())}withConverter(t){return new Tc(this.firestore,t,this._key)}}class Ic{constructor(t,e,n){this.converter=e,this._query=n,this.type="query",this.firestore=t}withConverter(t){return new Ic(this.firestore,t,this._query)}}class Ac extends Ic{constructor(t,e,n){super(t,e,de(n)),this._path=n,this.type="collection"}get id(){return this._query.path.lastSegment()}get path(){return this._query.path.canonicalString()}get parent(){const t=this._path.popLast();return t.isEmpty()?null:new Tc(this.firestore,null,new Pt(t))}withConverter(t){return new Ac(this.firestore,t,this._path)}}function Rc(t,e,...n){if(t=getModularInstance(t),lc("collection","path",e),t instanceof pc){const r=ut.fromString(e,...n);return wc(r),new Ac(t,null,r)}{if(!(t instanceof Tc||t instanceof Ac))throw new K(q.INVALID_ARGUMENT,"Expected first argument to collection() to be a CollectionReference, a DocumentReference or FirebaseFirestore");const r=ut.fromString(t.path,...n).child(ut.fromString(e));return wc(r),new Ac(t.firestore,null,r)}}function Pc(t,e){if(t=mc(t,pc),lc("collectionGroup","collection id",e),e.indexOf("/")>=0)throw new K(q.INVALID_ARGUMENT,`Invalid collection ID '${e}' passed to function collectionGroup(). Collection IDs must not contain '/'.`);return new Ic(t,null,function(t){return new le(ut.emptyPath(),t)}(e))}function bc(t,e,...n){if(t=getModularInstance(t),1===arguments.length&&(e=Z.I()),lc("doc","path",e),t instanceof pc){const r=ut.fromString(e,...n);return dc(r),new Tc(t,null,new Pt(r))}{if(!(t instanceof Tc||t instanceof Ac))throw new K(q.INVALID_ARGUMENT,"Expected first argument to collection() to be a CollectionReference, a DocumentReference or FirebaseFirestore");const r=t._path.child(ut.fromString(e,...n));return dc(r),new Tc(t.firestore,t instanceof Ac?t.converter:null,new Pt(r))}}function vc(t,e){return t=getModularInstance(t),e=getModularInstance(e),(t instanceof Tc||t instanceof Ac)&&(e instanceof Tc||e instanceof Ac)&&t.firestore===e.firestore&&t.path===e.path&&t.converter===e.converter}function Vc(t,e){return t=getModularInstance(t),e=getModularInstance(e),t instanceof Ic&&e instanceof Ic&&t.firestore===e.firestore&&Ie(t._query,e._query)&&t.converter===e.converter}class Sc{constructor(){this.fa=Promise.resolve(),this.da=[],this.wa=!1,this._a=[],this.ma=null,this.ga=!1,this.ya=!1,this.pa=[],this.rr=new Yr(this,"async_queue_retry"),this.Ea=(()=>{const t=Hr();t&&k("AsyncQueue","Visibility state changed to "+t.visibilityState),this.rr.tr()});const t=Hr();t&&"function"==typeof t.addEventListener&&t.addEventListener("visibilitychange",this.Ea)}get isShuttingDown(){return this.wa}enqueueAndForget(t){this.enqueue(t)}enqueueAndForgetEvenWhileRestricted(t){this.Ta(),this.Ia(t)}enterRestrictedMode(t){if(!this.wa){this.wa=!0,this.ya=t||!1;const e=Hr();e&&"function"==typeof e.removeEventListener&&e.removeEventListener("visibilitychange",this.Ea)}}enqueue(t){if(this.Ta(),this.wa)return new Promise(()=>{});const e=new j;return this.Ia(()=>this.wa&&this.ya?Promise.resolve():(t().then(e.resolve,e.reject),e.promise)).then(()=>e.promise)}enqueueRetryable(t){this.enqueueAndForget(()=>(this.da.push(t),this.Aa()))}async Aa(){if(0!==this.da.length){try{await this.da[0](),this.da.shift(),this.rr.reset()}catch(t){if(!zs(t))throw t;k("AsyncQueue","Operation failed with retryable error: "+t)}this.da.length>0&&this.rr.Xi(()=>this.Aa())}}Ia(t){const e=this.fa.then(()=>(this.ga=!0,t().catch(t=>{throw this.ma=t,this.ga=!1,$("INTERNAL UNHANDLED ERROR: ",function(t){let e=t.message||"";return t.stack&&(e=t.stack.includes(t.message)?t.stack:t.message+"\n"+t.stack),e}(t)),t}).then(t=>(this.ga=!1,t))));return this.fa=e,e}enqueueAfterDelay(t,e,n){this.Ta(),this.pa.indexOf(t)>-1&&(e=0);const r=No.createAndSchedule(this,t,e,n,t=>this.Ra(t));return this._a.push(r),r}Ta(){this.ma&&M()}verifyOperationInProgress(){}async Pa(){let t;do{t=this.fa,await t}while(t!==this.fa)}ba(t){for(const e of this._a)if(e.timerId===t)return!0;return!1}va(t){return this.Pa().then(()=>{this._a.sort((t,e)=>t.targetTimeMs-e.targetTimeMs);for(const e of this._a)if(e.skipDelay(),"all"!==t&&e.timerId===t)break;return this.Pa()})}Va(t){this.pa.push(t)}Ra(t){const e=this._a.indexOf(t);this._a.splice(e,1)}}function Dc(t){return function(t,e){if("object"!=typeof t||null===t)return!1;const n=t;for(const t of["next","error","complete"])if(t in n&&"function"==typeof n[t])return!0;return!1}(t)}class Cc{constructor(){this._progressObserver={},this._taskCompletionResolver=new j,this._lastProgress={taskState:"Running",totalBytes:0,totalDocuments:0,bytesLoaded:0,documentsLoaded:0}}onProgress(t,e,n){this._progressObserver={next:t,error:e,complete:n}}catch(t){return this._taskCompletionResolver.promise.catch(t)}then(t,e){return this._taskCompletionResolver.promise.then(t,e)}_completeWith(t){this._updateProgress(t),this._progressObserver.complete&&this._progressObserver.complete(),this._taskCompletionResolver.resolve(t)}_failWith(t){this._lastProgress.taskState="Error",this._progressObserver.next&&this._progressObserver.next(this._lastProgress),this._progressObserver.error&&this._progressObserver.error(t),this._taskCompletionResolver.reject(t)}_updateProgress(t){this._lastProgress=t,this._progressObserver.next&&this._progressObserver.next(t)}}const Nc=-1;class xc extends pc{constructor(t,e){super(t,e),this.type="firestore",this._queue=new Sc,this._persistenceKey="name"in t?t.name:"[DEFAULT]"}_terminate(){return this._firestoreClient||Fc(this),this._firestoreClient.terminate()}}function kc(t,e){const n=_getProvider(t,"firestore");if(n.isInitialized()){const t=n.getImmediate();if(deepEqual(n.getOptions(),e))return t;throw new K(q.FAILED_PRECONDITION,"initializeFirestore() has already been called with different options. To avoid this error, call initializeFirestore() with the same options as when it was originally called, or call getFirestore() to return the already initialized instance.")}if(void 0!==e.cacheSizeBytes&&-1!==e.cacheSizeBytes&&e.cacheSizeBytes<1048576)throw new K(q.INVALID_ARGUMENT,"cacheSizeBytes must be at least 1048576");return n.initialize({options:e})}function $c(t=getApp()){return _getProvider(t,"firestore").getImmediate()}function Oc(t){return t._firestoreClient||Fc(t),t._firestoreClient.verifyNotTerminated(),t._firestoreClient}function Fc(t){var e;const n=t._freezeSettings(),r=function(t,e,n,r){return new cc(t,e,n,r.host,r.ssl,r.experimentalForceLongPolling,r.experimentalAutoDetectLongPolling,r.useFetchStreams)}(t._databaseId,(null===(e=t._app)||void 0===e?void 0:e.options.appId)||"",t._persistenceKey,n);t._firestoreClient=new qa(t._credentials,t._queue,r)}function Mc(t,e){zc(t=mc(t,xc));const n=Oc(t),r=t._freezeSettings(),s=new Oa;return Bc(n,s,new ka(s,r.cacheSizeBytes,null==e?void 0:e.forceOwnership))}function Lc(t){zc(t=mc(t,xc));const e=Oc(t),n=t._freezeSettings(),r=new Oa;return Bc(e,r,new $a(r,n.cacheSizeBytes))}function Bc(t,e,n){const r=new j;return t.asyncQueue.enqueue(async()=>{try{await Ka(t,n),await ja(t,e),r.resolve()}catch(t){if(!function(t){return"FirebaseError"===t.name?t.code===q.FAILED_PRECONDITION||t.code===q.UNIMPLEMENTED:!("undefined"!=typeof DOMException&&t instanceof DOMException)||(22===t.code||20===t.code||11===t.code)}(t))throw t;console.warn("Error enabling offline persistence. Falling back to persistence disabled: "+t),r.reject(t)}}).then(()=>r.promise)}function Uc(t){if(t._initialized&&!t._terminated)throw new K(q.FAILED_PRECONDITION,"Persistence can only be cleared before a Firestore instance is initialized or after it is terminated.");const e=new j;return t._queue.enqueueAndForgetEvenWhileRestricted(async()=>{try{await async function(t){if(!Qs.Pt())return Promise.resolve();const e=t+"main";await Qs.delete(e)}(nr(t._databaseId,t._persistenceKey)),e.resolve()}catch(t){e.reject(t)}}),e.promise}function qc(t){return function(t){const e=new j;return t.asyncQueue.enqueueAndForget(async()=>ha(await Ja(t),e)),e.promise}(Oc(t=mc(t,xc)))}function Kc(t){return Xa(Oc(t=mc(t,xc)))}function jc(t){return Za(Oc(t=mc(t,xc)))}function Qc(t){return _removeServiceInstance(t.app,"firestore"),t._delete()}function Wc(t,e){const n=Oc(t=mc(t,xc)),r=new Cc;return oc(n,t._databaseId,e,r),r}function Gc(t,e){return ac(Oc(t=mc(t,xc)),e).then(e=>e?new Ic(t,null,e.query):null)}function zc(t){if(t._initialized||t._terminated)throw new K(q.FAILED_PRECONDITION,"Firestore has already been started and persistence can no longer be enabled. You can only enable persistence before calling any other methods on a Firestore object.")}class Hc{constructor(...t){for(let e=0;e<t.length;++e)if(0===t[e].length)throw new K(q.INVALID_ARGUMENT,"Invalid field name at argument $(i + 1). Field names must not be empty.");this._internalPath=new lt(t)}isEqual(t){return this._internalPath.isEqual(t._internalPath)}}function Jc(){return new Hc("__name__")}class Yc{constructor(t){this._byteString=t}static fromBase64String(t){try{return new Yc(wt.fromBase64String(t))}catch(t){throw new K(q.INVALID_ARGUMENT,"Failed to construct data from Base64 string: "+t)}}static fromUint8Array(t){return new Yc(wt.fromUint8Array(t))}toBase64(){return this._byteString.toBase64()}toUint8Array(){return this._byteString.toUint8Array()}toString(){return"Bytes(base64: "+this.toBase64()+")"}isEqual(t){return this._byteString.isEqual(t._byteString)}}class Xc{constructor(t){this._methodName=t}}class Zc{constructor(t,e){if(!isFinite(t)||t<-90||t>90)throw new K(q.INVALID_ARGUMENT,"Latitude must be a number between -90 and 90, but was: "+t);if(!isFinite(e)||e<-180||e>180)throw new K(q.INVALID_ARGUMENT,"Longitude must be a number between -180 and 180, but was: "+e);this._lat=t,this._long=e}get latitude(){return this._lat}get longitude(){return this._long}isEqual(t){return this._lat===t._lat&&this._long===t._long}toJSON(){return{latitude:this._lat,longitude:this._long}}_compareTo(t){return tt(this._lat,t._lat)||tt(this._long,t._long)}}const tu=/^__.*__$/;class eu{constructor(t,e,n){this.data=t,this.fieldMask=e,this.fieldTransforms=n}toMutation(t,e){return null!==this.fieldMask?new en(t,this.data,this.fieldMask,e,this.fieldTransforms):new tn(t,this.data,e,this.fieldTransforms)}}class nu{constructor(t,e,n){this.data=t,this.fieldMask=e,this.fieldTransforms=n}toMutation(t,e){return new en(t,this.data,this.fieldMask,e,this.fieldTransforms)}}function su(t){switch(t){case 0:case 2:case 1:return!0;case 3:case 4:return!1;default:throw M()}}class iu{constructor(t,e,n,r,s,i){this.settings=t,this.databaseId=e,this.N=n,this.ignoreUndefinedProperties=r,void 0===s&&this.Sa(),this.fieldTransforms=s||[],this.fieldMask=i||[]}get path(){return this.settings.path}get Da(){return this.settings.Da}Ca(t){return new iu(Object.assign(Object.assign({},this.settings),t),this.databaseId,this.N,this.ignoreUndefinedProperties,this.fieldTransforms,this.fieldMask)}Na(t){var e;const n=null===(e=this.path)||void 0===e?void 0:e.child(t),r=this.Ca({path:n,xa:!1});return r.ka(t),r}$a(t){var e;const n=null===(e=this.path)||void 0===e?void 0:e.child(t),r=this.Ca({path:n,xa:!1});return r.Sa(),r}Oa(t){return this.Ca({path:void 0,xa:!0})}Fa(t){return Ru(t,this.settings.methodName,this.settings.Ma||!1,this.path,this.settings.La)}contains(t){return void 0!==this.fieldMask.find(e=>t.isPrefixOf(e))||void 0!==this.fieldTransforms.find(e=>t.isPrefixOf(e.field))}Sa(){if(this.path)for(let t=0;t<this.path.length;t++)this.ka(this.path.get(t))}ka(t){if(0===t.length)throw this.Fa("Document fields must not be empty");if(su(this.Da)&&tu.test(t))throw this.Fa('Document fields cannot begin and end with "__"')}}class ru{constructor(t,e,n){this.databaseId=t,this.ignoreUndefinedProperties=e,this.N=n||Jr(t)}Ba(t,e,n,r=!1){return new iu({Da:t,methodName:e,La:n,path:lt.emptyPath(),xa:!1,Ma:r},this.databaseId,this.N,this.ignoreUndefinedProperties)}}function ou(t){const e=t._freezeSettings(),n=Jr(t._databaseId);return new ru(t._databaseId,!!e.ignoreUndefinedProperties,n)}function au(t,e,n,r,s,i={}){const o=t.Ba(i.merge||i.mergeFields?2:0,e,n,s);Eu("Data must be an object, but it was:",o,r);const a=yu(r,o);let c,u;if(i.merge)c=new ft(o.fieldMask),u=o.fieldTransforms;else if(i.mergeFields){const t=[];for(const r of i.mergeFields){const s=Tu(e,r,n);if(!o.contains(s))throw new K(q.INVALID_ARGUMENT,`Field '${s}' is specified in your field mask but missing from your input data.`);Pu(t,s)||t.push(s)}c=new ft(t),u=o.fieldTransforms.filter(t=>c.covers(t.field))}else c=null,u=o.fieldTransforms;return new eu(new Bt(a),c,u)}class cu extends Xc{_toFieldTransform(t){if(2!==t.Da)throw 1===t.Da?t.Fa(`${this._methodName}() can only appear at the top level of your update data`):t.Fa(`${this._methodName}() cannot be used with set() unless you pass {merge:true}`);return t.fieldMask.push(t.path),null}isEqual(t){return t instanceof cu}}function uu(t,e,n){return new iu({Da:3,La:e.settings.La,methodName:t._methodName,xa:n},e.databaseId,e.N,e.ignoreUndefinedProperties)}class hu extends Xc{_toFieldTransform(t){return new Ke(t.path,new $e)}isEqual(t){return t instanceof hu}}class lu extends Xc{constructor(t,e){super(t),this.Ua=e}_toFieldTransform(t){const e=uu(this,t,!0),n=this.Ua.map(t=>gu(t,e)),r=new Oe(n);return new Ke(t.path,r)}isEqual(t){return this===t}}class fu extends Xc{constructor(t,e){super(t),this.Ua=e}_toFieldTransform(t){const e=uu(this,t,!0),n=this.Ua.map(t=>gu(t,e)),r=new Me(n);return new Ke(t.path,r)}isEqual(t){return this===t}}class du extends Xc{constructor(t,e){super(t),this.qa=e}_toFieldTransform(t){const e=new Be(t.N,De(t.N,this.qa));return new Ke(t.path,e)}isEqual(t){return this===t}}function wu(t,e,n,r){const s=t.Ba(1,e,n);Eu("Data must be an object, but it was:",s,r);const i=[],o=Bt.empty();ot(r,(t,r)=>{const a=Au(e,t,n);r=getModularInstance(r);const c=s.$a(a);if(r instanceof cu)i.push(a);else{const t=gu(r,c);null!=t&&(i.push(a),o.set(a,t))}});const a=new ft(i);return new nu(o,a,s.fieldTransforms)}function _u(t,e,n,r,s,i){const o=t.Ba(1,e,n),a=[Tu(e,r,n)],c=[s];if(i.length%2!=0)throw new K(q.INVALID_ARGUMENT,`Function ${e}() needs to be called with an even number of arguments that alternate between field names and values.`);for(let t=0;t<i.length;t+=2)a.push(Tu(e,i[t])),c.push(i[t+1]);const u=[],h=Bt.empty();for(let t=a.length-1;t>=0;--t)if(!Pu(u,a[t])){const e=a[t];let n=c[t];n=getModularInstance(n);const r=o.$a(e);if(n instanceof cu)u.push(e);else{const t=gu(n,r);null!=t&&(u.push(e),h.set(e,t))}}const l=new ft(u);return new nu(h,l,o.fieldTransforms)}function mu(t,e,n,r=!1){return gu(n,t.Ba(r?4:3,e))}function gu(t,e){if(pu(t=getModularInstance(t)))return Eu("Unsupported field value:",e,t),yu(t,e);if(t instanceof Xc)return function(t,e){if(!su(e.Da))throw e.Fa(`${t._methodName}() can only be used with update() and set()`);if(!e.path)throw e.Fa(`${t._methodName}() is not currently supported inside arrays`);const n=t._toFieldTransform(e);n&&e.fieldTransforms.push(n)}(t,e),null;if(void 0===t&&e.ignoreUndefinedProperties)return null;if(e.path&&e.fieldMask.push(e.path),t instanceof Array){if(e.settings.xa&&4!==e.Da)throw e.Fa("Nested arrays are not supported");return function(t,e){const n=[];let r=0;for(const s of t){let t=gu(s,e.Oa(r));null==t&&(t={nullValue:"NULL_VALUE"}),n.push(t),r++}return{arrayValue:{values:n}}}(t,e)}return function(t,e){if(null===(t=getModularInstance(t)))return{nullValue:"NULL_VALUE"};if("number"==typeof t)return De(e.N,t);if("boolean"==typeof t)return{booleanValue:t};if("string"==typeof t)return{stringValue:t};if(t instanceof Date){const n=st.fromDate(t);return{timestampValue:Bn(e.N,n)}}if(t instanceof st){const n=new st(t.seconds,1e3*Math.floor(t.nanoseconds/1e3));return{timestampValue:Bn(e.N,n)}}if(t instanceof Zc)return{geoPointValue:{latitude:t.latitude,longitude:t.longitude}};if(t instanceof Yc)return{bytesValue:Un(e.N,t._byteString)};if(t instanceof Tc){const n=e.databaseId,r=t.firestore._databaseId;if(!r.isEqual(n))throw e.Fa(`Document reference is for database ${r.projectId}/${r.database} but should be for database ${n.projectId}/${n.database}`);return{referenceValue:jn(t.firestore._databaseId||e.databaseId,t._key.path)}}throw e.Fa(`Unsupported field value: ${_c(t)}`)}(t,e)}function yu(t,e){const n={};return at(t)?e.path&&e.path.length>0&&e.fieldMask.push(e.path):ot(t,(t,r)=>{const s=gu(r,e.Na(t));null!=s&&(n[t]=s)}),{mapValue:{fields:n}}}function pu(t){return!("object"!=typeof t||null===t||t instanceof Array||t instanceof Date||t instanceof st||t instanceof Zc||t instanceof Yc||t instanceof Tc||t instanceof Xc)}function Eu(t,e,n){if(!pu(n)||!function(t){return"object"==typeof t&&null!==t&&(Object.getPrototypeOf(t)===Object.prototype||null===Object.getPrototypeOf(t))}(n)){const r=_c(n);throw"an object"===r?e.Fa(t+" a custom object"):e.Fa(t+" "+r)}}function Tu(t,e,n){if((e=getModularInstance(e))instanceof Hc)return e._internalPath;if("string"==typeof e)return Au(t,e);throw Ru("Field path arguments must be of type string or FieldPath.",t,!1,void 0,n)}const Iu=new RegExp("[~\\*/\\[\\]]");function Au(t,e,n){if(e.search(Iu)>=0)throw Ru(`Invalid field path (${e}). Paths must not contain '~', '*', '/', '[', or ']'`,t,!1,void 0,n);try{return new Hc(...e.split("."))._internalPath}catch(r){throw Ru(`Invalid field path (${e}). Paths must not be empty, begin with '.', end with '.', or contain '..'`,t,!1,void 0,n)}}function Ru(t,e,n,r,s){const i=r&&!r.isEmpty(),o=void 0!==s;let a=`Function ${e}() called with invalid data`;n&&(a+=" (via `toFirestore()`)"),a+=". ";let c="";return(i||o)&&(c+=" (found",i&&(c+=` in field ${r}`),o&&(c+=` in document ${s}`),c+=")"),new K(q.INVALID_ARGUMENT,a+t+c)}function Pu(t,e){return t.some(t=>t.isEqual(e))}class bu{constructor(t,e,n,r,s){this._firestore=t,this._userDataWriter=e,this._key=n,this._document=r,this._converter=s}get id(){return this._key.path.lastSegment()}get ref(){return new Tc(this._firestore,this._converter,this._key)}exists(){return null!==this._document}data(){if(this._document){if(this._converter){const t=new vu(this._firestore,this._userDataWriter,this._key,this._document,null);return this._converter.fromFirestore(t)}return this._userDataWriter.convertValue(this._document.data.value)}}get(t){if(this._document){const e=this._document.data.field(Vu("DocumentSnapshot.get",t));if(null!==e)return this._userDataWriter.convertValue(e)}}}class vu extends bu{data(){return super.data()}}function Vu(t,e){return"string"==typeof e?Au(t,e):e instanceof Hc?e._internalPath:e._delegate._internalPath}class Su{constructor(t,e){this.hasPendingWrites=t,this.fromCache=e}isEqual(t){return this.hasPendingWrites===t.hasPendingWrites&&this.fromCache===t.fromCache}}class Du extends bu{constructor(t,e,n,r,s,i){super(t,e,n,r,i),this._firestore=t,this._firestoreImpl=t,this.metadata=s}exists(){return super.exists()}data(t={}){if(this._document){if(this._converter){const e=new Cu(this._firestore,this._userDataWriter,this._key,this._document,this.metadata,null);return this._converter.fromFirestore(e,t)}return this._userDataWriter.convertValue(this._document.data.value,t.serverTimestamps)}}get(t,e={}){if(this._document){const n=this._document.data.field(Vu("DocumentSnapshot.get",t));if(null!==n)return this._userDataWriter.convertValue(n,e.serverTimestamps)}}}class Cu extends Du{data(t={}){return super.data(t)}}class Nu{constructor(t,e,n,r){this._firestore=t,this._userDataWriter=e,this._snapshot=r,this.metadata=new Su(r.hasPendingWrites,r.fromCache),this.query=n}get docs(){const t=[];return this.forEach(e=>t.push(e)),t}get size(){return this._snapshot.docs.size}get empty(){return 0===this.size}forEach(t,e){this._snapshot.docs.forEach(n=>{t.call(e,new Cu(this._firestore,this._userDataWriter,n.key,n,new Su(this._snapshot.mutatedKeys.has(n.key),this._snapshot.fromCache),this.query.converter))})}docChanges(t={}){const e=!!t.includeMetadataChanges;if(e&&this._snapshot.excludesMetadataChanges)throw new K(q.INVALID_ARGUMENT,"To include metadata changes with your document changes, you must also pass { includeMetadataChanges:true } to onSnapshot().");return this._cachedChanges&&this._cachedChangesIncludeMetadataChanges===e||(this._cachedChanges=function(t,e){if(t._snapshot.oldDocs.isEmpty()){let e=0;return t._snapshot.docChanges.map(n=>({type:"added",doc:new Cu(t._firestore,t._userDataWriter,n.doc.key,n.doc,new Su(t._snapshot.mutatedKeys.has(n.doc.key),t._snapshot.fromCache),t.query.converter),oldIndex:-1,newIndex:e++}))}{let n=t._snapshot.oldDocs;return t._snapshot.docChanges.filter(t=>e||3!==t.type).map(e=>{const r=new Cu(t._firestore,t._userDataWriter,e.doc.key,e.doc,new Su(t._snapshot.mutatedKeys.has(e.doc.key),t._snapshot.fromCache),t.query.converter);let s=-1,i=-1;return 0!==e.type&&(s=n.indexOf(e.doc.key),n=n.delete(e.doc.key)),1!==e.type&&(i=(n=n.add(e.doc)).indexOf(e.doc.key)),{type:xu(e.type),doc:r,oldIndex:s,newIndex:i}})}}(this,e),this._cachedChangesIncludeMetadataChanges=e),this._cachedChanges}}function xu(t){switch(t){case 0:return"added";case 2:case 3:return"modified";case 1:return"removed";default:return M()}}function ku(t,e){return t instanceof Du&&e instanceof Du?t._firestore===e._firestore&&t._key.isEqual(e._key)&&(null===t._document?null===e._document:t._document.isEqual(e._document))&&t._converter===e._converter:t instanceof Nu&&e instanceof Nu&&t._firestore===e._firestore&&Vc(t.query,e.query)&&t.metadata.isEqual(e.metadata)&&t._snapshot.isEqual(e._snapshot)}function $u(t){if(_e(t)&&0===t.explicitOrderBy.length)throw new K(q.UNIMPLEMENTED,"limitToLast() queries require specifying at least one orderBy() clause")}class Ou{}function Fu(t,...e){for(const n of e)t=n._apply(t);return t}class Mu extends Ou{constructor(t,e,n){super(),this.Ka=t,this.ja=e,this.Qa=n,this.type="where"}_apply(t){const e=ou(t.firestore),n=function(t,e,n,r,s,i,o){let a;if(s.isKeyField()){if("array-contains"===i||"array-contains-any"===i)throw new K(q.INVALID_ARGUMENT,`Invalid Query. You can't perform '${i}' queries on FieldPath.documentId().`);if("in"===i||"not-in"===i){Zu(o,i);const e=[];for(const n of o)e.push(Xu(r,t,n));a={arrayValue:{values:e}}}else a=Xu(r,t,o)}else"in"!==i&&"not-in"!==i&&"array-contains-any"!==i||Zu(o,i),a=mu(n,"where",o,"in"===i||"not-in"===i);const c=Ht.create(s,i,a);return function(t,e){if(e.v()){const n=ge(t);if(null!==n&&!n.isEqual(e.field))throw new K(q.INVALID_ARGUMENT,`Invalid query. All where filters with an inequality (<, <=, !=, not-in, >, or >=) must be on the same field. But you have inequality filters on '${n.toString()}' and '${e.field.toString()}'`);const r=me(t);null!==r&&th(t,e.field,r)}const n=function(t,e){for(const n of t.filters)if(e.indexOf(n.op)>=0)return n.op;return null}(t,function(t){switch(e.op){case"!=":return["!=","not-in"];case"array-contains":return["array-contains","array-contains-any","not-in"];case"in":return["array-contains-any","in","not-in"];case"array-contains-any":return["array-contains","array-contains-any","in","not-in"];case"not-in":return["array-contains","array-contains-any","in","not-in","!="];default:return[]}}());if(null!==n)throw n===e.op?new K(q.INVALID_ARGUMENT,`Invalid query. You cannot use more than one '${e.op.toString()}' filter.`):new K(q.INVALID_ARGUMENT,`Invalid query. You cannot use '${e.op.toString()}' filters with '${n.toString()}' filters.`)}(t,c),c}(t._query,0,e,t.firestore._databaseId,this.Ka,this.ja,this.Qa);return new Ic(t.firestore,t.converter,function(t,e){const n=t.filters.concat([e]);return new le(t.path,t.collectionGroup,t.explicitOrderBy.slice(),n,t.limit,t.limitType,t.startAt,t.endAt)}(t._query,n))}}function Lu(t,e,n){const r=e,s=Vu("where",t);return new Mu(s,r,n)}class Bu extends Ou{constructor(t,e){super(),this.Ka=t,this.Wa=e,this.type="orderBy"}_apply(t){const e=function(t,e,n){if(null!==t.startAt)throw new K(q.INVALID_ARGUMENT,"Invalid query. You must not call startAt() or startAfter() before calling orderBy().");if(null!==t.endAt)throw new K(q.INVALID_ARGUMENT,"Invalid query. You must not call endAt() or endBefore() before calling orderBy().");const r=new ae(e,n);return function(t,e){if(null===me(t)){const n=ge(t);null!==n&&th(t,n,e.field)}}(t,r),r}(t._query,this.Ka,this.Wa);return new Ic(t.firestore,t.converter,function(t,e){const n=t.explicitOrderBy.concat([e]);return new le(t.path,t.collectionGroup,n,t.filters.slice(),t.limit,t.limitType,t.startAt,t.endAt)}(t._query,e))}}function Uu(t,e="asc"){const n=e,r=Vu("orderBy",t);return new Bu(r,n)}class qu extends Ou{constructor(t,e,n){super(),this.type=t,this.Ga=e,this.za=n}_apply(t){return new Ic(t.firestore,t.converter,Te(t._query,this.Ga,this.za))}}function Ku(t){return gc("limit",t),new qu("limit",t,"F")}function ju(t){return gc("limitToLast",t),new qu("limitToLast",t,"L")}class Qu extends Ou{constructor(t,e,n){super(),this.type=t,this.Ha=e,this.Ja=n}_apply(t){const e=Yu(t,this.type,this.Ha,this.Ja);return new Ic(t.firestore,t.converter,function(t,e){return new le(t.path,t.collectionGroup,t.explicitOrderBy.slice(),t.filters.slice(),t.limit,t.limitType,e,t.endAt)}(t._query,e))}}function Wu(...t){return new Qu("startAt",t,!0)}function Gu(...t){return new Qu("startAfter",t,!1)}class zu extends Ou{constructor(t,e,n){super(),this.type=t,this.Ha=e,this.Ja=n}_apply(t){const e=Yu(t,this.type,this.Ha,this.Ja);return new Ic(t.firestore,t.converter,function(t,e){return new le(t.path,t.collectionGroup,t.explicitOrderBy.slice(),t.filters.slice(),t.limit,t.limitType,t.startAt,e)}(t._query,e))}}function Hu(...t){return new zu("endBefore",t,!0)}function Ju(...t){return new zu("endAt",t,!1)}function Yu(t,e,n,r){if(n[0]=getModularInstance(n[0]),n[0]instanceof bu)return function(t,e,n,r,s){if(!r)throw new K(q.NOT_FOUND,`Can't use a DocumentSnapshot that doesn't exist for ${n}().`);const i=[];for(const n of pe(t))if(n.field.isKeyField())i.push(xt(e,r.key));else{const t=r.data.field(n.field);if(pt(t))throw new K(q.INVALID_ARGUMENT,'Invalid query. You are trying to start or end a query using a document for which the field "'+n.field+'" is an uncommitted server timestamp. (Since the value of this field is unknown, you cannot start/end a query with it.)');if(null===t){const t=n.field.canonicalString();throw new K(q.INVALID_ARGUMENT,`Invalid query. You are trying to start or end a query using a document for which the field '${t}' (used as the orderBy) does not exist.`)}i.push(t)}return new re(i,s)}(t._query,t.firestore._databaseId,e,n[0]._document,r);{const s=ou(t.firestore);return function(t,e,n,r,s,i){const o=t.explicitOrderBy;if(s.length>o.length)throw new K(q.INVALID_ARGUMENT,`Too many arguments provided to ${r}(). The number of arguments must be less than or equal to the number of orderBy() clauses`);const a=[];for(let i=0;i<s.length;i++){const c=s[i];if(o[i].field.isKeyField()){if("string"!=typeof c)throw new K(q.INVALID_ARGUMENT,`Invalid query. Expected a string for document ID in ${r}(), but got a ${typeof c}`);if(!ye(t)&&-1!==c.indexOf("/"))throw new K(q.INVALID_ARGUMENT,`Invalid query. When querying a collection and ordering by FieldPath.documentId(), the value passed to ${r}() must be a plain document ID, but '${c}' contains a slash.`);const n=t.path.child(ut.fromString(c));if(!Pt.isDocumentKey(n))throw new K(q.INVALID_ARGUMENT,`Invalid query. When querying a collection group and ordering by FieldPath.documentId(), the value passed to ${r}() must result in a valid document path, but '${n}' is not because it contains an odd number of segments.`);const s=new Pt(n);a.push(xt(e,s))}else{const t=mu(n,r,c);a.push(t)}}return new re(a,i)}(t._query,t.firestore._databaseId,s,e,n,r)}}function Xu(t,e,n){if("string"==typeof(n=getModularInstance(n))){if(""===n)throw new K(q.INVALID_ARGUMENT,"Invalid query. When querying with FieldPath.documentId(), you must provide a valid document ID, but it was an empty string.");if(!ye(e)&&-1!==n.indexOf("/"))throw new K(q.INVALID_ARGUMENT,`Invalid query. When querying a collection by FieldPath.documentId(), you must provide a plain document ID, but '${n}' contains a '/' character.`);const r=e.path.child(ut.fromString(n));if(!Pt.isDocumentKey(r))throw new K(q.INVALID_ARGUMENT,`Invalid query. When querying a collection group by FieldPath.documentId(), the value provided must result in a valid document path, but '${r}' is not because it has an odd number of segments (${r.length}).`);return xt(t,new Pt(r))}if(n instanceof Tc)return xt(t,n._key);throw new K(q.INVALID_ARGUMENT,`Invalid query. When querying with FieldPath.documentId(), you must provide a valid string or a DocumentReference, but it was: ${_c(n)}.`)}function Zu(t,e){if(!Array.isArray(t)||0===t.length)throw new K(q.INVALID_ARGUMENT,`Invalid Query. A non-empty array is required for '${e.toString()}' filters.`);if(t.length>10)throw new K(q.INVALID_ARGUMENT,`Invalid Query. '${e.toString()}' filters support a maximum of 10 elements in the value array.`)}function th(t,e,n){if(!n.isEqual(e))throw new K(q.INVALID_ARGUMENT,`Invalid query. You have a where filter with an inequality (<, <=, !=, not-in, >, or >=) on field '${e.toString()}' and so you must also use '${e.toString()}' as your first argument to orderBy(), but your first orderBy() is on field '${n.toString()}' instead.`)}class eh{convertValue(t,e="none"){switch(bt(t)){case 0:return null;case 1:return t.booleanValue;case 2:return gt(t.integerValue||t.doubleValue);case 3:return this.convertTimestamp(t.timestampValue);case 4:return this.convertServerTimestamp(t,e);case 5:return t.stringValue;case 6:return this.convertBytes(yt(t.bytesValue));case 7:return this.convertReference(t.referenceValue);case 8:return this.convertGeoPoint(t.geoPointValue);case 9:return this.convertArray(t.arrayValue,e);case 10:return this.convertObject(t.mapValue,e);default:throw M()}}convertObject(t,e){const n={};return ot(t.fields,(t,r)=>{n[t]=this.convertValue(r,e)}),n}convertGeoPoint(t){return new Zc(gt(t.latitude),gt(t.longitude))}convertArray(t,e){return(t.values||[]).map(t=>this.convertValue(t,e))}convertServerTimestamp(t,e){switch(e){case"previous":const n=Et(t);return null==n?null:this.convertValue(n,e);case"estimate":return this.convertTimestamp(Tt(t));default:return null}}convertTimestamp(t){const e=mt(t);return new st(e.seconds,e.nanos)}convertDocumentKey(t,e){const n=ut.fromString(t);L(ps(n));const r=new uc(n.get(1),n.get(3)),s=new Pt(n.popFirst(5));return r.isEqual(e)||$(`Document ${s} contains a document reference within a different database (${r.projectId}/${r.database}) which is not supported. It will be treated as a reference in the current database (${e.projectId}/${e.database}) instead.`),s}}function nh(t,e,n){let r;return r=t?n&&(n.merge||n.mergeFields)?t.toFirestore(e,n):t.toFirestore(e):e}class sh extends eh{constructor(t){super(),this.firestore=t}convertBytes(t){return new Yc(t)}convertReference(t){const e=this.convertDocumentKey(t,this.firestore._databaseId);return new Tc(this.firestore,null,e)}}class ih{constructor(t,e){this._firestore=t,this._commitHandler=e,this._mutations=[],this._committed=!1,this._dataReader=ou(t)}set(t,e,n){this._verifyNotCommitted();const r=rh(t,this._firestore),s=nh(r.converter,e,n),i=au(this._dataReader,"WriteBatch.set",r._key,s,null!==r.converter,n);return this._mutations.push(i.toMutation(r._key,We.none())),this}update(t,e,n,...r){this._verifyNotCommitted();const s=rh(t,this._firestore);let i;return i="string"==typeof(e=getModularInstance(e))||e instanceof Hc?_u(this._dataReader,"WriteBatch.update",s._key,e,n,r):wu(this._dataReader,"WriteBatch.update",s._key,e),this._mutations.push(i.toMutation(s._key,We.exists(!0))),this}delete(t){this._verifyNotCommitted();const e=rh(t,this._firestore);return this._mutations=this._mutations.concat(new on(e._key,We.none())),this}commit(){return this._verifyNotCommitted(),this._committed=!0,this._mutations.length>0?this._commitHandler(this._mutations):Promise.resolve()}_verifyNotCommitted(){if(this._committed)throw new K(q.FAILED_PRECONDITION,"A write batch can no longer be used after commit() has been called.")}}function rh(t,e){if((t=getModularInstance(t)).firestore!==e)throw new K(q.INVALID_ARGUMENT,"Provided document reference is from a different Firestore instance.");return t}function oh(t){t=mc(t,Tc);const e=mc(t.firestore,xc);return ec(Oc(e),t._key).then(n=>Eh(e,t,n))}class ah extends eh{constructor(t){super(),this.firestore=t}convertBytes(t){return new Yc(t)}convertReference(t){const e=this.convertDocumentKey(t,this.firestore._databaseId);return new Tc(this.firestore,null,e)}}function ch(t){t=mc(t,Tc);const e=mc(t.firestore,xc),n=Oc(e),r=new ah(e);return tc(n,t._key).then(n=>new Du(e,r,t._key,n,new Su(null!==n&&n.hasLocalMutations,!0),t.converter))}function uh(t){t=mc(t,Tc);const e=mc(t.firestore,xc);return ec(Oc(e),t._key,{source:"server"}).then(n=>Eh(e,t,n))}function hh(t){t=mc(t,Ic);const e=mc(t.firestore,xc),n=Oc(e),r=new ah(e);return $u(t._query),sc(n,t._query).then(n=>new Nu(e,r,t,n))}function lh(t){t=mc(t,Ic);const e=mc(t.firestore,xc),n=Oc(e),r=new ah(e);return nc(n,t._query).then(n=>new Nu(e,r,t,n))}function fh(t){t=mc(t,Ic);const e=mc(t.firestore,xc),n=Oc(e),r=new ah(e);return sc(n,t._query,{source:"server"}).then(n=>new Nu(e,r,t,n))}function dh(t,e,n){t=mc(t,Tc);const r=mc(t.firestore,xc),s=nh(t.converter,e,n);return ph(r,[au(ou(r),"setDoc",t._key,s,null!==t.converter,n).toMutation(t._key,We.none())])}function wh(t,e,n,...r){t=mc(t,Tc);const s=mc(t.firestore,xc),i=ou(s);let o;return ph(s,[(o="string"==typeof(e=getModularInstance(e))||e instanceof Hc?_u(i,"updateDoc",t._key,e,n,r):wu(i,"updateDoc",t._key,e)).toMutation(t._key,We.exists(!0))])}function _h(t){return ph(mc(t.firestore,xc),[new on(t._key,We.none())])}function mh(t,e){const n=mc(t.firestore,xc),r=bc(t),s=nh(t.converter,e);return ph(n,[au(ou(t.firestore),"addDoc",r._key,s,null!==t.converter,{}).toMutation(r._key,We.exists(!1))]).then(()=>r)}function gh(t,...e){var n,r,s;t=getModularInstance(t);let i={includeMetadataChanges:!1},o=0;"object"!=typeof e[o]||Dc(e[o])||(i=e[o],o++);const a={includeMetadataChanges:i.includeMetadataChanges};if(Dc(e[o])){const t=e[o];e[o]=null===(n=t.next)||void 0===n?void 0:n.bind(t),e[o+1]=null===(r=t.error)||void 0===r?void 0:r.bind(t),e[o+2]=null===(s=t.complete)||void 0===s?void 0:s.bind(t)}let c,u,h;if(t instanceof Tc)u=mc(t.firestore,xc),h=de(t._key.path),c={next:n=>{e[o]&&e[o](Eh(u,t,n))},error:e[o+1],complete:e[o+2]};else{const n=mc(t,Ic);u=mc(n.firestore,xc),h=n._query;const r=new ah(u);c={next:t=>{e[o]&&e[o](new Nu(u,r,n,t))},error:e[o+1],complete:e[o+2]},$u(t._query)}return function(t,e,n,r){const s=new Ma(c),i=new jo(e,s,n);return t.asyncQueue.enqueueAndForget(async()=>Lo(await Ya(t),i)),()=>{s.Xo(),t.asyncQueue.enqueueAndForget(async()=>Bo(await Ya(t),i))}}(Oc(u),h,a)}function yh(t,e){return ic(Oc(t=mc(t,xc)),Dc(e)?e:{next:e})}function ph(t,e){return function(t,e){const n=new j;return t.asyncQueue.enqueueAndForget(async()=>ia(await Ja(t),e,n)),n.promise}(Oc(t),e)}function Eh(t,e,n){const r=n.docs.get(e._key),s=new ah(t);return new Du(t,s,e._key,r,new Su(n.hasPendingWrites,n.fromCache),e.converter)}class Th extends class{constructor(t,e){this._firestore=t,this._transaction=e,this._dataReader=ou(t)}get(t){const e=rh(t,this._firestore),n=new sh(this._firestore);return this._transaction.lookup([e._key]).then(t=>{if(!t||1!==t.length)return M();const r=t[0];if(r.isFoundDocument())return new bu(this._firestore,n,r.key,r,e.converter);if(r.isNoDocument())return new bu(this._firestore,n,e._key,null,e.converter);throw M()})}set(t,e,n){const r=rh(t,this._firestore),s=nh(r.converter,e,n),i=au(this._dataReader,"Transaction.set",r._key,s,null!==r.converter,n);return this._transaction.set(r._key,i),this}update(t,e,n,...r){const s=rh(t,this._firestore);let i;return i="string"==typeof(e=getModularInstance(e))||e instanceof Hc?_u(this._dataReader,"Transaction.update",s._key,e,n,r):wu(this._dataReader,"Transaction.update",s._key,e),this._transaction.update(s._key,i),this}delete(t){const e=rh(t,this._firestore);return this._transaction.delete(e._key),this}}{constructor(t,e){super(t,e),this._firestore=t}get(t){const e=rh(t,this._firestore),n=new ah(this._firestore);return super.get(t).then(t=>new Du(this._firestore,n,e._key,t._document,new Su(!1,!1),e.converter))}}function Ih(t,e){return rc(Oc(t),n=>e(new Th(t,n)))}function Ah(){return new cu("deleteField")}function Rh(){return new hu("serverTimestamp")}function Ph(...t){return new lu("arrayUnion",t)}function bh(...t){return new fu("arrayRemove",t)}function vh(t){return new du("increment",t)}function Vh(t){return Oc(t=mc(t,xc)),new ih(t,e=>ph(t,e))}var Sh;D=SDK_VERSION,_registerComponent(new Component("firestore",(t,{options:e})=>{const n=t.getProvider("app").getImmediate(),r=new xc(n,new z(t.getProvider("auth-internal")));return e=Object.assign({useFetchStreams:!0},e),r._setSettings(e),r},"PUBLIC")),registerVersion("@firebase/firestore","3.0.0",Sh);export{eh as AbstractUserDataWriter,Yc as Bytes,Nc as CACHE_SIZE_UNLIMITED,Ac as CollectionReference,Tc as DocumentReference,Du as DocumentSnapshot,Hc as FieldPath,Xc as FieldValue,xc as Firestore,K as FirestoreError,Zc as GeoPoint,Cc as LoadBundleTask,Ic as Query,Ou as QueryConstraint,Cu as QueryDocumentSnapshot,Nu as QuerySnapshot,Su as SnapshotMetadata,st as Timestamp,Th as Transaction,ih as WriteBatch,uc as _DatabaseId,Pt as _DocumentKey,lt as _FieldPath,mc as _cast,B as _debugAssert,dt as _isBase64Available,O as _logWarn,fc as _validateIsNotUsedTogether,mh as addDoc,bh as arrayRemove,Ph as arrayUnion,Uc as clearIndexedDbPersistence,Rc as collection,Pc as collectionGroup,Ec as connectFirestoreEmulator,_h as deleteDoc,Ah as deleteField,jc as disableNetwork,bc as doc,Jc as documentId,Mc as enableIndexedDbPersistence,Lc as enableMultiTabIndexedDbPersistence,Kc as enableNetwork,Ju as endAt,Hu as endBefore,Oc as ensureFirestoreConfigured,ph as executeWrite,oh as getDoc,ch as getDocFromCache,uh as getDocFromServer,hh as getDocs,lh as getDocsFromCache,fh as getDocsFromServer,$c as getFirestore,vh as increment,kc as initializeFirestore,Ku as limit,ju as limitToLast,Wc as loadBundle,Gc as namedQuery,gh as onSnapshot,yh as onSnapshotsInSync,Uu as orderBy,Fu as query,Vc as queryEqual,vc as refEqual,Ih as runTransaction,Rh as serverTimestamp,dh as setDoc,x as setLogLevel,ku as snapshotEqual,Gu as startAfter,Wu as startAt,Qc as terminate,wh as updateDoc,qc as waitForPendingWrites,Lu as where,Vh as writeBatch};